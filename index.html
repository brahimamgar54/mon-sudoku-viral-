<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SUDOKU MALPHAS - L'Enfer des Chiffres</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&display=swap');

        :root {
            --bg-color: #050505;
            --text-color: #dcdcdc;
            --accent-color: #8b0000; /* Rouge sang */
            --highlight: #2a2a2a;
            --malphas-eye: #ffd700; /* Jaune maladif */
            --grid-line: #444;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'VT323', monospace;
            margin: 0;
            padding: 0;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            user-select: none;
        }

        /* --- UI & LAYOUT --- */
        #game-container {
            width: 100%;
            max-width: 500px;
            height: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
            background: radial-gradient(circle at center, #111 0%, #000 100%);
        }

        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 1s;
            z-index: 10;
            padding: 20px;
            box-sizing: border-box;
        }

        .hidden {
            opacity: 0;
            pointer-events: none;
            z-index: -1;
        }

        /* --- MALPHAS AVATAR --- */
        #malphas-visage {
            width: 100px;
            height: 100px;
            background: #000;
            border: 2px solid #333;
            margin-bottom: 20px;
            position: relative;
            image-rendering: pixelated;
            animation: glitch 3s infinite;
        }

        .eye {
            position: absolute;
            width: 10px;
            height: 10px;
            background: var(--malphas-eye);
            top: 40%;
            box-shadow: 0 0 5px var(--malphas-eye);
        }
        .eye.left { left: 30%; }
        .eye.right { right: 30%; }

        #dialogue-box {
            font-size: 1.4rem;
            text-align: center;
            min-height: 80px;
            margin-bottom: 20px;
            color: #fff;
            text-shadow: 0 0 5px var(--accent-color);
            padding: 10px;
            border-top: 1px solid #333;
            border-bottom: 1px solid #333;
            width: 90%;
        }

        /* --- INPUT SCREEN --- */
        input[type="text"] {
            background: #000;
            border: 1px solid var(--accent-color);
            color: var(--text-color);
            font-family: 'Press Start 2P', cursive;
            padding: 15px;
            text-align: center;
            margin-bottom: 20px;
            width: 80%;
            text-transform: uppercase;
        }
        
        button {
            background: var(--highlight);
            border: 1px solid var(--text-color);
            color: var(--text-color);
            font-family: 'Press Start 2P', cursive;
            padding: 15px 30px;
            cursor: pointer;
            transition: 0.3s;
        }
        button:hover {
            background: var(--accent-color);
            color: #000;
        }

        /* --- SUDOKU GRID --- */
        #timer-bar {
            width: 100%;
            height: 5px;
            background: #333;
            margin-bottom: 10px;
        }
        #life-blood {
            width: 100%;
            height: 100%;
            background: var(--accent-color);
            transition: width 0.2s linear;
            box-shadow: 0 0 10px var(--accent-color);
        }

        #sudoku-grid {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            gap: 1px;
            background: var(--grid-line);
            border: 2px solid var(--grid-line);
            width: 95%;
            aspect-ratio: 1;
            margin: 0 auto;
        }

        .cell {
            background: var(--bg-color);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            cursor: pointer;
            position: relative;
        }

        /* Lignes épaisses pour les blocs 3x3 */
        .cell:nth-child(3n) { border-right: 2px solid #666; }
        .cell:nth-child(9n) { border-right: none; }
        .cell:nth-child(n+19):nth-child(-n+27),
        .cell:nth-child(n+46):nth-child(-n+54) { border-bottom: 2px solid #666; }

        .cell.selected { background: #1a1a1a; }
        .cell.fixed { color: #555; pointer-events: none; }
        .cell.error { 
            color: var(--accent-color); 
            animation: shake 0.5s;
        }

        /* --- CONTROLS --- */
        #numpad {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            width: 95%;
            margin: 20px auto;
        }
        .num-btn {
            background: #111;
            border: 1px solid #444;
            color: #fff;
            padding: 15px 0;
            font-size: 1.5rem;
            font-family: 'VT323';
        }

        /* --- ANIMATIONS --- */
        @keyframes glitch {
            0% { transform: translate(0); }
            20% { transform: translate(-2px, 2px); }
            40% { transform: translate(-2px, -2px); }
            60% { transform: translate(2px, 2px); }
            80% { transform: translate(2px, -2px); }
            100% { transform: translate(0); }
        }

        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }

        .blood-effect {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, transparent 50%, rgba(139, 0, 0, 0.5));
            pointer-events: none;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 0.2; }
            50% { opacity: 0.6; }
            100% { opacity: 0.2; }
        }

        .error-msg {
            color: var(--accent-color);
            font-size: 0.8rem;
            margin-top: 10px;
            display: none;
        }

    </style>
</head>
<body>

<div id="game-container">
    
    <div id="screen-intro" class="screen">
        <h1 style="font-family: 'Press Start 2P'; color: var(--accent-color); margin-bottom: 40px; text-align: center;">SUDOKU<br>MALPHAS</h1>
        <p style="margin-bottom: 20px;">IDENTIFIE-TOI, MORTEL.</p>
        <input type="text" id="player-name" placeholder="TON NOM..." maxlength="12">
        <div id="bad-word-msg" class="error-msg">CE NOM PUE L'INSOLENCE. RÉESSAYE.</div>
        <button onclick="startGame()">ENTRER DANS L'ARÈNE</button>
    </div>

    <div id="screen-game" class="screen hidden">
        <div id="malphas-area">
            <div id="malphas-visage">
                <div class="eye left"></div>
                <div class="eye right"></div>
            </div>
        </div>
        
        <div id="dialogue-box">...</div>

        <div id="timer-bar"><div id="life-blood"></div></div>

        <div id="sudoku-grid">
            </div>

        <div id="numpad">
            <button class="num-btn" onclick="inputNumber(1)">1</button>
            <button class="num-btn" onclick="inputNumber(2)">2</button>
            <button class="num-btn" onclick="inputNumber(3)">3</button>
            <button class="num-btn" onclick="inputNumber(4)">4</button>
            <button class="num-btn" onclick="inputNumber(5)">5</button>
            <button class="num-btn" onclick="inputNumber(6)">6</button>
            <button class="num-btn" onclick="inputNumber(7)">7</button>
            <button class="num-btn" onclick="inputNumber(8)">8</button>
            <button class="num-btn" onclick="inputNumber(9)">9</button>
            <button class="num-btn" onclick="inputNumber('X')">X</button>
        </div>
    </div>

    <div id="screen-over" class="screen hidden">
        <h1 style="color: var(--accent-color); font-size: 3rem;">MORT</h1>
        <p id="death-reason" style="text-align: center; max-width: 80%;">...</p>
        <br>
        <button onclick="location.reload()">SOUFFRIR ENCORE</button>
    </div>

</div>

<script>
    /* --- CONFIGURATION --- */
    const BAD_WORDS = ['MERDE', 'PUTAIN', 'CON', 'SALOPE', 'ENKULE', 'BIT', 'CHATTE', 'CONNARD', 'FDP', 'NTM', 'DICK', 'FUCK', 'SHIT'];
    const MAX_TIME = 300; // 5 minutes en secondes
    let playerName = "";
    let timeLeft = MAX_TIME;
    let timerInterval;
    let malphasInterval;
    let selectedCell = null;
    let gridSolution = [];
    let currentGrid = [];
    let mistakes = 0;

    /* --- DIALOGUE SYSTEM --- */
    // Malphas Dialogue Database
    const DIALOGUES_INTRO = [
        "Ah... une nouvelle âme.",
        "Bienvenue dans mon hospice, [NAME].",
        "Tu penses pouvoir battre mes chiffres ?",
        "Commençons doucement...",
        "Le tic-tac que tu entends... c'est ta vie."
    ];

    const DIALOGUES_IDLE = [
        "Tu hésites, [NAME] ? C'est délicieux.",
        "Le temps s'écoule. Ton sang aussi.",
        "[NAME], tu te crois malin ?",
        "Je vois tes mains trembler.",
        "Ce chiffre... tu es sûr de toi ?",
        "Personne ne sort d'ici. Sauf moi.",
        "Concentre-toi, [NAME].",
        "J'ai faim d'erreurs.",
        "Pourquoi te bats-tu encore ?",
        "C'est inutile, [NAME]."
    ];

    const DIALOGUES_ERROR = [
        "PATHÉTIQUE !",
        "Ça, c'est une erreur qui coûte cher.",
        "Je prends un peu de ton temps, [NAME].",
        "Tu saignes... numériquement.",
        "Encore une bêtise ?"
    ];

    let dialogueQueue = [];
    let isTyping = false;

    /* --- GAME LOGIC --- */

    function startGame() {
        const input = document.getElementById('player-name');
        const nameRaw = input.value.trim().toUpperCase();

        if (nameRaw.length < 2) return; // Nom trop court

        // Filtre d'insultes
        for (let word of BAD_WORDS) {
            if (nameRaw.includes(word)) {
                document.getElementById('bad-word-msg').style.display = 'block';
                input.value = "";
                input.classList.add('error');
                setTimeout(() => input.classList.remove('error'), 500);
                return;
            }
        }

        playerName = nameRaw;
        
        // Transition UI
        document.getElementById('screen-intro').classList.add('hidden');
        document.getElementById('screen-game').classList.remove('hidden');

        // Initialiser le jeu
        initSudoku();
        startTimer();
        startMalphasAI();
    }

    /* --- MALPHAS AI --- */
    function startMalphasAI() {
        // Initial intro sequence
        DIALOGUES_INTRO.forEach(line => queueDialogue(line));

        // Boucle infinie de dialogue (5s pause between sentences)
        // La fonction checkQueue gère l'affichage. On ajoute juste du contenu.
        
        setInterval(() => {
            if (dialogueQueue.length < 2) {
                const rand = Math.random();
                let line = "";
                if (rand < 0.1) {
                    // Rare creepy silence or weird noise text
                    line = "...";
                } else {
                    line = DIALOGUES_IDLE[Math.floor(Math.random() * DIALOGUES_IDLE.length)];
                }
                queueDialogue(line);
            }
        }, 8000); // Check to add thought every 8s roughly
    }

    function queueDialogue(text) {
        dialogueQueue.push(text);
        if (!isTyping) {
            processQueue();
        }
    }

    function processQueue() {
        if (dialogueQueue.length === 0) {
            isTyping = false;
            return;
        }

        isTyping = true;
        let text = dialogueQueue.shift();
        
        // Personnalisation : 50% de chance d'insérer le nom si le placeholder n'est pas déjà là
        // Note: Mes dialogues ont déjà [NAME] dedans, on remplace simplement.
        // Si le dialogue n'a pas [NAME], on peut l'ajouter parfois.
        
        if (text.includes("[NAME]")) {
            // Le texte a le placeholder, on le remplace toujours
             text = text.replace("[NAME]", playerName);
        } else {
            // Le texte n'a pas de placeholder, 50% de chance de l'ajouter au début ou fin
            if (Math.random() > 0.5 && text.length > 5) {
                text = `${playerName}... ${text}`;
            }
        }

        const box = document.getElementById('dialogue-box');
        box.innerHTML = "";
        
        let i = 0;
        const speed = 40; // Vitesse de frappe

        function typeWriter() {
            if (i < text.length) {
                box.innerHTML += text.charAt(i);
                i++;
                setTimeout(typeWriter, speed);
            } else {
                // Phrase finie. Pause de 5 secondes avant la suivante.
                setTimeout(() => {
                    processQueue();
                }, 5000); // 5 SECONDES DE PAUSE STRICTES
            }
        }
        typeWriter();
    }

    /* --- SUDOKU ENGINE --- */
    function initSudoku() {
        // Pour ce prototype, on utilise une grille valide pré-générée et on mélange
        // Base solution
        const base = [
            5,3,4,6,7,8,9,1,2,
            6,7,2,1,9,5,3,4,8,
            1,9,8,3,4,2,5,6,7,
            8,5,9,7,6,1,4,2,3,
            4,2,6,8,5,3,7,9,1,
            7,1,3,9,2,4,8,5,6,
            9,6,1,5,3,7,2,8,4,
            2,8,7,4,1,9,6,3,5,
            3,4,5,2,8,6,1,7,9
        ];
        
        gridSolution = [...base]; 
        // Note: Dans une version complète, on implémenterait un algo de mélange de lignes/colonnes ici
        
        // Créer le puzzle (enlever des chiffres)
        currentGrid = new Array(81).fill(null);
        
        // Niveau facile pour le test : remplir 40 cases
        for(let i=0; i<81; i++) {
            if(Math.random() > 0.5) {
                currentGrid[i] = gridSolution[i];
            }
        }

        renderGrid();
    }

    function renderGrid() {
        const gridEl = document.getElementById('sudoku-grid');
        gridEl.innerHTML = '';

        for (let i = 0; i < 81; i++) {
            const cell = document.createElement('div');
            cell.classList.add('cell');
            cell.dataset.index = i;
            
            if (currentGrid[i] !== null) {
                cell.textContent = currentGrid[i];
                cell.classList.add('fixed');
            } else {
                cell.onclick = () => selectCell(i);
            }
            gridEl.appendChild(cell);
        }
    }

    function selectCell(index) {
        if (document.querySelector('.selected')) {
            document.querySelector('.selected').classList.remove('selected');
        }
        selectedCell = index;
        const cells = document.querySelectorAll('.cell');
        cells[index].classList.add('selected');
    }

    function inputNumber(num) {
        if (selectedCell === null) return;
        
        const cells = document.querySelectorAll('.cell');
        const cell = cells[selectedCell];

        // Effacer
        if (num === 'X') {
            cell.textContent = '';
            cell.classList.remove('error');
            return;
        }

        // Vérifier
        const correctVal = gridSolution[selectedCell];
        
        if (num === correctVal) {
            // Correct
            cell.textContent = num;
            cell.style.color = "#4CAF50"; // Vert sombre
            // Check win
            checkWin();
        } else {
            // Erreur
            cell.textContent = num;
            cell.classList.add('error');
            handleMistake();
        }
    }

    function handleMistake() {
        mistakes++;
        
        // Vibration
        document.body.style.animation = "shake 0.2s";
        setTimeout(() => document.body.style.animation = "", 200);

        // Dialogue Malphas prioritaire
        const nastyLine = DIALOGUES_ERROR[Math.floor(Math.random() * DIALOGUES_ERROR.length)];
        // On force ce dialogue en tête de file ou on clear la file
        dialogueQueue = [nastyLine]; 
        isTyping = false; // Reset typing pour forcer le nouveau msg
        processQueue();

        // Pénalité de temps (-10s)
        timeLeft -= 10;
        updateTimerBar();

        if (timeLeft <= 0) gameOver("TEMPS ÉCOULÉ");
    }

    function checkWin() {
        const cells = document.querySelectorAll('.cell');
        let filled = 0;
        cells.forEach(c => {
            if (c.textContent !== '') filled++;
        });
        
        if (filled === 81) {
            alert("TU AS SURVÉCU... POUR L'INSTANT.");
            location.reload();
        }
    }

    /* --- TIMER SYSTEM --- */
    function startTimer() {
        updateTimerBar();
        timerInterval = setInterval(() => {
            timeLeft--;
            updateTimerBar();
            
            // Glitch visual effects based on time
            if (timeLeft < 60) {
                document.getElementById('game-container').classList.add('blood-effect');
            }
            
            if (timeLeft <= 0) {
                gameOver("TON CŒUR A CESSÉ DE BATTRE");
            }
        }, 1000);
    }

    function updateTimerBar() {
        const pct = (timeLeft / MAX_TIME) * 100;
        const bar = document.getElementById('life-blood');
        bar.style.width = `${pct}%`;
        
        if (pct < 30) {
            bar.style.backgroundColor = "#ff0000";
            bar.style.boxShadow = "0 0 15px #ff0000";
        }
    }

    function gameOver(reason) {
        clearInterval(timerInterval);
        document.getElementById('screen-game').classList.add('hidden');
        document.getElementById('screen-over').classList.remove('hidden');
        document.getElementById('death-reason').textContent = reason;
        
        // Un dernier mot de Malphas
        const finalWords = `ADIEU, ${playerName}.`;
        const synth = window.speechSynthesis; // Si disponible, juste pour le fun (optionnel)
    }

</script>
</body>
</html>
