<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SUDOKU: PURGATORIO</title>
    <style>
        :root { 
            --bg: #050505; 
            --blood: #8a0b0b; 
            --text: #a0a0a0; 
            --highlight: #ff0000;
        }
        
        @font-face { font-family: 'MonoHorror'; src: local('Courier New'); } /* Fallback simple */

        body { 
            background-color: var(--bg); 
            color: var(--text); 
            font-family: 'Courier New', monospace; 
            margin: 0; 
            overflow: hidden; 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
            user-select: none;
        }

        /* --- UI LAYERS --- */
        #layer-intro, #layer-game, #layer-end { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 1s; }
        #layer-game, #layer-end { opacity: 0; pointer-events: none; }
        .active-layer { opacity: 1 !important; pointer-events: auto !important; z-index: 10; }

        /* --- INTRO & CINEMATIC --- */
        #eye-lids {
            position: fixed; inset: 0; background: black; z-index: 100; pointer-events: none;
            animation: blink 4s infinite alternate; display: none;
        }
        @keyframes blink { 
            0% { transform: scaleY(1); } 
            5% { transform: scaleY(0.1); } 
            10% { transform: scaleY(1); }
            100% { transform: scaleY(0); } /* Open */
        }
        
        .demon-text { font-size: 1.2rem; max-width: 80%; text-align: center; color: var(--blood); min-height: 60px; text-shadow: 0 0 5px var(--blood); }
        .btn-start { background: transparent; border: 1px solid var(--text); color: var(--text); padding: 15px 30px; font-family: inherit; font-size: 1.2rem; cursor: pointer; margin-top: 20px; transition: 0.3s; letter-spacing: 2px; }
        .btn-start:hover { background: var(--blood); color: black; border-color: var(--blood); }

        /* --- GAME UI --- */
        #hud { width: 95%; max-width: 400px; display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 5px; font-size: 0.9rem; color: #666; }
        #threat-bar-container { width: 95%; max-width: 400px; height: 4px; background: #222; margin-bottom: 15px; position: relative; overflow: hidden; }
        #threat-bar { height: 100%; background: var(--blood); width: 0%; box-shadow: 0 0 10px var(--highlight); transition: width 0.2s linear; }

        #grid { 
            display: grid; 
            grid-template-columns: repeat(9, 1fr); 
            width: 95vw; height: 95vw; 
            max-width: 400px; max-height: 400px; 
            background: #111; border: 2px solid #333; 
            gap: 1px;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
        }
        
        .cell { 
            background: #080808; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 1.4rem; color: #ddd; 
            position: relative;
        }
        /* Bordures épaisses pour les blocs 3x3 */
        .cell:nth-child(3n) { border-right: 1px solid #444; }
        .cell:nth-child(9n) { border-right: none; }
        .cell:nth-child(n+19):nth-child(-n+27), 
        .cell:nth-child(n+46):nth-child(-n+54) { border-bottom: 1px solid #444; }

        .cell.fixed { color: #444; font-weight: bold; pointer-events: none; }
        .cell.selected { background: #1a0505; color: var(--highlight); outline: 1px solid var(--blood); z-index: 2; }
        .cell.error { animation: shake 0.3s; color: var(--highlight); text-shadow: 0 0 5px red; }
        
        @keyframes shake { 0%, 100% {transform:translateX(0)} 25% {transform:translateX(-4px)} 75% {transform:translateX(4px)} }

        #keyboard { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; width: 95%; max-width: 400px; margin-top: 15px; }
        .key { background: #111; border: 1px solid #333; color: #888; padding: 15px 0; text-align: center; font-size: 1.3rem; border-radius: 2px; cursor: pointer; transition: 0.1s; }
        .key:active { background: var(--blood); color: #fff; transform: scale(0.95); }

        #feedback-overlay { position: fixed; inset: 0; background: radial-gradient(circle, transparent, var(--blood)); opacity: 0; pointer-events: none; transition: opacity 0.2s; z-index: 5; }
    </style>
</head>
<body>

<div id="eye-lids"></div>
<div id="feedback-overlay"></div>

<div id="layer-intro" class="active-layer">
    <h1 style="letter-spacing: 5px; color: #333; margin-bottom: 50px;">SUDOKU<span style="color:var(--blood)">.EXE</span></h1>
    <button class="btn-start" onclick="startGameSequence()">SE RÉVEILLER</button>
</div>

<div id="layer-game">
    <div class="demon-text" id="demon-speech">...</div>
    
    <div id="hud">
        <span id="level-disp">NIVEAU 1/100</span>
        <span id="status-disp">SURVIS</span>
    </div>
    
    <div id="threat-bar-container"><div id="threat-bar"></div></div>
    
    <div id="grid"></div>
    
    <div id="keyboard">
        </div>
</div>

<script>
    // --- MOTEUR AUDIO AVANCÉ ---
    const AudioEngine = {
        ctx: null,
        masterGain: null,
        droneOsc: null,
        
        init: function() {
            this.ctx = new (window.AudioContext || window.webkitAudioContext)();
            this.masterGain = this.ctx.createGain();
            this.masterGain.connect(this.ctx.destination);
            this.masterGain.gain.value = 0.8;
        },

        playTone: function(freq, type, dur, vol = 0.1) {
            if(!this.ctx) return;
            const osc = this.ctx.createOscillator();
            const g = this.ctx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
            g.gain.setValueAtTime(vol, this.ctx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + dur);
            osc.connect(g);
            g.connect(this.masterGain);
            osc.start();
            osc.stop(this.ctx.currentTime + dur);
        },

        startDrone: function() {
            // Ambiance oppressante (Basse fréquence + modulation)
            this.droneOsc = this.ctx.createOscillator();
            const lfo = this.ctx.createOscillator();
            const lfoGain = this.ctx.createGain();
            
            this.droneOsc.type = 'sawtooth';
            this.droneOsc.frequency.value = 40; // Basse très grave

            lfo.type = 'sine';
            lfo.frequency.value = 0.2; // Pulsation lente
            lfoGain.gain.value = 10;

            lfo.connect(lfoGain);
            lfoGain.connect(this.droneOsc.frequency); // Moduler la fréquence

            const filter = this.ctx.createBiquadFilter();
            filter.type = 'lowpass';
            filter.frequency.value = 200; // Son étouffé

            const droneVol = this.ctx.createGain();
            droneVol.gain.value = 0.15;

            this.droneOsc.connect(filter);
            filter.connect(droneVol);
            droneVol.connect(this.masterGain);
            
            this.droneOsc.start();
            lfo.start();
        },

        heartbeat: function(bpm) {
            // Simule un battement de coeur
            let interval = 60000 / bpm;
            this.playTone(60, 'sine', 0.1, 0.6); // Boum
            setTimeout(() => this.playTone(45, 'triangle', 0.15, 0.4), 150); // ...Bam
        },

        click: function() { this.playTone(800, 'sine', 0.05, 0.1); },
        select: function() { this.playTone(200, 'triangle', 0.05, 0.1); },
        error: function() { 
            this.playTone(100, 'sawtooth', 0.3, 0.4); 
            this.playTone(120, 'square', 0.3, 0.2); // Dissonance
        },
        win: function() {
            this.playTone(440, 'sine', 0.5, 0.1);
            setTimeout(() => this.playTone(554, 'sine', 0.5, 0.1), 100);
            setTimeout(() => this.playTone(659, 'sine', 1, 0.1), 200);
        }
    };

    // --- GAME DATA ---
    const STATE = {
        level: 1,
        threat: 0,
        isActive: false,
        selectedCell: null,
        solution: [],
        baseGrid: [],
        heartbeatTimer: null,
        lastHeartbeat: 0
    };

    // Grille de base valide (pour le shuffle)
    const SEED_GRID = [
        1,2,3,4,5,6,7,8,9,
        4,5,6,7,8,9,1,2,3,
        7,8,9,1,2,3,4,5,6,
        2,3,1,5,6,4,8,9,7,
        5,6,4,8,9,7,2,3,1,
        8,9,7,2,3,1,5,6,4,
        3,1,2,6,4,5,9,7,8,
        6,4,5,9,7,8,3,1,2,
        9,7,8,3,1,2,6,4,5
    ];

    // --- LOGIC: SUDOKU GENERATOR ---
    function generateLevel() {
        // 1. Cloner la seed
        let grid = [...SEED_GRID];

        // 2. Mélanger (Shuffle Rows within bands)
        // Band 0 (row 0-2), Band 1 (row 3-5)...
        grid = shuffleRows(grid);
        // 3. Transposer (Lignes <-> Colonnes) pour plus de variété
        if(Math.random() > 0.5) grid = transpose(grid);
        // 4. Mélanger encore les colonnes (qui sont mnt des lignes ou inversement)
        grid = shuffleRows(grid);

        STATE.solution = [...grid];

        // 5. Creuser des trous (Difficulté progressive)
        // Niv 1: 30 trous. Niv 100: 60 trous.
        let holes = Math.min(60, 20 + Math.floor(STATE.level / 2.5));
        
        STATE.baseGrid = [...grid];
        let attempts = holes;
        while(attempts > 0) {
            let idx = Math.floor(Math.random() * 81);
            if(STATE.baseGrid[idx] !== 0) {
                STATE.baseGrid[idx] = 0;
                attempts--;
            }
        }
        renderGrid();
    }

    function shuffleRows(grid) {
        // Fonction utilitaire pour mélanger les lignes par blocs de 3
        const getRow = (g, r) => g.slice(r*9, r*9+9);
        const setRow = (g, r, data) => { for(let i=0; i<9; i++) g[r*9+i] = data[i]; };
        
        // Pour chaque bande (0, 1, 2)
        for(let b=0; b<3; b++) {
            let rows = [b*3, b*3+1, b*3+2];
            // Mélange simple des indices
            for(let i = rows.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [rows[i], rows[j]] = [rows[j], rows[i]];
            }
            // Réappliquer
            let r1 = getRow(grid, b*3);     let saved1 = [...r1];
            let r2 = getRow(grid, b*3+1);   let saved2 = [...r2];
            let r3 = getRow(grid, b*3+2);   let saved3 = [...r3];
            
            // C'est un peu brute-force mais ça marche pour un script unique
            let data = [saved1, saved2, saved3]; // Mais on veut les indices mélangés
            // On reconstruit une nouvelle grille temp
            let bandData = [];
            bandData.push(getRow(grid, rows[0]));
            bandData.push(getRow(grid, rows[1]));
            bandData.push(getRow(grid, rows[2]));
            
            setRow(grid, b*3, bandData[0]);
            setRow(grid, b*3+1, bandData[1]);
            setRow(grid, b*3+2, bandData[2]);
        }
        return grid;
    }

    function transpose(grid) {
        let newGrid = new Array(81).fill(0);
        for(let r=0; r<9; r++){
            for(let c=0; c<9; c++){
                newGrid[c*9 + r] = grid[r*9 + c];
            }
        }
        return newGrid;
    }

    function renderGrid() {
        const board = document.getElementById('grid');
        board.innerHTML = '';
        STATE.baseGrid.forEach((val, idx) => {
            let div = document.createElement('div');
            div.className = 'cell';
            div.dataset.index = idx;
            if(val !== 0) {
                div.textContent = val;
                div.classList.add('fixed');
            } else {
                div.onclick = () => selectCell(div);
            }
            board.appendChild(div);
        });
        document.getElementById('level-disp').textContent = `NIVEAU ${STATE.level}/100`;
    }

    // --- GAMEPLAY INTERACTIONS ---
    function selectCell(el) {
        if(STATE.selectedCell) STATE.selectedCell.classList.remove('selected');
        STATE.selectedCell = el;
        el.classList.add('selected');
        AudioEngine.select();
    }

    function inputNumber(n) {
        if(!STATE.isActive || !STATE.selectedCell) return;
        
        let idx = parseInt(STATE.selectedCell.dataset.index);
        let correctVal = STATE.solution[idx];

        if(n === correctVal) {
            // Correct
            STATE.selectedCell.textContent = n;
            STATE.selectedCell.style.color = '#0f0';
            STATE.selectedCell.classList.remove('selected');
            STATE.selectedCell = null;
            
            // Réduire la menace
            STATE.threat = Math.max(0, STATE.threat - 5);
            AudioEngine.click();
            checkWin();
        } else {
            // Erreur
            STATE.threat += 15; // Punition lourde
            STATE.selectedCell.classList.add('error');
            setTimeout(() => STATE.selectedCell.classList.remove('error'), 400);
            AudioEngine.error();
            
            // Flash écran rouge
            let overlay = document.getElementById('feedback-overlay');
            overlay.style.opacity = 0.5;
            setTimeout(() => overlay.style.opacity = 0, 200);

            demonReact('error');
        }
    }

    function checkWin() {
        let cells = document.querySelectorAll('.cell');
        let filled = true;
        cells.forEach(c => { if(c.textContent == '') filled = false; });
        
        if(filled) {
            AudioEngine.win();
            STATE.level++;
            STATE.threat = 0;
            if(STATE.level > 100) {
                // VICTOIRE FINALE
                STATE.isActive = false;
                speak("Impossible... Tu es... libre.", true);
                setTimeout(() => location.reload(), 5000);
            } else {
                demonReact('win');
                setTimeout(generateLevel, 1000);
            }
        }
    }

    // --- DEMON AI & VOICE ---
    function speak(text, force = false) {
        if(window.speechSynthesis.speaking && !force) return;

        const el = document.getElementById('demon-speech');
        el.textContent = "";
        
        // Effet Machine à écrire
        let i = 0;
        let typeInterval = setInterval(() => {
            el.textContent += text.charAt(i);
            i++;
            if(i >= text.length) clearInterval(typeInterval);
        }, 50);

        // Synthèse Vocale Hackée pour sonner "Grave"
        let utt = new SpeechSynthesisUtterance(text);
        utt.pitch = 0.1; // Le plus bas possible
        utt.rate = 0.9;  // Lent
        utt.volume = 1;
        
        // Essayer de trouver une voix masculine/profonde selon le navigateur
        let voices = window.speechSynthesis.getVoices();
        let deepVoice = voices.find(v => v.name.includes('Google Français') || v.name.includes('Thomas')); 
        if(deepVoice) utt.voice = deepVoice;
        
        window.speechSynthesis.speak(utt);
    }

    const DIALOGUES = {
        intro: "Réveille-toi, mortel. Tu es dans ma demeure. 100 niveaux. C'est le prix de ta liberté... ou de ton âme.",
        error: ["Tu me déçois.", "Erreur pathétique.", "Je sens ta peur.", "Concentre-toi ou meurs.", "Encore une faute ?", "Délicieux échec."],
        win: ["Pas mal...", "Le prochain sera pire.", "Ne te réjouis pas.", "Encore 90 comme ça..."],
        panic: ["Ton coeur bat si vite.", "C'est la fin ?", "Donne-moi ton âme !", "Tic... Tac..."],
        idle: ["Je t'attends...", "Pourquoi hésiter ?", "Joue.", "Le temps s'écoule."]
    };

    function demonReact(type) {
        let opts = DIALOGUES[type];
        if(Array.isArray(opts)) speak(opts[Math.floor(Math.random() * opts.length)]);
        else speak(opts);
    }

    // --- CORE LOOP ---
    function update(time) {
        if(!STATE.isActive) return;

        // Augmentation de la menace
        // Base : 0.05. Niv 10 : 0.1. Niv 50 : 0.3.
        let decay = 0.04 + (STATE.level * 0.003); 
        STATE.threat += decay;

        // UI Update
        let bar = document.getElementById('threat-bar');
        bar.style.width = STATE.threat + "%";
        
        // Ambiance visuelle dynamique
        if(STATE.threat > 70) {
            bar.style.backgroundColor = (time % 200 < 100) ? "#fff" : "var(--blood)"; // Stroboscope
            document.body.style.transform = `translate(${Math.random()*2-1}px, ${Math.random()*2-1}px)`; // Tremblement
        } else {
            document.body.style.transform = "none";
        }

        // Heartbeat dynamique
        let bpm = 60 + STATE.threat * 1.5; // De 60 à 210 BPM
        if(time - STATE.lastHeartbeat > (60000/bpm)) {
            AudioEngine.heartbeat(bpm);
            STATE.lastHeartbeat = time;
        }

        // IA Démon (Pression Idle)
        if(STATE.threat > 80 && Math.random() < 0.005) demonReact('panic');
        if(STATE.threat < 50 && Math.random() < 0.001) demonReact('idle');

        // Game Over
        if(STATE.threat >= 100) {
            death();
        } else {
            requestAnimationFrame(update);
        }
    }

    function death() {
        STATE.isActive = false;
        AudioEngine.playTone(50, 'sawtooth', 2, 0.8); // Bruit horrible
        document.body.innerHTML = "";
        document.body.style.background = "red";
        setTimeout(() => {
            document.body.style.background = "black";
            speak("Ton âme m'appartient.", true);
            setTimeout(() => location.reload(), 4000);
        }, 100);
    }

    // --- START SEQUENCE ---
    function startGameSequence() {
        AudioEngine.init();
        AudioEngine.startDrone(); // Lancement du son d'ambiance

        // Anim Intro
        document.getElementById('layer-intro').classList.remove('active-layer');
        document.getElementById('eye-lids').style.display = 'block'; // Effet de clignement
        
        setTimeout(() => {
            document.getElementById('layer-game').classList.add('active-layer');
            document.getElementById('eye-lids').style.animation = 'none'; // Yeux ouverts
            document.getElementById('eye-lids').style.transform = 'scaleY(0)';
            
            speak(DIALOGUES.intro, true);
            
            setTimeout(() => {
                generateKeyboard();
                generateLevel();
                STATE.isActive = true;
                requestAnimationFrame(update);
            }, 8000); // Attendre la fin du dialogue intro
        }, 3000);
    }

    function generateKeyboard() {
        const k = document.getElementById('keyboard');
        for(let i=1; i<=9; i++) {
            let btn = document.createElement('div');
            btn.className = 'key';
            btn.textContent = i;
            btn.ontouchstart = (e) => { e.preventDefault(); inputNumber(i); }; // Mobile responsive
            btn.onclick = () => inputNumber(i);
            k.appendChild(btn);
        }
        // Bouton X pour effacer ? Non, dans ce mode hardcore, pas le droit à l'erreur.
    }

</script>
</body>
</html>
