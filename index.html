<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SUDOKU OR DIE: PURGATORY</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&display=swap');

        :root {
            --bg: #050505;
            --blood: #8a0b0b;
            --text: #a0a0a0;
            --highlight: #e0e0e0;
        }

        * { user-select: none; box-sizing: border-box; touch-action: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Courier Prime', monospace;
            margin: 0; height: 100vh; overflow: hidden;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        /* --- AMBIANCE --- */
        #noise {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAIAAAACCAYAAABytg0kAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAABZJREFUeNpi2r9//38gYGAEESAAEGAAasgJOgzOKCoAAAAASUVORK5CYII=');
            opacity: 0.08; pointer-events: none; z-index: 999;
        }
        #vignette {
            position: fixed; inset: 0;
            background: radial-gradient(circle, transparent 40%, #000 100%);
            pointer-events: none; z-index: 900;
            transition: box-shadow 0.2s;
        }

        /* --- UI JEU --- */
        #ui-layer { 
            display: none; width: 100%; max-width: 450px; height: 100%; 
            flex-direction: column; align-items: center; padding: 10px; z-index: 10;
        }

        #demon-eye {
            width: 100%; text-align: center; margin-bottom: 10px;
            font-size: 0.9rem; color: var(--blood); text-shadow: 0 0 5px var(--blood);
            min-height: 60px; display: flex; align-items: center; justify-content: center;
            border-bottom: 1px solid #333; padding-bottom: 10px;
            transition: color 0.3s;
        }

        .status-bar {
            width: 100%; display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.8rem; letter-spacing: 1px;
        }
        .stress-container {
            width: 100%; height: 6px; background: #111; margin-bottom: 15px; position: relative; border: 1px solid #333;
        }
        #stress-bar {
            width: 0%; height: 100%; background: var(--blood);
            transition: width 0.1s linear;
            box-shadow: 0 0 10px var(--blood);
        }

        /* --- GRILLE --- */
        #grid {
            display: grid; grid-template-columns: repeat(9, 1fr);
            gap: 1px; background: #333; border: 2px solid #555;
            width: 100%; aspect-ratio: 1; margin-bottom: 10px;
        }
        .cell {
            background: #080808; display: flex; align-items: center; justify-content: center;
            font-size: 1.3rem; color: #fff; cursor: pointer; transition: background 0.1s;
        }
        .cell:nth-child(3n) { border-right: 2px solid #555; }
        .cell:nth-child(9n) { border-right: none; }
        .cell:nth-child(n+19):nth-child(-n+27), 
        .cell:nth-child(n+46):nth-child(-n+54) { border-bottom: 2px solid #555; }

        .cell.fixed { color: #444; background: #050505; pointer-events: none; }
        .cell.selected { background: #1a1a1a; box-shadow: inset 0 0 15px #300; }
        .cell.error { background: #500; animation: shake 0.3s; }
        .cell.correct { color: #0f0; text-shadow: 0 0 8px #0f0; animation: pop 0.2s; }

        /* --- CLAVIER --- */
        #keypad {
            display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px;
            width: 100%; flex-grow: 1; max-height: 150px;
        }
        .key {
            background: #111; border: 1px solid #333; color: #888;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; border-radius: 2px; cursor: pointer;
        }
        .key:active { background: #333; color: #fff; transform: scale(0.95); }

        /* --- INTRO & NAME INPUT --- */
        #intro-screen {
            position: fixed; inset: 0; background: #000; z-index: 2000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; padding: 20px;
        }
        
        input[type="text"] {
            background: transparent; border: none; border-bottom: 2px solid var(--blood);
            color: #fff; font-family: 'Courier Prime', monospace; font-size: 1.5rem;
            text-align: center; width: 200px; margin: 20px 0; outline: none;
        }
        
        .fade-in { animation: fadeIn 2s forwards; opacity: 0; }
        @keyframes fadeIn { to { opacity: 1; } }
        @keyframes shake { 0%, 100% {transform:translateX(0)} 25% {transform:translateX(-5px)} 75% {transform:translateX(5px)} }
        @keyframes pop { 0% {transform:scale(1)} 50% {transform:scale(1.3)} 100% {transform:scale(1)} }

        button.start {
            margin-top: 20px; background: #100; border: 1px solid var(--blood);
            color: var(--blood); padding: 15px 40px; font-family: inherit; font-size: 1.2rem;
            cursor: pointer; letter-spacing: 2px; transition: 0.3s;
        }
        button.start:hover { background: var(--blood); color: #000; box-shadow: 0 0 30px var(--blood); }
        
        .skip-hint {
            position: absolute; bottom: 20px; color: #444; font-size: 0.7rem; cursor: pointer;
        }

        /* --- GAME OVER --- */
        #game-over {
            display: none; position: fixed; inset: 0; background: #200; z-index: 3000;
            flex-direction: column; align-items: center; justify-content: center;
            text-align: center; animation: pulseRed 2s infinite;
        }
        @keyframes pulseRed { 0% {background:#200} 50% {background:#300} 100% {background:#200} }

    </style>
</head>
<body>

<div id="noise"></div>
<div id="vignette"></div>

<div id="intro-screen">
    <div id="intro-content"></div>
    <div id="name-input-section" style="display:none; flex-direction: column; align-items: center;">
        <p style="color:#888; font-size:0.9rem;">COMMENT DOIS-JE T'APPELER AVANT TA MORT ?</p>
        <input type="text" id="player-name" maxlength="10" placeholder="..." autocomplete="off">
        <button class="start" onclick="validateName()">ENTRER</button>
    </div>
</div>

<div id="ui-layer">
    <div class="status-bar">
        <span>NIVEAU <span id="lvl-disp">1</span></span>
        <span id="player-disp" style="color:#666">MORTEL</span>
    </div>
    <div class="stress-container"><div id="stress-bar"></div></div>
    
    <div id="demon-eye">"Ne me fais pas attendre..."</div>

    <div id="grid"></div>

    <div id="keypad">
        <div class="key" onclick="input(1)">1</div>
        <div class="key" onclick="input(2)">2</div>
        <div class="key" onclick="input(3)">3</div>
        <div class="key" onclick="input(4)">4</div>
        <div class="key" onclick="input(5)">5</div>
        <div class="key" onclick="input(6)">6</div>
        <div class="key" onclick="input(7)">7</div>
        <div class="key" onclick="input(8)">8</div>
        <div class="key" onclick="input(9)">9</div>
        <div class="key" onclick="input('X')" style="color:var(--blood); border-color:var(--blood)">X</div>
    </div>
</div>

<div id="game-over">
    <h1 style="color:#fff; font-size:3rem; margin:0">TU ES MORT</h1>
    <p id="death-msg" style="color:#ffaaaa; margin-top:10px"></p>
    <button class="start" onclick="location.reload()">RECOMMENCER</button>
</div>

<script>
    // --- STATE MANAGER ---
    const STATE = {
        name: localStorage.getItem('sudoku_demon_name') || "",
        hasPlayed: localStorage.getItem('sudoku_demon_played') === "true",
        level: 1,
        stress: 0,
        grid: [],
        solution: [],
        selectedIdx: null,
        active: false,
        lastActionTime: Date.now()
    };

    // --- AUDIO ENGINE ---
    const AudioEngine = {
        ctx: null,
        droneOsc: null,
        droneGain: null,
        
        init: function() {
            window.AudioContext = window.AudioContext || window.webkitAudioContext;
            this.ctx = new AudioContext();
            
            // Drone d'ambiance sombre
            this.droneOsc = this.ctx.createOscillator();
            this.droneGain = this.ctx.createGain();
            this.droneOsc.type = 'sawtooth';
            this.droneOsc.frequency.value = 40;
            
            const filter = this.ctx.createBiquadFilter();
            filter.type = 'lowpass';
            filter.frequency.value = 100;

            this.droneOsc.connect(filter);
            filter.connect(this.droneGain);
            this.droneGain.connect(this.ctx.destination);
            
            this.droneGain.gain.value = 0;
            this.droneOsc.start();
        },

        startAmbience: function() {
            if(this.ctx.state === 'suspended') this.ctx.resume();
            this.droneGain.gain.setTargetAtTime(0.2, this.ctx.currentTime, 3);
        },

        updateStress: function(stress) {
            // Le son devient instable, plus aigu et "dissonant"
            let targetFreq = 40 + (stress * 0.8);
            let targetVol = 0.2 + (stress / 200);
            
            // Micro-vibrations pour simuler l'instabilité
            let wobble = Math.random() * (stress/10);
            
            this.droneOsc.frequency.setTargetAtTime(targetFreq + wobble, this.ctx.currentTime, 0.5);
            this.droneGain.gain.setTargetAtTime(targetVol, this.ctx.currentTime, 0.5);
        },

        sfxClick: function() {
            const t = this.ctx.currentTime;
            const osc = this.ctx.createOscillator();
            const g = this.ctx.createGain();
            osc.frequency.setValueAtTime(800, t);
            osc.frequency.exponentialRampToValueAtTime(100, t + 0.05);
            g.gain.setValueAtTime(0.1, t);
            g.gain.exponentialRampToValueAtTime(0.01, t + 0.05);
            osc.connect(g); g.connect(this.ctx.destination);
            osc.start(); osc.stop(t + 0.06);
        },

        sfxError: function() {
            const t = this.ctx.currentTime;
            const osc = this.ctx.createOscillator();
            const g = this.ctx.createGain();
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(150, t);
            osc.frequency.linearRampToValueAtTime(50, t + 0.3);
            g.gain.setValueAtTime(0.5, t);
            g.gain.linearRampToValueAtTime(0, t + 0.3);
            osc.connect(g); g.connect(this.ctx.destination);
            osc.start(); osc.stop(t + 0.3);
        },

        sfxWin: function() {
            const t = this.ctx.currentTime;
            const osc = this.ctx.createOscillator();
            const g = this.ctx.createGain();
            osc.type = 'sine';
            osc.frequency.setValueAtTime(400, t);
            osc.frequency.exponentialRampToValueAtTime(800, t + 0.2);
            g.gain.setValueAtTime(0.2, t);
            g.gain.linearRampToValueAtTime(0, t + 0.5);
            osc.connect(g); g.connect(this.ctx.destination);
            osc.start(); osc.stop(t + 0.5);
        }
    };

    // --- DEMON AI (DIALOGUES) ---
    const DEMON = {
        lastSpeech: 0,
        
        say: function(text, force = false, anger = 0) {
            let now = Date.now();
            if (!force && now - this.lastSpeech < 3500) return;
            this.lastSpeech = now;

            // Injection du nom
            let finalTxt = text.replace("{name}", STATE.name || "Mortel");

            // UI
            const el = document.getElementById('demon-eye');
            el.innerText = finalTxt;
            el.style.color = anger > 0 ? "#f00" : "var(--blood)";
            el.style.animation = "none";
            el.offsetHeight; 
            el.style.animation = "shake 0.4s";

            // TTS (Text To Speech)
            window.speechSynthesis.cancel();
            const utt = new SpeechSynthesisUtterance(finalTxt);
            utt.lang = 'fr-FR';
            utt.pitch = 0.1 + (anger * 0.1); // Plus aigu si énervé
            utt.rate = 0.8;
            utt.volume = 1;
            
            // Choix de voix (préférer voix masculine/grave si dispo)
            let voices = window.speechSynthesis.getVoices();
            let fr = voices.find(v => v.lang.includes('fr'));
            if(fr) utt.voice = fr;
            
            window.speechSynthesis.speak(utt);
        },

        checkIdle: function() {
            if (Date.now() - STATE.lastActionTime > 12000 && STATE.active) {
                let lines = [
                    "{name}...",
                    "Tu dors ?",
                    "Le temps coule, {name}.",
                    "Je m'ennuie.",
                    "Joue."
                ];
                this.say(lines[Math.floor(Math.random() * lines.length)]);
                STATE.lastActionTime = Date.now(); // Reset pour pas spammer
            }
        },

        reactError: function() {
            let lines = [
                "Non, {name} !",
                "Idiot.",
                "Tu trembles.",
                "Regarde bien.",
                "Encore une erreur.",
                "Pathétique."
            ];
            this.say(lines[Math.floor(Math.random() * lines.length)], true, 1);
        },

        reactWin: function() {
            let lines = [
                "Hmm.",
                "Pas mal, {name}.",
                "Suivant.",
                "Ne te relâche pas.",
                "Tu as de la chance."
            ];
            this.say(lines[Math.floor(Math.random() * lines.length)]);
        }
    };

    // --- SUDOKU ENGINE ---
    const Sudoku = {
        generate: function(holes) {
            let board = Array(81).fill(0);
            this.fill(board);
            let sol = [...board];
            
            // Création des trous
            let attempts = holes;
            while(attempts > 0) {
                let i = Math.floor(Math.random()*81);
                if(board[i]!==0) { board[i]=0; attempts--; }
            }
            return { p: board, s: sol };
        },
        fill: function(b) {
            for(let i=0; i<81; i++) {
                if(b[i]===0) {
                    let nums = [1,2,3,4,5,6,7,8,9].sort(()=>Math.random()-0.5);
                    for(let n of nums) {
                        if(this.valid(b,i,n)) {
                            b[i]=n;
                            if(this.fill(b)) return true;
                            b[i]=0;
                        }
                    }
                    return false;
                }
            }
            return true;
        },
        valid: function(b,i,n) {
            let r=Math.floor(i/9), c=i%9;
            for(let k=0; k<9; k++) {
                if(b[r*9+k]===n) return false;
                if(b[k*9+c]===n) return false;
                let br=Math.floor(r/3)*3, bc=Math.floor(c/3)*3;
                if(b[(br+Math.floor(k/3))*9+(bc+k%3)]===n) return false;
            }
            return true;
        }
    };

    // --- FLOW DU JEU ---
    window.onload = function() {
        if (STATE.hasPlayed && STATE.name) {
            // Joueur existant : skip intro cinématique, aller direct à l'input nom (pré-rempli)
            document.getElementById('intro-content').style.display = 'none';
            document.getElementById('player-name').value = STATE.name;
            document.getElementById('name-input-section').style.display = 'flex';
        } else {
            // Nouveau joueur : Intro complète
            playIntroSequence();
        }
    };

    async function playIntroSequence() {
        const txt = document.getElementById('intro-content');
        const lines = ["Initialisation...", "Sujet détecté.", "Tu es dans mon purgatoire.", "Prouve ta valeur."];
        
        for (let l of lines) {
            txt.innerHTML = `<h2 class="fade-in" style="color:#fff; letter-spacing:3px">${l}</h2>`;
            await new Promise(r => setTimeout(r, 2500));
        }
        document.getElementById('intro-content').style.display = 'none';
        document.getElementById('name-input-section').style.display = 'flex';
    }

    function validateName() {
        let inp = document.getElementById('player-name');
        let val = inp.value.trim().toUpperCase();
        if (val.length < 2) val = "MORTEL";
        
        STATE.name = val;
        localStorage.setItem('sudoku_demon_name', STATE.name);
        localStorage.setItem('sudoku_demon_played', "true");
        
        startGame();
    }

    function startGame() {
        AudioEngine.init();
        AudioEngine.startAmbience();
        
        document.getElementById('intro-screen').style.display = 'none';
        document.getElementById('ui-layer').style.display = 'flex';
        document.getElementById('player-disp').innerText = STATE.name;
        
        STATE.active = true;
        STATE.level = 1;
        DEMON.say("Bienvenue, {name}. Commençons doucement.");
        startLevel();
        loop();
    }

    function startLevel() {
        STATE.stress = Math.max(0, STATE.stress - 30); // Récompense de stress
        
        // --- COURBE DE DIFFICULTÉ ---
        // Niveau 1 : très facile (5 trous) -> gratification instantanée
        // Niveau 10 : 35 trous
        // Max 55 trous
        let holes = 5 + Math.floor(STATE.level * 3);
        if (holes > 55) holes = 55;
        if (STATE.level === 1) holes = 5; // Force easy mode start

        let data = Sudoku.generate(holes);
        STATE.grid = data.p;
        STATE.solution = data.s;
        
        renderGrid();
        document.getElementById('lvl-disp').innerText = STATE.level;
    }

    function renderGrid() {
        const g = document.getElementById('grid');
        g.innerHTML = '';
        STATE.grid.forEach((v, i) => {
            let d = document.createElement('div');
            d.className = 'cell' + (v!==0 ? ' fixed' : '');
            if(v!==0) d.innerText = v;
            else d.onclick = () => select(d, i);
            g.appendChild(d);
        });
        STATE.selectedIdx = null;
    }

    function select(el, idx) {
        if(!STATE.active) return;
        document.querySelectorAll('.selected').forEach(e=>e.classList.remove('selected'));
        el.classList.add('selected');
        STATE.selectedIdx = idx;
    }

    function input(val) {
        if(STATE.selectedIdx===null || !STATE.active) return;
        STATE.lastActionTime = Date.now();
        
        let cell = document.getElementById('grid').children[STATE.selectedIdx];
        
        if(val === 'X') {
            cell.innerText = '';
            STATE.grid[STATE.selectedIdx] = 0;
            return;
        }

        AudioEngine.sfxClick();

        if(val === STATE.solution[STATE.selectedIdx]) {
            // CORRECT
            cell.innerText = val;
            cell.className = 'cell correct';
            STATE.grid[STATE.selectedIdx] = val;
            
            // Check Win global
            if(!STATE.grid.includes(0)) {
                AudioEngine.sfxWin();
                STATE.level++;
                DEMON.reactWin();
                setTimeout(startLevel, 1000);
            }
        } else {
            // ERREUR
            AudioEngine.sfxError();
            cell.classList.add('error');
            setTimeout(()=>cell.classList.remove('error'), 400);
            
            // Punition stress : augmente avec le niveau
            let punish = 15 + (STATE.level * 2);
            STATE.stress += punish;
            DEMON.reactError();
        }
    }

    function loop() {
        if(!STATE.active) return;

        // --- STRESS BUILDUP ---
        // Niveau 1 : Très lent
        // Niveau + : De plus en plus vite
        let speed = 0.03 + (STATE.level * 0.005);
        STATE.stress += speed;
        
        // UI Updates
        let bar = document.getElementById('stress-bar');
        bar.style.width = Math.min(100, STATE.stress) + "%";
        
        // Couleur bar : vire au rouge vif
        if (STATE.stress > 80) bar.style.backgroundColor = "#f00";
        else bar.style.backgroundColor = "var(--blood)";

        // Audio dynamic
        AudioEngine.updateStress(STATE.stress);

        // Vignette
        document.getElementById('vignette').style.boxShadow = `inset 0 0 ${STATE.stress*1.5}px var(--blood)`;

        // Check Idle
        DEMON.checkIdle();

        // Death
        if(STATE.stress >= 100) {
            die();
        } else {
            requestAnimationFrame(loop);
        }
    }

    function die() {
        STATE.active = false;
        AudioEngine.sfxError();
        DEMON.say("C'est fini pour toi, {name}.", true);
        
        document.getElementById('game-over').style.display = 'flex';
        document.getElementById('death-msg').innerText = `Tu as succombé au niveau ${STATE.level}.`;
    }

</script>
</body>
</html>
