<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PLURIBUS : REBORN</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <meta name="theme-color" content="#00ff00">
    <style>
        :root {
            --bg-color: #0a0a0a;
            --text-color: #e0e0e0;
            --accent-color: #00ff00;
            --danger-color: #ff3333;
            --safe-color: #33ff33;
            --panel-color: #111111;
            --border-color: #333;
            --pixel-size: 2px;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Courier New', monospace;
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            touch-action: pan-y;
        }

        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                rgba(18, 16, 16, 0) 50%,
                rgba(0, 0, 0, 0.25) 50%
            );
            background-size: 100% var(--pixel-size);
            z-index: 1000;
            pointer-events: none;
            opacity: 0.3;
        }

        #header {
            background: #111;
            border-bottom: 3px solid var(--accent-color);
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 0 #000;
            z-index: 100;
            flex-shrink: 0;
            border-image: repeating-linear-gradient(
                90deg,
                transparent,
                transparent 2px,
                #222 2px,
                #222 4px
            ) 1;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 70px;
            padding: 5px;
            border: 2px solid #333;
            background: #0a0a0a;
        }

        .stat-label {
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 4px;
            color: #888;
        }

        .stat-value {
            font-size: 16px;
            font-weight: bold;
            text-shadow: 0 0 5px currentColor;
        }

        #sync-value {
            color: var(--accent-color);
        }

        #health-value {
            color: var(--safe-color);
        }

        #xp-value {
            color: #ffcc00;
        }

        .progress-container {
            width: 100%;
            height: 8px;
            background-color: #222;
            border: 2px solid #333;
            margin-top: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background-color: currentColor;
            box-shadow: 
                inset -2px 0 0 rgba(255,255,255,0.2),
                inset 2px 0 0 rgba(0,0,0,0.5);
            transition: width 0.5s ease;
        }

        #sync-fill {
            color: var(--accent-color);
        }

        #health-fill {
            color: var(--safe-color);
        }

        #game-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            background: #000;
        }

        #cinematic-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        #cinematic-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 0;
        }

        #cinematic-foreground {
            position: relative;
            z-index: 2;
            width: 100%;
            max-width: 800px;
            height: 60vh;
            border: 3px solid #333;
            background: #111;
            box-shadow: 
                0 0 20px rgba(0, 255, 0, 0.2),
                inset 0 0 20px rgba(0, 255, 0, 0.1);
            overflow: hidden;
        }

        .cinematic-scene {
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            text-align: center;
        }

        .cinematic-scene.active {
            display: flex;
        }

        .scene-title {
            font-size: 24px;
            color: var(--accent-color);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 20px;
            text-shadow: 0 0 10px currentColor;
            border-bottom: 2px solid var(--accent-color);
            padding-bottom: 10px;
            width: 100%;
        }

        .scene-description {
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 30px;
            background: rgba(0, 0, 0, 0.7);
            padding: 20px;
            border: 1px solid #333;
            max-width: 600px;
        }

        .scene-character {
            font-size: 12px;
            color: #888;
            font-style: italic;
            margin-top: 20px;
            border-top: 1px solid #333;
            padding-top: 10px;
            width: 100%;
        }

        @keyframes typewriter {
            from { width: 0; }
            to { width: 100%; }
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }

        #story-text {
            background-color: rgba(17, 17, 17, 0.95);
            border: 3px solid #333;
            border-radius: 0;
            padding: 20px;
            margin: 15px;
            line-height: 1.6;
            font-size: 14px;
            max-height: 150px;
            overflow-y: auto;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            z-index: 1;
            position: relative;
            border-image: repeating-linear-gradient(
                90deg,
                #333,
                #333 2px,
                transparent 2px,
                transparent 4px
            ) 1;
        }

        #choices-container {
            padding: 15px;
            background-color: #111;
            border-top: 3px solid #333;
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 40vh;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .choice-btn {
            background: #0a0a0a;
            border: 2px solid #333;
            border-left: 4px solid var(--accent-color);
            color: var(--text-color);
            padding: 15px;
            text-align: left;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.1s;
            position: relative;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .choice-btn:active, .choice-btn:hover {
            background: #222;
            border-left-color: #33ff33;
            transform: translateX(2px);
        }

        .choice-btn:active::before {
            content: "▶";
            position: absolute;
            left: -15px;
            color: var(--accent-color);
        }

        .choice-sync {
            font-size: 10px;
            float: right;
            padding: 2px 6px;
            background-color: #222;
            border: 1px solid #333;
            margin-left: 10px;
        }

        .choice-sync.positive {
            color: #33ff33;
            border-color: #33ff33;
        }

        .choice-sync.negative {
            color: #ff3333;
            border-color: #ff3333;
        }

        #effects-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }

        #side-menu-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background-color: #111;
            border: 2px solid var(--accent-color);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            color: var(--accent-color);
            z-index: 101;
            box-shadow: 0 4px 0 #000;
            cursor: pointer;
        }

        #side-menu {
            position: fixed;
            top: 0;
            right: -300px;
            width: 280px;
            height: 100%;
            background-color: #111;
            z-index: 200;
            transition: right 0.3s;
            padding: 20px;
            overflow-y: auto;
            border-left: 3px solid var(--accent-color);
            box-shadow: -5px 0 15px rgba(0,0,0,0.5);
        }

        .menu-section {
            margin-bottom: 25px;
            border: 2px solid #333;
            padding: 15px;
            background: #0a0a0a;
        }

        .menu-section h3 {
            color: var(--accent-color);
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 16px;
            border-bottom: 2px solid #333;
            padding-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .skill-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dotted #333;
        }

        .skill-name {
            font-size: 12px;
        }

        .skill-level {
            color: #ffcc00;
            font-weight: bold;
            font-family: monospace;
        }

        .inventory-item {
            background-color: #0a0a0a;
            padding: 10px;
            border: 1px solid #333;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            font-size: 12px;
        }

        .inventory-item::before {
            content: "■";
            margin-right: 10px;
            color: var(--accent-color);
        }

        @keyframes glitch {
            0% { transform: translate(0); filter: hue-rotate(0); }
            2% { transform: translate(-2px, -1px); filter: hue-rotate(90deg); }
            4% { transform: translate(2px, 1px); }
            6% { transform: translate(-2px, 0); filter: hue-rotate(180deg); }
            8% { transform: translate(0, 2px); }
            10% { transform: translate(0); filter: hue-rotate(0); }
            100% { transform: translate(0); filter: hue-rotate(0); }
        }

        .glitch-active {
            animation: glitch 0.3s;
        }

        @keyframes static {
            0% { background-position: 0 0; }
            100% { background-position: 20px 20px; }
        }

        .static-effect {
            background-image: 
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 2px,
                    rgba(0,255,0,0.05) 2px,
                    rgba(0,255,0,0.05) 4px
                ),
                repeating-linear-gradient(
                    90deg,
                    transparent,
                    transparent 2px,
                    rgba(0,255,0,0.05) 2px,
                    rgba(0,255,0,0.05) 4px
                );
            animation: static 0.5s infinite linear;
        }

        @media (max-height: 700px) {
            #cinematic-foreground { height: 50vh; }
            #story-text { font-size: 12px; max-height: 120px; }
            .choice-btn { padding: 12px 15px; }
        }

        @media (max-width: 400px) {
            .stat-item { min-width: 60px; }
            .stat-value { font-size: 14px; }
            .scene-title { font-size: 18px; }
        }

        body {
            cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><rect x="0" y="0" width="16" height="16" fill="%2300ff00" opacity="0.5"/></svg>'), auto;
        }

        button, .choice-btn {
            cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><rect x="0" y="0" width="16" height="16" fill="%2333ff33"/></svg>'), pointer;
        }
    </style>
</head>
<body>
    <div id="header">
        <div class="stat-item">
            <div class="stat-label">NOM</div>
            <div id="player-name" class="stat-value">INCONNU</div>
        </div>
        
        <div class="stat-item">
            <div class="stat-label">SYNCHRO</div>
            <div id="sync-value" class="stat-value">0%</div>
            <div class="progress-container">
                <div id="sync-fill" class="progress-fill" style="width: 0%"></div>
            </div>
        </div>
        
        <div class="stat-item">
            <div class="stat-label">SANTÉ</div>
            <div id="health-value" class="stat-value">100%</div>
            <div class="progress-container">
                <div id="health-fill" class="progress-fill" style="width: 100%"></div>
            </div>
        </div>
        
        <div class="stat-item">
            <div class="stat-label">XP</div>
            <div id="xp-value" class="stat-value">0</div>
        </div>
    </div>

    <div id="game-container">
        <div id="cinematic-container">
            <div id="cinematic-background" class="static-effect"></div>
            <div id="cinematic-foreground">
                <div id="scene-bruxelles" class="cinematic-scene active">
                    <div class="scene-title">BRUXELLES. RUE NEUVE.</div>
                    <div class="scene-description" id="cinematic-text"></div>
                    <div class="scene-character">SILENCE ABSOLU</div>
                </div>
            </div>
        </div>
        
        <div id="story-text">CHARGEMENT DE LA CONSCIENCE...</div>
    </div>

    <div id="choices-container">
        <!-- Les choix seront insérés ici dynamiquement -->
    </div>

    <button id="side-menu-btn">
        ▣
    </button>

    <div id="side-menu">
        <div class="menu-section">
            <h3>PERSONNAGE</h3>
            <div><strong>NOM:</strong> <span id="menu-name">INCONNU</span></div>
            <div><strong>CHAPITRE:</strong> <span id="menu-chapter">PROLOGUE</span></div>
            <div><strong>ALIGNEMENT:</strong> <span id="menu-alignment">NEUTRE</span></div>
        </div>
        
        <div class="menu-section">
            <h3>COMPÉTENCES</h3>
            <div class="skill-item">
                <span class="skill-name">PIRATAGE DE RUCHE</span>
                <span class="skill-level" id="skill-hack">LVL 0</span>
            </div>
            <div class="skill-item">
                <span class="skill-name">RÉSILIENCE PSYCHIQUE</span>
                <span class="skill-level" id="skill-resist">LVL 0</span>
            </div>
            <div class="skill-item">
                <span class="skill-name">EXPERTISE TACTILE</span>
                <span class="skill-level" id="skill-tech">LVL 0</span>
            </div>
            <div class="skill-item">
                <span class="skill-name">POINTS DISPONIBLES:</span>
                <span class="skill-level" id="skill-points">0</span>
            </div>
        </div>
        
        <div class="menu-section">
            <h3>INVENTAIRE</h3>
            <div id="inventory-list">
                <div class="inventory-item">PASS NAVIGO</div>
            </div>
        </div>
        
        <div class="menu-section">
            <h3>SYSTÈME</h3>
            <button class="choice-btn" style="margin-bottom: 8px; font-size: 12px;" onclick="saveGame()">
                ■ SAUVEGARDER
            </button>
            <button class="choice-btn" style="margin-bottom: 8px; font-size: 12px;" onclick="loadGame()">
                ■ CHARGER
            </button>
            <button class="choice-btn" style="border-color: #ff3333; font-size: 12px;" onclick="resetGame()">
                ■ RECOMMENCER
            </button>
        </div>
    </div>

    <div id="effects-overlay"></div>

    <script>
        const gameConfig = {
            initialHealth: 100,
            initialSync: 0,
            initialXP: 0,
            syncWarningThreshold: 50,
            syncDangerThreshold: 80,
            xpPerChapter: 100,
            baseSkillCost: 10
        };

        let gameState = {
            playerName: "INCONNU",
            currentChapter: "start",
            sync: 0,
            health: 100,
            xp: 0,
            alignment: "neutral",
            alignmentScore: 0,
            skills: {
                hack: 0,
                resist: 0,
                tech: 0
            },
            skillPoints: 0,
            inventory: ["Pass Navigo"],
            visitedChapters: new Set(["start"]),
            choicesHistory: []
        };

        const storyData = {
            start: {
                title: "BRUXELLES. RUE NEUVE.",
                description: "Un silence de mort. Tu te réveilles au sol, le crâne explosant de douleur. Le 'Lien' vient d'être brisé par une onde de choc mondiale. Tu vomis un liquide noir et visqueux... ton corps rejette la Ruche.",
                character: "SILENCE ABSOLU",
                choices: [
                    { text: "SE LEVER AVEC PEINE ET CHERCHER SON NOM", next: "naming", xp: 5 }
                ]
            },
            
            naming: {
                title: "IDENTITÉ RETROUVÉE",
                description: "La douleur s'estompe lentement. Tu aperçois un vieux pass Navigo au sol, à moitié calciné. Quel était ton nom, avant le Lien ?",
                character: "SOUVENIRS ÉPARS",
                type: "input",
                next: "awakening"
            },
            
            awakening: {
                title: "LE VOISIN",
                description: "Une silhouette apparaît dans l'encadrement de la porte. Marc, ton voisin. Ses yeux sont vides, trop calmes. Il te tend une tasse fumante de protéines HDP.",
                character: "MARC: VOISIN DE LA RUCHE",
                choices: [
                    { 
                        text: "ACCEPTER LA TASSE", 
                        next: "stay_connected", 
                        sync: 15, 
                        alignment: 5,
                        xp: 10
                    },
                    { 
                        text: "RENVERSER LA TASSE", 
                        next: "rebel", 
                        sync: -5, 
                        alignment: -5,
                        xp: 15
                    },
                    { 
                        text: "FRAPPER ET FUIR", 
                        next: "violence", 
                        health: -10,
                        alignment: -10,
                        xp: 20
                    }
                ]
            },
            
            stay_connected: {
                title: "LA CONNEXION",
                description: "Le liquide est tiède, sucré-amer. Aussitôt, les murmures de la Ruche reviennent en fond sonore. Tu sais instinctivement que Diabaté surveille la ville. Tu te sens en sécurité, protégé...",
                character: "MURMURES DE LA RUCHE",
                choices: [
                    { 
                        text: "PRENDRE LA RADIO ET SORTIR", 
                        next: "escape_brussels",
                        xp: 10
                    }
                ]
            },
            
            rebel: {
                title: "LA RÉBELLION",
                description: "La tasse se brise en mille morceaux. Marc penche la tête, une tristesse infinie dans le regard. 'La solitude te détruira.' Mais tu sens une force incroyable monter en toi.",
                character: "PREMIÈRE RÉSISTANCE",
                inventoryAdd: "Radio portable",
                choices: [
                    { 
                        text: "PRENDRE L'ÉCHELLE DE SECOURS", 
                        next: "escape_brussels",
                        xp: 10
                    }
                ]
            },
            
            violence: {
                title: "LA VIOLENCE",
                description: "Tu le pousses violemment. Il tombe sans un bruit, sans colère. Les Pluribus ne connaissent pas la haine, seulement la tristesse. Tu viens de franchir un point de non-retour.",
                character: "POINT DE NON-RETOUR",
                health: -5,
                inventoryAdd: "Couteau de poche",
                choices: [
                    { 
                        text: "SORTIR DANS LA RUE DÉSERTE", 
                        next: "escape_brussels",
                        xp: 15
                    }
                ]
            },
            
            escape_brussels: {
                title: "LA FUITE",
                description: "Dehors, l'apocalypse. Le ciel a viré au violet électrique. Des centaines de Pluribus sont figés dans la rue, certains saignent du nez. Un drone de Diabaté survole la zone.",
                character: "SYSTÈME D'ALERTE: DISSIDENT DÉTECTÉ",
                choices: [
                    { 
                        text: "CHERCHER UN VÉHICULE", 
                        next: "car_theft",
                        xp: 10
                    }
                ]
            },
            
            car_theft: {
                title: "LE VÉHICULE",
                description: "Une voiture électrique des Autres est garée porte ouverte. En posant ta main sur le tableau de bord, tes résidus de connexion 'parlent' au système. Le moteur démarre en silence.",
                character: "SYSTÈME RÉACTIVÉ",
                sync: 5,
                inventoryAdd: "Voiture électrique",
                choices: [
                    { 
                        text: "ROULER VERS LE SUD", 
                        next: "pursuit_laxmi",
                        xp: 5
                    }
                ]
            },
            
            pursuit_laxmi: {
                title: "LA POURSUITE",
                description: "L'écran de bord s'allume soudain. C'est le visage de Laxmi, empreint d'une tristesse rageuse. 'Arrête-toi. Le monde se déchire à cause de votre folie.' Deux voitures Sentinelles surgissent derrière toi.",
                character: "LAXMI: GARDIENNE DE L'ÉQUILIBRE",
                choices: [
                    { 
                        text: "PERCUTER UNE SENTINELLE", 
                        next: "collide_sentinel", 
                        sync: -10,
                        alignment: -10,
                        health: -15,
                        xp: 25,
                        requiresSkill: "tech",
                        skillLevel: 0
                    },
                    { 
                        text: "SURCHARGER LEURS SYSTÈMES", 
                        next: "overload_sentinels", 
                        sync: 15,
                        alignment: -5,
                        xp: 30,
                        requiresSkill: "hack",
                        skillLevel: 1
                    },
                    { 
                        text: "TENTER DE NÉGOCIER", 
                        next: "negotiate_laxmi", 
                        alignment: 10,
                        xp: 20
                    }
                ]
            },
            
            collide_sentinel: {
                title: "IMPACT",
                description: "Tu braques le volant brutalement. L'impact est violent, métal contre métal. La Sentinelle dérape et s'écrase contre un pilier. Ta voiture grince mais tient le coup. Derrière, la deuxième Sentinelle ralentit, surprise.",
                character: "SYSTÈMES DE CONTRÔLE: ENDOMMAGÉS",
                health: -10,
                sync: -5,
                xp: 25,
                choices: [
                    { 
                        text: "PROFITER DE LA CONFUSION POUR FUIR", 
                        next: "border_crossing",
                        xp: 15
                    }
                ]
            },
            
            overload_sentinels: {
                title: "SURCHARGE SYSTÈMIQUE",
                description: "Tes doigts volent sur l'écran tactile. Tu injectes un virus dormant dans le réseau Sentinelle. Les phares des voitures derrière toi clignotent follement avant de s'éteindre. Elles dévient et s'immobilisent sur le bas-côté.",
                character: "RÉSEAU SENTINELLE: CORROMPU",
                sync: 10,
                xp: 35,
                inventoryAdd: "Clé de cryptage Sentinelle",
                choices: [
                    { 
                        text: "CONTINUER VERS LA FRONTIÈRE", 
                        next: "border_crossing",
                        xp: 15
                    }
                ]
            },
            
            negotiate_laxmi: {
                title: "NÉGOCIATION",
                description: "'Laxmi, écoute-moi. Je ne suis pas ton ennemi.' Tu parles calmement dans le micro. Un silence, puis sa voix revient, plus calme : 'Rends-toi au point de contrôle 47. Nous devons parler.' Les Sentinelles se contentent de t'escorter.",
                character: "LAXMI: MODE DIPLOMATIQUE ACTIVÉ",
                alignment: 15,
                xp: 30,
                choices: [
                    { 
                        text: "SUIVRE LES SENTINELLES AU POINT DE CONTRÔLE", 
                        next: "checkpoint_47",
                        xp: 20
                    },
                    { 
                        text: "PROFITER DE LEUR ATTENTION RELÂCHÉE POUR FUIR", 
                        next: "border_crossing",
                        sync: -10,
                        xp: 25
                    }
                ]
            },
            
            checkpoint_47: {
                title: "POINT DE CONTRÔLE 47",
                description: "Le point de contrôle est une ancienne station-service convertie en avant-poste. Laxmi t'attend, sans arme, les bras croisés. 'Tu es différent des autres dissidents, [NOM]. Tu cherches des réponses, pas la destruction.'",
                character: "LAXMI: VISAGE À VISAGE",
                alignment: 10,
                xp: 20,
                choices: [
                    { 
                        text: "DEMANDER POURQUOI LE LIEN A ÉTÉ BRISÉ", 
                        next: "truth_revealed",
                        xp: 25
                    },
                    { 
                        text: "REFUSER DE DISCUTER ET TENTER DE S'ÉCHAPPER", 
                        next: "escape_checkpoint",
                        health: -20,
                        xp: 30
                    }
                ]
            },
            
            border_crossing: {
                title: "FRONTIÈRE FRANCO-BELGE",
                description: "La frontière n'est plus qu'un amas de barrières renversées et de camions abandonnés. Au loin, les lumières de Lille clignotent faiblement. C'est là que Carol opère. Mais quelque chose ne va pas... le silence radio est total.",
                character: "ZONE FRONTALIÈRE: DÉSERTÉE",
                xp: 20,
                choices: [
                    { 
                        text: "CHERCHER UN SIGNE DE CAROL", 
                        next: "carols_signal",
                        requiresSkill: "tech",
                        skillLevel: 1,
                        xp: 25
                    },
                    { 
                        text: "EXPLORER LES CAMIONS ABANDONNÉS", 
                        next: "abandoned_trucks",
                        xp: 15
                    }
                ]
            },
            
            truth_revealed: {
                title: "LA VÉRITÉ",
                description: "Laxmi baisse les yeux. 'Le Lien n'a pas été brisé par un accident. C'était un acte délibéré de Diabaté. Il cherchait à éliminer les consciences trop fortes, celles qui résistaient à son contrôle. Toi, tu as survécu.'",
                character: "RÉVÉLATION",
                alignment: 20,
                sync: -20,
                xp: 40,
                inventoryAdd: "Données secrètes de Diabaté",
                choices: [
                    { 
                        text: "PROPOSER UNE ALLIANCE À LAXMI", 
                        next: "alliance_proposal",
                        xp: 30
                    },
                    { 
                        text: "REFUSER ET PARTIR SEUL VERS CAROL", 
                        next: "border_crossing",
                        alignment: -20,
                        xp: 25
                    }
                ]
            },
            
            carols_signal: {
                title: "SIGNAL DE CAROL",
                description: "Tu ajustes la radio. Un signal faible mais clair émerge du bruit. Une voix que tu reconnais : Carol. 'Si vous entendez ceci, venez à Lille. Nous avons besoin de chaque conscience libre.' Les coordonnées s'affichent.",
                character: "CAROL: APPEL À LA RÉSISTANCE",
                sync: -15,
                xp: 35,
                inventoryAdd: "Coordonnées du QG de Carol",
                choices: [
                    { 
                        text: "SE DIRIGER VERS LE QG DE CAROL", 
                        next: "end_chapter1",
                        xp: 50
                    }
                ]
            },
            
            abandoned_trucks: {
                title: "CAMIONS ABANDONNÉS",
                description: "Les camions sont pleins de marchandises intactes : nourriture, médicaments, équipements. Mais aussi des cadavres de Pluribus, morts lors de la rupture du Lien. Dans un journal de bord, tu découvres que les Autres préparaient quelque chose...",
                character: "DÉCOUVERTE MACABRE",
                health: -5,
                xp: 25,
                inventoryAdd: "Journal de bord des Autres",
                choices: [
                    { 
                        text: "PRENDRE DES FOURNITURES ET CONTINUER", 
                        next: "carols_signal",
                        xp: 20
                    }
                ]
            },
            
            alliance_proposal: {
                title: "ALLIANCE",
                description: "Laxmi hésite, puis acquiesce. 'Je ne peux plus servir Diabaté en sachant cela. Mais sache ceci : Carol n'est pas un ange non plus. Elle utilise les mêmes techniques, juste pour un autre camp.' Elle te donne un émetteur crypté.",
                character: "LAXMI: NOUVELLE ALLIÉE",
                alignment: 30,
                xp: 50,
                inventoryAdd: "Émetteur crypté de Laxmi",
                choices: [
                    { 
                        text: "PARTIR VERS CAROL ENSEMBLE", 
                        next: "end_chapter1",
                        xp: 60
                    }
                ]
            },
            
            escape_checkpoint: {
                title: "FUITE DU POINT DE CONTRÔLE",
                description: "Tu fais semblant de t'évanouir. Quand les gardes s'approchent, tu les repousses et cours vers ta voiture. Les tirs claquent derrière toi. Un projectile te frôle le bras. Tu démarres en trombe, direction la France.",
                character: "ALERTE GÉNÉRALE",
                health: -25,
                alignment: -30,
                xp: 40,
                choices: [
                    { 
                        text: "ROULER LE PLUS LOIN POSSIBLE", 
                        next: "border_crossing",
                        xp: 20
                    }
                ]
            },
            
            end_chapter1: {
                title: "FIN DU CHAPITRE 1",
                description: "La route vers Lille s'étend devant toi. Derrière, Bruxelles n'est plus qu'un souvenir douloureux. Devant, l'inconnu. Tu as survécu à la rupture, découvert des vérités troublantes, et fait des choix qui façonneront l'avenir de l'humanité. Mais le voyage ne fait que commencer...",
                character: "À SUIVRE DANS LE PROCHAIN ÉPISODE",
                xp: 100,
                choices: [
                    { 
                        text: "REPRENDRE DEPUIS LE DÉBUT (NOUVELLE PARTIE+)", 
                        next: "start",
                        health: 100,
                        sync: 0,
                        xp: 0
                    }
                ]
            }
        };

        function initGame() {
            loadGame();
            updateGame(gameState.currentChapter);
            updateMenu();
            
            document.getElementById('side-menu-btn').addEventListener('click', toggleMenu);
            document.getElementById('game-container').addEventListener('click', closeMenu);
            
            if(!localStorage.getItem('pluribusFirstVisit')) {
                showMessage("PLURIBUS: REBORN\n\nVOTRE SYNCHRO MESURE VOTRE LIEN AVEC LA RUCHE.\nGARDEZ-LA BASSE POUR PRÉSERVER VOTRE HUMANITÉ.", 5000);
                localStorage.setItem('pluribusFirstVisit', 'true');
            }
        }
        
        function updateGame(chapterKey) {
            const chapter = storyData[chapterKey];
            if (!chapter) return;
            
            gameState.currentChapter = chapterKey;
            gameState.visitedChapters.add(chapterKey);
            
            updateCinematic(chapter);
            
            const choicesContainer = document.getElementById('choices-container');
            choicesContainer.innerHTML = '';
            
            if (chapter.type === 'input') {
                handleInputChapter(chapter);
                return;
            }
            
            if (chapter.choices && chapter.choices.length > 0) {
                chapter.choices.forEach(choice => {
                    if (choice.requiresSkill && gameState.skills[choice.requiresSkill] < (choice.skillLevel || 0)) {
                        return;
                    }
                    
                    const button = document.createElement('button');
                    button.className = 'choice-btn';
                    
                    let buttonText = choice.text;
                    if (choice.xp) {
                        buttonText += ` <span class="choice-sync positive">+${choice.xp}XP</span>`;
                    }
                    if (choice.sync) {
                        const syncClass = choice.sync > 0 ? 'negative' : 'positive';
                        buttonText += ` <span class="choice-sync ${syncClass}">${choice.sync > 0 ? '+' : ''}${choice.sync}%</span>`;
                    }
                    if (choice.health) {
                        const healthClass = choice.health > 0 ? 'positive' : 'negative';
                        buttonText += ` <span class="choice-sync ${healthClass}">${choice.health > 0 ? '+' : ''}${choice.health}HP</span>`;
                    }
                    
                    button.innerHTML = buttonText;
                    
                    button.addEventListener('click', () => {
                        makeChoice(choice, chapterKey);
                    });
                    
                    button.addEventListener('touchstart', () => {
                        button.style.transform = 'translateX(2px)';
                    });
                    
                    button.addEventListener('touchend', () => {
                        button.style.transform = 'translateX(0)';
                    });
                    
                    choicesContainer.appendChild(button);
                });
            }
            
            updateVisualEffects();
            updateMenu();
        }
        
        function updateCinematic(chapter) {
            const cinematicText = document.getElementById('cinematic-text');
            cinematicText.innerHTML = '';
            
            const text = chapter.description.replace(/\[NOM\]/g, gameState.playerName);
            let i = 0;
            
            function typeChar() {
                if (i < text.length) {
                    cinematicText.innerHTML += text.charAt(i);
                    i++;
                    const speed = gameState.sync > 70 ? 30 : gameState.sync > 40 ? 50 : 70;
                    setTimeout(typeChar, speed);
                }
            }
            
            typeChar();
            
            const sceneTitle = document.querySelector('.scene-title');
            const sceneCharacter = document.querySelector('.scene-character');
            
            sceneTitle.textContent = chapter.title || '';
            sceneCharacter.textContent = chapter.character || '';
        }
        
        function handleInputChapter(chapter) {
            const name = prompt("ENTRE TON PRÉNOM (AVANT LE LIEN) :", gameState.playerName);
            if (name && name.trim() !== '') {
                gameState.playerName = name.trim().toUpperCase();
                document.getElementById('player-name').textContent = gameState.playerName;
                document.getElementById('menu-name').textContent = gameState.playerName;
                
                gameState.xp += 20;
                updateStats();
                
                setTimeout(() => updateGame(chapter.next), 500);
            } else {
                setTimeout(() => updateGame('naming'), 100);
            }
        }
        
        function makeChoice(choice, fromChapter) {
            gameState.choicesHistory.push({
                chapter: fromChapter,
                choice: choice.text,
                timestamp: new Date().toISOString()
            });
            
            if (choice.sync) {
                gameState.sync = Math.max(0, Math.min(100, gameState.sync + choice.sync));
            }
            
            if (choice.health) {
                gameState.health = Math.max(0, Math.min(100, gameState.health + choice.health));
            }
            
            if (choice.xp) {
                gameState.xp += choice.xp;
                const newSkillPoints = Math.floor(gameState.xp / 100);
                if (newSkillPoints > Math.floor((gameState.xp - choice.xp) / 100)) {
                    gameState.skillPoints += 1;
                    showMessage("NOUVEAU POINT DE COMPÉTENCE DISPONIBLE", 3000);
                }
            }
            
            if (choice.alignment) {
                gameState.alignmentScore += choice.alignment;
                if (gameState.alignmentScore < -20) gameState.alignment = "PRO-CAROL";
                else if (gameState.alignmentScore > 20) gameState.alignment = "PRO-LAXMI";
                else gameState.alignment = "NEUTRE";
            }
            
            if (choice.inventoryAdd && !gameState.inventory.includes(choice.inventoryAdd)) {
                gameState.inventory.push(choice.inventoryAdd);
                showMessage(`OBJET AJOUTÉ: ${choice.inventoryAdd}`, 2000);
            }
            
            updateStats();
            
            if (choice.sync && Math.abs(choice.sync) >= 10) {
                triggerGlitchEffect(800);
            }
            
            if (choice.health && choice.health < 0) {
                triggerDamageEffect();
            }
            
            setTimeout(() => {
                if (choice.next && storyData[choice.next]) {
                    updateGame(choice.next);
                } else {
                    updateGame("start");
                }
            }, 500);
        }
        
        function updateStats() {
            document.getElementById('sync-value').textContent = `${gameState.sync}%`;
            document.getElementById('health-value').textContent = `${gameState.health}%`;
            document.getElementById('xp-value').textContent = gameState.xp;
            
            document.getElementById('sync-fill').style.width = `${gameState.sync}%`;
            document.getElementById('health-fill').style.width = `${gameState.health}%`;
            
            updateVisualEffects();
            saveGame();
        }
        
        function updateVisualEffects() {
            const body = document.body;
            const syncValue = gameState.sync;
            const bg = document.getElementById('cinematic-background');
            
            if (syncValue >= 80) {
                bg.style.backgroundColor = '#1a001a';
                bg.style.opacity = '0.7';
                body.style.cursor = 'url(\'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><rect x="0" y="0" width="16" height="16" fill="%23ff00ff"/></svg>\'), auto';
            } else if (syncValue >= 50) {
                bg.style.backgroundColor = '#001a00';
                bg.style.opacity = '0.5';
            } else {
                bg.style.backgroundColor = '#000';
                bg.style.opacity = '0.3';
            }
        }
        
        function triggerGlitchEffect(duration) {
            const overlay = document.getElementById('effects-overlay');
            const cinematic = document.getElementById('cinematic-foreground');
            
            overlay.style.background = 'repeating-linear-gradient(45deg, transparent, transparent 2px, rgba(0,255,0,0.2) 2px, rgba(0,255,0,0.2) 4px)';
            overlay.style.opacity = '0.7';
            cinematic.classList.add('glitch-active');
            
            if (navigator.vibrate) {
                navigator.vibrate([50, 30, 50]);
            }
            
            setTimeout(() => {
                overlay.style.opacity = '0';
                cinematic.classList.remove('glitch-active');
            }, duration);
        }
        
        function triggerDamageEffect() {
            const overlay = document.getElementById('effects-overlay');
            overlay.style.background = 'radial-gradient(circle, rgba(255,50,50,0.6) 0%, transparent 70%)';
            overlay.style.opacity = '0.6';
            
            setTimeout(() => {
                overlay.style.opacity = '0';
            }, 300);
        }
        
        function showMessage(message, duration) {
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background-color: #111;
                color: var(--accent-color);
                padding: 20px;
                border: 3px solid var(--accent-color);
                z-index: 1001;
                text-align: center;
                max-width: 80%;
                font-family: 'Courier New', monospace;
                text-transform: uppercase;
                letter-spacing: 1px;
                line-height: 1.4;
                white-space: pre-line;
            `;
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.style.transition = 'opacity 0.5s';
                messageDiv.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(messageDiv);
                }, 500);
            }, duration);
        }
        
        function toggleMenu() {
            const menu = document.getElementById('side-menu');
            const isOpen = menu.style.right === '0px';
            menu.style.right = isOpen ? '-300px' : '0px';
            
            const btn = document.getElementById('side-menu-btn');
            btn.innerHTML = isOpen ? '▣' : '✖';
        }
        
        function closeMenu() {
            document.getElementById('side-menu').style.right = '-300px';
            document.getElementById('side-menu-btn').innerHTML = '▣';
        }
        
        function updateMenu() {
            document.getElementById('menu-name').textContent = gameState.playerName;
            document.getElementById('menu-chapter').textContent = getChapterName(gameState.currentChapter);
            document.getElementById('menu-alignment').textContent = gameState.alignment;
            
            const inventoryList = document.getElementById('inventory-list');
            inventoryList.innerHTML = '';
            
            gameState.inventory.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'inventory-item';
                itemDiv.textContent = item.toUpperCase();
                inventoryList.appendChild(itemDiv);
            });
            
            document.getElementById('skill-hack').textContent = `LVL ${gameState.skills.hack}`;
            document.getElementById('skill-resist').textContent = `LVL ${gameState.skills.resist}`;
            document.getElementById('skill-tech').textContent = `LVL ${gameState.skills.tech}`;
            document.getElementById('skill-points').textContent = gameState.skillPoints;
            
            addSkillUpgradeButtons();
        }
        
        function addSkillUpgradeButtons() {
            const skillSection = document.querySelector('.menu-section:nth-child(2)');
            document.querySelectorAll('.upgrade-btn').forEach(btn => btn.remove());
            
            const skills = [
                { id: 'hack', name: 'PIRATAGE', cost: gameConfig.baseSkillCost * (gameState.skills.hack + 1) },
                { id: 'resist', name: 'RÉSILIENCE', cost: gameConfig.baseSkillCost * (gameState.skills.resist + 1) },
                { id: 'tech', name: 'EXPERTISE', cost: gameConfig.baseSkillCost * (gameState.skills.tech + 1) }
            ];
            
            skills.forEach(skill => {
                if (gameState.skillPoints > 0) {
                    const upgradeBtn = document.createElement('button');
                    upgradeBtn.className = 'choice-btn upgrade-btn';
                    upgradeBtn.style.marginTop = '5px';
                    upgradeBtn.style.padding = '8px';
                    upgradeBtn.style.fontSize = '10px';
                    upgradeBtn.innerHTML = `▲ ${skill.name} (${skill.cost}XP)`;
                    
                    upgradeBtn.addEventListener('click', () => {
                        upgradeSkill(skill.id, skill.cost);
                    });
                    
                    skillSection.appendChild(upgradeBtn);
                }
            });
        }
        
        function upgradeSkill(skillId, cost) {
            if (gameState.xp >= cost) {
                gameState.xp -= cost;
                gameState.skills[skillId] += 1;
                gameState.skillPoints -= 1;
                updateStats();
                updateMenu();
                showMessage(`${skillId === 'hack' ? 'PIRATAGE' : skillId === 'resist' ? 'RÉSILIENCE' : 'EXPERTISE'} AMÉLIORÉ(E)`, 2000);
            } else {
                showMessage(`XP INSUFFISANT: ${cost} XP REQUIS`, 2000);
            }
        }
        
        function getChapterName(chapterKey) {
            const chapterNames = {
                'start': 'PROLOGUE',
                'naming': 'IDENTITÉ',
                'awakening': 'RÉVEIL',
                'stay_connected': 'CONNEXION',
                'rebel': 'RÉBELLION',
                'violence': 'VIOLENCE',
                'escape_brussels': 'FUITE',
                'car_theft': 'VÉHICULE',
                'pursuit_laxmi': 'POURSUITE',
                'collide_sentinel': 'IMPACT',
                'overload_sentinels': 'SURCHARGE',
                'negotiate_laxmi': 'NÉGOCIATION',
                'checkpoint_47': 'POINT DE CONTRÔLE',
                'border_crossing': 'FRONTIÈRE',
                'truth_revealed': 'VÉRITÉ',
                'carols_signal': 'SIGNAL',
                'abandoned_trucks': 'CAMIONS',
                'alliance_proposal': 'ALLIANCE',
                'escape_checkpoint': 'FUITE',
                'end_chapter1': 'FIN CHAPITRE 1'
            };
            return chapterNames[chapterKey] || chapterKey.toUpperCase();
        }
        
        function saveGame() {
            const saveData = {
                version: 1.0,
                timestamp: new Date().toISOString(),
                gameState: {
                    ...gameState,
                    visitedChapters: Array.from(gameState.visitedChapters)
                }
            };
            
            try {
                localStorage.setItem('pluribusSave', JSON.stringify(saveData));
                showMessage('PARTIE SAUVEGARDÉE', 1500);
            } catch (e) {
                console.error('Erreur de sauvegarde:', e);
            }
        }
        
        function loadGame() {
            try {
                const saveData = JSON.parse(localStorage.getItem('pluribusSave'));
                
                if (saveData && saveData.gameState) {
                    gameState = { ...saveData.gameState };
                    gameState.visitedChapters = new Set(gameState.visitedChapters || ["start"]);
                    
                    document.getElementById('player-name').textContent = gameState.playerName;
                    updateStats();
                    updateGame(gameState.currentChapter);
                    
                    showMessage('PARTIE CHARGÉE', 1500);
                    return true;
                }
            } catch (e) {
                console.error('Erreur de chargement:', e);
            }
            
            return false;
        }
        
        function resetGame() {
            if (confirm('RECOMMENCER UNE NOUVELLE PARTIE ?\n\nPROGRESSION ACTUELLE PERDUE.')) {
                gameState = {
                    playerName: "INCONNU",
                    currentChapter: "start",
                    sync: 0,
                    health: 100,
                    xp: 0,
                    alignment: "neutral",
                    alignmentScore: 0,
                    skills: { hack: 0, resist: 0, tech: 0 },
                    skillPoints: 0,
                    inventory: ["Pass Navigo"],
                    visitedChapters: new Set(["start"]),
                    choicesHistory: []
                };
                
                document.getElementById('player-name').textContent = "INCONNU";
                updateStats();
                updateGame("start");
                
                showMessage('NOUVELLE PARTIE COMMENCÉE', 2000);
            }
        }
        
        document.addEventListener('DOMContentLoaded', initGame);
        
        window.addEventListener('beforeunload', (e) => {
            saveGame();
        });
        
        window.addEventListener('popstate', (e) => {
            history.pushState(null, null, window.location.pathname);
        });
        
        history.pushState(null, null, window.location.pathname);
    </script>
</body>
  </html>
