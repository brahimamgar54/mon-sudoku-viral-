<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SUDOKU OR DIE</title>
    <style>
        :root { --blood: #800; --active: #f00; }
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; touch-action: none; }
        body { background: #000; color: #555; font-family: 'Courier New', monospace; margin: 0; overflow: hidden; height: 100vh; display: flex; flex-direction: column; align-items: center; }
        
        /* EFFET VISUEL */
        #vignette { position: fixed; inset: 0; background: radial-gradient(circle, transparent 40%, black 100%); pointer-events: none; z-index: 5; }
        
        #dialogue-zone { width: 100%; height: 100px; display: flex; align-items: center; justify-content: center; padding: 10px; text-align: center; z-index: 10; border-bottom: 1px solid #111; }
        #text-content { color: var(--active); font-size: 1.1rem; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; }

        /* JEU */
        .timer-wrap { width: 100%; height: 6px; background: #050505; }
        #timer-bar { width: 0%; height: 100%; background: var(--blood); transition: width 0.1s linear; box-shadow: 0 0 10px var(--active); }

        #grid { display: grid; grid-template-columns: repeat(9, 1fr); width: 95vw; height: 95vw; max-width: 380px; max-height: 380px; background: #111; border: 2px solid #000; margin: 10px 0; }
        .tile { background: #000; border: 0.5px solid #111; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: #fff; transition: 0.1s; }
        .tile.fixed { color: #333; }
        .tile.selected { background: #1a0000; outline: 1px solid var(--blood); color: var(--active); }
        .tile.err { animation: shake 0.2s; background: #300; }

        @keyframes shake { 0%, 100% {transform:translateX(0)} 25% {transform:translateX(-5px)} 75% {transform:translateX(5px)} }

        .keys { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; width: 95%; max-width: 380px; }
        .key { background: #0a0a0a; border: 1px solid #222; color: #666; padding: 18px 0; font-size: 1.4rem; border-radius: 4px; text-align: center; }
        .key:active { background: var(--blood); color: #fff; }

        /* START SCREEN */
        #menu { position: fixed; inset: 0; background: #000; z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #start-btn { background: none; border: 1px solid var(--blood); color: var(--blood); padding: 15px 40px; font-size: 1.2rem; cursor: pointer; margin-top: 30px; letter-spacing: 3px; }
        #name-in { background: none; border: none; border-bottom: 2px solid #333; color: #fff; font-size: 1.5rem; text-align: center; outline: none; }
    </style>
</head>
<body>

<div id="vignette"></div>

<div id="menu">
    <h1 style="color:var(--blood); letter-spacing: 5px;">SUDOKU OR DIE</h1>
    <input type="text" id="name-in" placeholder="TON NOM..." maxlength="12">
    <button id="start-btn" onclick="boot()">OFFRIR MON ÂME</button>
</div>

<div id="dialogue-zone"><div id="text-content">...</div></div>
<div class="timer-wrap"><div id="timer-bar"></div></div>
<div id="grid"></div>
<div class="keys">
    <script>for(let i=1; i<=9; i++) document.write(`<div class="key" onclick="hit(${i})">${i}</div>`);</script>
    <div class="key" onclick="hit(0)" style="color:var(--blood)">X</div>
</div>

<script>
    let pName = "";
    let cur = null;
    let threat = 0;
    let level = 1;
    let active = false;
    let speechLock = false;
    let sol = [];

    // --- DIALOGUES ---
    const reactions = {
        intro: ["Bienvenue [N], j'espère que tu ne vas pas mourir trop vite...", "Tiens tiens, une nouvelle proie nommée [N].", "Prépare-toi à souffrir, [N]."],
        error: ["Tu ne sais pas jouer mon petit [N] ?", "Bah alors [N], on pue la merde à ce point ?", "Encore une erreur ? Hahaha continue comme ça j'adore, [N].", "Tu veux que je te mange tout de suite, [N] ?", "Même un cadavre jouerait mieux que toi, [N]."],
        idle: ["Bah quoi, tu trembles déjà de peur [N] ?", "Alors [N], on est perdu dans ses chiffres ?", "Le temps presse, [N]. Ma faim aussi.", "Je te regarde galérer, [N], c'est un délice."],
        win: ["Putain tu as passé le niveau [L], tu as eu de la chance [N].", "Ne t'habitue pas à gagner, [N].", "Le niveau suivant va te broyer, [N]."],
        desperate: ["J'ai faim... perd s'il te plaît que je puisse te manger, [N].", "Laisse-toi aller, [N]. La mort est si proche.", "Ta sueur a un goût exquis, [N]."]
    };

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    
    function boot() {
        pName = document.getElementById('name-in').value || "Mortel";
        document.getElementById('menu').style.display = 'none';
        active = true;
        audioCtx.resume();
        setup();
        loop();
        heartbeat();
        say('intro');
    }

    // --- AUDIO DESIGN ---
    function playSfx(freq, type, dur, vol) {
        const osc = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        g.gain.setValueAtTime(vol, audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + dur);
        osc.connect(g);
        g.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + dur);
    }

    function heartbeat() {
        if(!active) return;
        // Son de respiration + Tic Tac
        playSfx(60, 'sine', 0.1, 0.5); // Kick (Cœur)
        setTimeout(() => playSfx(40, 'sine', 0.1, 0.3), 200); 
        playSfx(1000, 'square', 0.01, 0.05); // Tic-Tac horloge
        
        let speed = Math.max(300, 1200 - (threat * 8));
        setTimeout(heartbeat, speed);
    }

    function setup() {
        const g = document.getElementById('grid'); g.innerHTML = '';
        let base = "534678912672195348198342567859761423426853791713924856961537284287419635345286179".split('');
        sol = base;
        let fill = Math.max(78 - (level * 10), 10);
        for(let i=0; i<81; i++) {
            let t = document.createElement('div');
            t.className = 'tile';
            if(Math.random() * 81 < fill) { t.innerText = sol[i]; t.classList.add('fixed'); }
            t.onclick = () => { if(!t.classList.contains('fixed')) { if(cur) cur.classList.remove('selected'); cur = t; t.classList.add('selected'); playSfx(200, 'triangle', 0.05, 0.1); } };
            g.appendChild(t);
        }
    }

    function hit(n) {
        if(!cur || !active) return;
        let idx = Array.from(document.getElementById('grid').children).indexOf(cur);
        if(n === 0) { cur.innerText = ""; return; }
        
        cur.innerText = n;
        if(n != sol[idx]) {
            cur.classList.add('err');
            threat += 12;
            playSfx(100, 'sawtooth', 0.3, 0.2); // Son erreur
            say('error');
            setTimeout(() => cur.classList.remove('err'), 300);
        } else {
            cur.style.color = "#0f0";
            playSfx(800, 'sine', 0.05, 0.1); // Son correct
            check();
        }
    }

    function say(type) {
        if(speechLock) return;
        speechLock = true;
        let list = reactions[type];
        let t = list[Math.floor(Math.random()*list.length)]
            .replace("[N]", pName).replace("[L]", level);
        
        document.getElementById('text-content').innerText = t;
        
        window.speechSynthesis.cancel();
        let m = new SpeechSynthesisUtterance(t);
        m.lang = 'fr-FR'; m.pitch = 0.1; m.rate = 0.8;
        window.speechSynthesis.speak(m);
        
        setTimeout(() => { speechLock = false; }, 3000); // Pause de 3s forcée
    }

    function loop() {
        if(!active) return;
        threat += (0.15 * level);
        document.getElementById('timer-bar').style.width = threat + "%";

        if(Math.random() < 0.01) say(threat > 70 ? 'desperate' : 'idle');

        if(threat >= 100) die();
        else setTimeout(loop, 100);
    }

    function check() {
        let tiles = document.querySelectorAll('.tile');
        let win = true;
        tiles.forEach((t, i) => { if(t.innerText != sol[i]) win = false; });
        if(win) {
            say('win');
            level++; threat = Math.max(0, threat - 50);
            setTimeout(setup, 2000);
        }
    }

    function die() {
        active = false;
        playSfx(40, 'sawtooth', 2, 0.5);
        document.body.innerHTML = `<h1 style="color:red; margin-top:40vh; text-align:center; font-size:1.2rem;">${pName.toUpperCase()} A ÉTÉ DÉVORÉ</h1>`;
        let m = new SpeechSynthesisUtterance("Enfin... tu es délicieux " + pName);
        m.pitch = 0.1; window.speechSynthesis.speak(m);
        setTimeout(() => location.reload(), 5000);
    }
</script>
</body>
</html>
