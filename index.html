<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>SOUL TRAP: FINAL</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');

        /* --- RESET & BASES --- */
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            touch-action: manipulation;
            margin: 0;
            padding: 0;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        body {
            background: #000000;
            color: #00ff00;
            font-family: 'VT323', monospace;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0;
            animation: fadeIn 2s forwards;
        }

        @keyframes fadeIn {
            to { opacity: 1; }
        }

        /* --- ANIMATION INTRO --- */
        #intro-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .glitch {
            font-size: 4rem;
            color: #00ff00;
            text-shadow: 
                0.05em 0 0 #ff0000,
                -0.03em -0.04em 0 #0000ff,
                0.025em 0.04em 0 #ffff00;
            animation: glitch 725ms infinite;
        }

        @keyframes glitch {
            0% { transform: translate(0); }
            20% { transform: translate(-2px, 2px); }
            40% { transform: translate(-2px, -2px); }
            60% { transform: translate(2px, 2px); }
            80% { transform: translate(2px, -2px); }
            100% { transform: translate(0); }
        }

        .typewriter {
            font-size: 1.5rem;
            margin-top: 2rem;
            overflow: hidden;
            white-space: nowrap;
            border-right: 0.15em solid #00ff00;
            animation: typing 3.5s steps(40, end), blink-caret 0.75s step-end infinite;
        }

        @keyframes typing {
            from { width: 0 }
            to { width: 100% }
        }

        @keyframes blink-caret {
            from, to { border-color: transparent }
            50% { border-color: #00ff00; }
        }

        /* --- ANIMATION MORT --- */
        .death-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 9998;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .blood-drip {
            position: absolute;
            top: 0;
            left: 50%;
            width: 2px;
            height: 0;
            background: linear-gradient(to bottom, transparent, #ff0000 70%, #880000);
            animation: drip 2s forwards;
        }

        @keyframes drip {
            to { height: 100%; }
        }

        /* --- INTERFACE PRINCIPALE --- */
        #ui-layer {
            width: 100%;
            max-width: 500px;
            height: 100%;
            display: none;
            flex-direction: column;
            justify-content: space-between;
            padding: 15px;
            position: relative;
            z-index: 10;
        }

        /* En-tête avec timer */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.2rem;
            margin-bottom: 10px;
        }

        .timer {
            font-size: 1.5rem;
            color: #ff5555;
            text-shadow: 0 0 10px #ff0000;
        }

        /* Barre de temps */
        .time-container {
            width: 100%;
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        #time-bar {
            height: 100%;
            width: 100%;
            background: linear-gradient(90deg, #00ff00, #ffff00, #ff0000);
            transition: width 0.5s linear;
        }

        /* Dialogue du démon */
        #demon-box {
            min-height: 100px;
            border: 2px solid #00ff00;
            background: rgba(0,0,0,0.9);
            padding: 15px;
            margin: 10px 0;
            text-align: center;
            font-size: 1.4rem;
            line-height: 1.3;
            text-shadow: 0 0 10px #00ff00;
            box-shadow: 0 0 20px rgba(0,255,0,0.2);
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Grille Sudoku */
        #grid-container {
            width: 100%;
            aspect-ratio: 1;
            max-width: 450px;
            margin: 0 auto;
            padding: 2px;
            background: #00ff00;
            border-radius: 3px;
            box-shadow: 0 0 30px rgba(0,255,0,0.3);
        }

        #grid {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            grid-template-rows: repeat(9, 1fr);
            gap: 1px;
            width: 100%;
            height: 100%;
            background: #00ff00;
        }

        .cell {
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.6rem;
            cursor: pointer;
            color: #fff;
            transition: all 0.2s;
        }

        .cell.fixed {
            color: #00ff00;
            opacity: 0.8;
            pointer-events: none;
        }

        .cell.selected {
            background: #00ff00;
            color: #000;
            transform: scale(0.95);
            box-shadow: 0 0 15px #00ff00;
        }

        .cell.correct {
            background: #00aa00;
            animation: pulse 0.3s;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(0.9); }
            100% { transform: scale(1); }
        }

        .cell.wrong {
            background: #ff0000;
            color: white;
            animation: shake 0.3s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-3px); }
            75% { transform: translateX(3px); }
        }

        /* Clavier */
        #keypad {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-top: 15px;
            padding: 10px;
            background: rgba(0,0,0,0.5);
            border-radius: 10px;
        }

        .key {
            height: 50px;
            border: 2px solid #00ff00;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            background: rgba(0,0,0,0.3);
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.1s;
        }

        .key:active {
            background: #00ff00;
            color: #000;
            transform: scale(0.92);
        }

        .key.clear {
            color: #ff0000;
            border-color: #ff0000;
        }

        /* Overlay de questions */
        #question-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 1000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
        }

        .question-text {
            font-size: 2rem;
            margin-bottom: 30px;
            line-height: 1.4;
            text-shadow: 0 0 10px #00ff00;
        }

        .answer-input {
            width: 80%;
            max-width: 300px;
            background: transparent;
            border: none;
            border-bottom: 2px solid #00ff00;
            color: #fff;
            font-family: inherit;
            font-size: 2rem;
            text-align: center;
            margin-top: 20px;
            padding: 10px;
            outline: none;
            text-transform: uppercase;
        }

        .submit-btn {
            margin-top: 40px;
            padding: 15px 40px;
            background: rgba(0,0,0,0.8);
            color: #00ff00;
            border: 2px solid #00ff00;
            font-family: inherit;
            font-size: 1.5rem;
            cursor: pointer;
            border-radius: 5px;
        }

        /* Responsive */
        @media (max-height: 700px) {
            #demon-box { min-height: 80px; font-size: 1.2rem; }
            .cell { font-size: 1.4rem; }
            .key { height: 45px; font-size: 1.6rem; }
        }

        @media (max-width: 400px) {
            .header { font-size: 1rem; }
            .timer { font-size: 1.3rem; }
            #demon-box { font-size: 1.2rem; padding: 10px; }
            .cell { font-size: 1.4rem; }
            .key { height: 40px; font-size: 1.5rem; }
        }
    </style>
</head>
<body>

<!-- Écran d'introduction -->
<div id="intro-screen">
    <div class="glitch">SOUL TRAP</div>
    <div class="typewriter">LA PARTIE VA COMMENCER...</div>
</div>

<!-- Écran de mort -->
<div id="death-screen" class="death-screen">
    <div class="blood-drip"></div>
    <div id="death-message" style="font-size: 3rem; color: #ff0000; margin-top: 2rem;"></div>
    <div id="death-subtitle" style="font-size: 1.5rem; margin-top: 1rem; color: #aaa;"></div>
</div>

<!-- Overlay de questions -->
<div id="question-overlay">
    <div id="question-text" class="question-text"></div>
    <input type="text" id="answer-input" class="answer-input" autocomplete="off">
    <button id="submit-answer" class="submit-btn">RÉPONDRE</button>
</div>

<!-- Interface principale -->
<div id="ui-layer">
    <!-- En-tête -->
    <div class="header">
        <div>NIV <span id="level-display">1</span>/100</div>
        <div class="timer" id="timer">60.0</div>
    </div>

    <!-- Barre de temps -->
    <div class="time-container">
        <div id="time-bar"></div>
    </div>

    <!-- Dialogue du démon -->
    <div id="demon-box">INITIALISATION...</div>

    <!-- Grille Sudoku -->
    <div id="grid-container">
        <div id="grid"></div>
    </div>

    <!-- Clavier -->
    <div id="keypad">
        <div class="key" onclick="GAME.input(1)">1</div>
        <div class="key" onclick="GAME.input(2)">2</div>
        <div class="key" onclick="GAME.input(3)">3</div>
        <div class="key" onclick="GAME.input(4)">4</div>
        <div class="key" onclick="GAME.input(5)">5</div>
        <div class="key" onclick="GAME.input(6)">6</div>
        <div class="key" onclick="GAME.input(7)">7</div>
        <div class="key" onclick="GAME.input(8)">8</div>
        <div class="key" onclick="GAME.input(9)">9</div>
        <div class="key clear" onclick="GAME.input('X')">X</div>
    </div>
</div>

<script>
// ============================================================================
// BASE DE DONNÉES DE DIALOGUES (100+ PHRASES)
// ============================================================================

const DEMON_DIALOGUES = {
    // Dialogues de début de niveau
    start: [
        "NOUS COMMENÇONS, {name}.",
        "PRÊT À SOUFFRIR, {name} ?",
        "REGARDE-MOI BIEN, {name}.",
        "TA PEUR M'ALIMENTE, {name}.",
        "NE CLIGNE PAS DES YEUX, {name}.",
        "JE TE SENS TREMBLER, {name}.",
        "C'EST POUR TOI, {name}.",
        "CONCENTRE-TOI, {name}.",
        "LE TEMPS PRESSE, {name}.",
        "REGARDE LA GRILLE, {name}."
    ],
    
    // Quand le joueur réussit une case
    correct: [
        "BIEN, {name}. CONTINUE.",
        "UNE DE MOINS, {name}.",
        "TU PROGRESSES, {name}.",
        "NE T'ARRÊTE PAS, {name}.",
        "EN CORE, {name}.",
        "TU APPRENDS, {name}.",
        "C'EST ÇA, {name}.",
        "NE RELÂCHE PAS, {name}.",
        "TU ES SUR LA BONNE VOIE, {name}.",
        "LE TEMPS RALENTIT, {name}."
    ],
    
    // Quand le joueur se trompe
    wrong: [
        "ERREUR, {name} !",
        "STUPIDE, {name} !",
        "TU ES NUL, {name} !",
        "REGARDE CE QUE TU FAIS, {name} !",
        "LE TEMPS ACCÉLÈRE, {name} !",
        "TU VAS MOURIR, {name} !",
        "ENCORE, {name} !",
        "FAIS ATTENTION, {name} !",
        "TU ME DÉÇOIS, {name} !",
        "CONCENTRE-TOI, {name} !"
    ],
    
    // Quand le temps est bas
    timeLow: [
        "LE TEMPS FILE, {name}.",
        "DÉPÊCHE-TOI, {name}.",
        "TU VAS MOURIR, {name}.",
        "C'EST LA FIN, {name}.",
        "REGARDE LE TEMPS, {name}.",
        "TROP LENT, {name}.",
        "ACCÉLÈRE, {name}.",
        "TU N'Y ARRIVERAS PAS, {name}.",
        "C'EST PRESQUE FINI, {name}.",
        "DERNIÈRE CHANCE, {name}."
    ],
    
    // Dialogues aléatoires pendant le jeu
    random: [
        "JE TE VOIS, {name}.",
        "TES MAINS TREMBLENT, {name}.",
        "TU AS PEUR, {name} ?",
        "POURQUOI TU CONTINUES, {name} ?",
        "TU SAIS QUE TU VAS MOURIR, {name}.",
        "ABANDONNE, {name}.",
        "C'EST INUTILE, {name}.",
        "TU ES PIÉGÉ, {name}.",
        "PERSONNE NE VIENDRA, {name}.",
        "TU ES SEUL, {name}.",
        "JE SUIS TON SEUL PUBLIC, {name}.",
        "CRIE SI TU VEUX, {name}.",
        "PERSONNE N'ENTENDRA, {name}.",
        "TROP TARD POUR TOI, {name}.",
        "REGARDE-MOI DANS LES YEUX, {name}.",
        "NE DÉTOURNE PAS LE REGARD, {name}.",
        "JE SUIS DANS TA TÊTE, {name}.",
        "JE CONNAIS TES PEURS, {name}.",
        "TU NE SORTIRAS PAS, {name}.",
        "C'EST TON DESTIN, {name}."
    ],
    
    // Dialogues avec la peur de mourir
    fear: [
        "TU AS PEUR DE MOURIR, {name} ?",
        "LA MORT T'ATTEND, {name}.",
        "TU VAS MOURIR ICI, {name}.",
        "C'EST TA FIN, {name}.",
        "DIS ADIEU, {name}.",
        "PRIE SI TU VEUX, {name}.",
        "PERSONNE NE TE SAUVERA, {name}.",
        "ACCEPTE TON SORT, {name}.",
        "LA MORT EST DOUCE, {name}.",
        "LAISSE-TOI ALLER, {name}."
    ],
    
    // Dialogues sur la croyance
    belief: [
        "TU CROIS EN QUELQUE CHOSE, {name} ?",
        "PRIE TON DIEU, {name}.",
        "IL NE T'ENTEND PAS, {name}.",
        "TU ES ABANDONNÉ, {name}.",
        "C'EST TON ENFER, {name}.",
        "PÉCHÉS ET CHÂTIMENTS, {name}.",
        "TU MÉRITES ÇA, {name}.",
        "PAS DE SALUT POUR TOI, {name}.",
        "LE DIABLE T'ATTEND, {name}.",
        "BRÛLE AVEC MOI, {name}."
    ],
    
    // Dialogues sur la personne aimée
    loved: [
        "TU PENSES À {loved}, {name} ?",
        "{loved} T'OUBLIE, {name}.",
        "{loved} SERAIT DÉÇU, {name}.",
        "TU FAIS ÇA POUR {loved}, {name} ?",
        "{loved} NE TE RECONNAÎTRAIT PAS, {name}.",
        "ABANDONNE POUR {loved}, {name}.",
        "{loved} PLEURERA TA MORT, {name}.",
        "TU MANQUERAS À {loved}, {name}.",
        "{loved} TE HAIT, {name}.",
        "TU AS TRAHI {loved}, {name}."
    ],
    
    // Dialogues sur la tristesse
    sadness: [
        "TU ES TRISTE, {name} ?",
        "PLEURE SI TU VEUX, {name}.",
        "TES LARMES ME NOURRISSENT, {name}.",
        "TRISTE PETIT {name}.",
        "JOIE OU TRISTESSE, {name} ?",
        "SOURIS UNE DERNIÈRE FOIS, {name}.",
        "TON CHAGRIN M'AMUSE, {name}.",
        "CRIE TA DOULEUR, {name}.",
        "TU ES SEUL DANS TA TRISTESSE, {name}.",
        "PERSONNE NE TE CONSOLERA, {name}."
    ]
};

// ============================================================================
// MOTEUR DE JEU
// ============================================================================

const GAME = {
    // État du jeu
    level: 1,
    timeLeft: 60.0,
    baseTime: 60.0,
    isActive: false,
    selectedCell: null,
    grid: [],
    solution: [],
    gameLoopInterval: null,
    dialogueCounter: 0,
    
    // Profil du joueur
    player: {
        name: "",
        fearsDeath: false,
        isBeliever: false,
        lovedOne: "",
        isSad: false
    },
    
    // Questions
    questions: [
        { text: "C'EST QUOI TON NOM ?", key: "name" },
        { text: "TU AS PEUR DE MOURIR ? (OUI/NON)", key: "fearsDeath" },
        { text: "EST-TU CROYANT ? (OUI/NON)", key: "isBeliever" },
        { text: "QUI EST LA PERSONNE QUE TU AIMES LE PLUS ?", key: "lovedOne" },
        { text: "EST-CE QUE TU ES TRISTE ? (OUI/NON)", key: "isSad" }
    ],
    
    // Initialisation
    init() {
        // Cacher l'intro après 3 secondes
        setTimeout(() => {
            document.getElementById('intro-screen').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('intro-screen').style.display = 'none';
                this.startQuestions();
            }, 1000);
        }, 3000);
    },
    
    // Questions au joueur
    startQuestions() {
        document.getElementById('question-overlay').style.display = 'flex';
        this.currentQuestionIndex = 0;
        this.askQuestion();
        
        // Configurer le bouton de soumission
        document.getElementById('submit-answer').onclick = () => this.submitAnswer();
        document.getElementById('answer-input').onkeypress = (e) => {
            if (e.key === 'Enter') this.submitAnswer();
        };
    },
    
    askQuestion() {
        const question = this.questions[this.currentQuestionIndex];
        document.getElementById('question-text').textContent = question.text;
        document.getElementById('answer-input').value = '';
        document.getElementById('answer-input').focus();
    },
    
    submitAnswer() {
        const input = document.getElementById('answer-input');
        const answer = input.value.trim().toUpperCase();
        
        if (!answer) return;
        
        const question = this.questions[this.currentQuestionIndex];
        
        // Traiter la réponse selon la question
        switch(question.key) {
            case 'name':
                this.player.name = answer;
                break;
            case 'fearsDeath':
                this.player.fearsDeath = (answer === 'OUI' || answer === 'YES');
                break;
            case 'isBeliever':
                this.player.isBeliever = (answer === 'OUI' || answer === 'YES');
                break;
            case 'lovedOne':
                this.player.lovedOne = answer;
                break;
            case 'isSad':
                this.player.isSad = (answer === 'OUI' || answer === 'YES');
                break;
        }
        
        // Passer à la question suivante
        this.currentQuestionIndex++;
        
        if (this.currentQuestionIndex < this.questions.length) {
            this.askQuestion();
        } else {
            // Toutes les questions sont répondues
            this.startGame();
        }
    },
    
    // Démarrage du jeu
    startGame() {
        document.getElementById('question-overlay').style.display = 'none';
        document.getElementById('ui-layer').style.display = 'flex';
        
        // Premier dialogue avec le nom
        this.speakDemon(this.getDialogue('start'), true);
        
        // Démarrer le niveau
        this.startLevel();
    },
    
    // Démarrage d'un niveau
    startLevel() {
        // Réinitialiser le temps
        this.timeLeft = this.baseTime - (this.level * 0.5);
        if (this.timeLeft < 30) this.timeLeft = 30;
        
        // Mettre à jour l'affichage
        document.getElementById('level-display').textContent = this.level;
        document.getElementById('timer').textContent = this.timeLeft.toFixed(1);
        document.getElementById('time-bar').style.width = '100%';
        
        // Générer la grille
        this.generateSudoku();
        this.renderGrid();
        
        // Démarrer la boucle de jeu
        this.isActive = true;
        this.startGameLoop();
        
        // Dialogue de début
        setTimeout(() => {
            this.speakDemon(this.getDialogue('start'));
        }, 1000);
    },
    
    // Boucle de jeu principale
    startGameLoop() {
        if (this.gameLoopInterval) clearInterval(this.gameLoopInterval);
        
        this.gameLoopInterval = setInterval(() => {
            if (!this.isActive) return;
            
            // Réduire le temps
            this.timeLeft -= 0.1;
            
            // Mettre à jour l'affichage
            document.getElementById('timer').textContent = this.timeLeft.toFixed(1);
            document.getElementById('time-bar').style.width = (this.timeLeft / this.baseTime * 100) + '%';
            
            // Dialogues quand le temps est bas
            if (this.timeLeft < 10 && Math.random() < 0.1) {
                this.speakDemon(this.getDialogue('timeLow'));
            }
            
            // Dialogues aléatoires
            if (Math.random() < 0.05) {
                this.speakDemon(this.getDialogue('random'));
            }
            
            // Game over si temps écoulé
            if (this.timeLeft <= 0) {
                this.gameOver("LE TEMPS EST ÉCOULÉ");
            }
        }, 100);
    },
    
    // Génération Sudoku
    generateSudoku() {
        // Générer une solution
        this.solution = Array(81).fill(0);
        this.fillGrid(this.solution);
        
        // Créer la grille avec des trous
        this.grid = [...this.solution];
        const holes = Math.min(60, 20 + Math.floor(this.level * 0.4));
        
        for (let i = 0; i < holes; i++) {
            const randomIndex = Math.floor(Math.random() * 81);
            this.grid[randomIndex] = 0;
        }
    },
    
    fillGrid(grid) {
        for (let i = 0; i < 81; i++) {
            if (grid[i] === 0) {
                const numbers = [1,2,3,4,5,6,7,8,9].sort(() => Math.random() - 0.5);
                
                for (const num of numbers) {
                    if (this.isValid(grid, i, num)) {
                        grid[i] = num;
                        if (this.fillGrid(grid)) return true;
                        grid[i] = 0;
                    }
                }
                return false;
            }
        }
        return true;
    },
    
    isValid(grid, index, value) {
        const row = Math.floor(index / 9);
        const col = index % 9;
        
        // Vérifier la ligne
        for (let i = 0; i < 9; i++) {
            if (grid[row * 9 + i] === value) return false;
        }
        
        // Vérifier la colonne
        for (let i = 0; i < 9; i++) {
            if (grid[i * 9 + col] === value) return false;
        }
        
        // Vérifier le bloc 3x3
        const blockRow = Math.floor(row / 3) * 3;
        const blockCol = Math.floor(col / 3) * 3;
        
        for (let i = 0; i < 3; i++) {
            for (let j = 0; j < 3; j++) {
                if (grid[(blockRow + i) * 9 + (blockCol + j)] === value) return false;
            }
        }
        
        return true;
    },
    
    // Rendu de la grille
    renderGrid() {
        const gridElement = document.getElementById('grid');
        gridElement.innerHTML = '';
        
        for (let i = 0; i < 81; i++) {
            const cell = document.createElement('div');
            cell.className = 'cell';
            
            if (this.grid[i] !== 0) {
                cell.textContent = this.grid[i];
                cell.classList.add('fixed');
            }
            
            // Gestion des clics
            if (this.grid[i] === 0) {
                cell.onclick = () => {
                    // Désélectionner toutes les cellules
                    document.querySelectorAll('.cell').forEach(c => c.classList.remove('selected'));
                    
                    // Sélectionner cette cellule
                    cell.classList.add('selected');
                    this.selectedCell = i;
                };
            }
            
            gridElement.appendChild(cell);
        }
    },
    
    // Gestion des entrées
    input(value) {
        if (!this.isActive || this.selectedCell === null) return;
        
        const cellElement = document.getElementById('grid').children[this.selectedCell];
        
        if (value === 'X') {
            // Effacer
            cellElement.textContent = '';
            cellElement.classList.remove('wrong');
            this.grid[this.selectedCell] = 0;
            return;
        }
        
        // Vérifier si la réponse est correcte
        if (value === this.solution[this.selectedCell]) {
            // BONNE RÉPONSE
            cellElement.textContent = value;
            cellElement.classList.add('fixed', 'correct');
            cellElement.classList.remove('selected', 'wrong');
            this.grid[this.selectedCell] = value;
            this.selectedCell = null;
            
            // Ajouter du temps
            this.timeLeft += 2.0;
            if (this.timeLeft > this.baseTime) this.timeLeft = this.baseTime;
            
            // Dialogue
            this.speakDemon(this.getDialogue('correct'));
            
            // Vérifier si la grille est complète
            if (!this.grid.includes(0)) {
                this.levelComplete();
            }
            
            // Animation
            setTimeout(() => {
                cellElement.classList.remove('correct');
            }, 300);
            
        } else {
            // MAUVAISE RÉPONSE
            this.timeLeft -= 5.0;
            
            cellElement.textContent = value;
            cellElement.classList.add('wrong');
            
            // Dialogue
            this.speakDemon(this.getDialogue('wrong'));
            
            // Animation
            setTimeout(() => {
                cellElement.classList.remove('wrong');
                cellElement.textContent = '';
            }, 500);
        }
    },
    
    // Dialogue du démon
    speakDemon(dialogueKey, force = false) {
        this.dialogueCounter++;
        
        // Changer de catégorie tous les 3-4 dialogues
        let category = dialogueKey;
        if (!force && this.dialogueCounter % 4 === 0) {
            const categories = ['fear', 'belief', 'loved', 'sadness', 'random'];
            category = categories[Math.floor(Math.random() * categories.length)];
        }
        
        // Obtenir un dialogue aléatoire dans la catégorie
        const dialogues = DEMON_DIALOGUES[category];
        let dialogue = dialogues[Math.floor(Math.random() * dialogues.length)];
        
        // Remplacer les variables
        dialogue = dialogue.replace(/{name}/g, this.player.name);
        dialogue = dialogue.replace(/{loved}/g, this.player.lovedOne);
        
        // Afficher le dialogue
        document.getElementById('demon-box').textContent = dialogue;
        
        // Synthèse vocale
        this.speak(dialogue);
    },
    
    getDialogue(category) {
        return category;
    },
    
    // Synthèse vocale
    speak(text) {
        if (!window.speechSynthesis) return;
        
        window.speechSynthesis.cancel();
        
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'fr-FR';
        utterance.rate = 0.9;
        utterance.pitch = 0.7;
        utterance.volume = 1;
        
        window.speechSynthesis.speak(utterance);
    },
    
    // Niveau terminé
    levelComplete() {
        this.isActive = false;
        clearInterval(this.gameLoopInterval);
        
        setTimeout(() => {
            this.level++;
            
            if (this.level > 100) {
                this.gameOver("VOUS AVEZ GAGNÉ", true);
                return;
            }
            
            // Dialogue de félicitations
            this.speakDemon(this.getDialogue('correct'));
            
            // Nouveau niveau
            setTimeout(() => {
                this.startLevel();
            }, 2000);
        }, 1000);
    },
    
    // Game over
    gameOver(reason, isWin = false) {
        this.isActive = false;
        clearInterval(this.gameLoopInterval);
        
        // Message de mort
        let deathMessage = "";
        let subtitle = "";
        
        if (isWin) {
            deathMessage = "LIBÉRATION";
            subtitle = "Vous avez vaincu le démon";
        } else {
            deathMessage = "MORT";
            subtitle = reason;
            
            // Messages selon les réponses du joueur
            if (this.player.fearsDeath) {
                subtitle = "Votre peur s'est réalisée";
            }
            if (this.player.isBeliever) {
                subtitle = "Vos prières n'ont pas été entendues";
            }
            if (this.player.isSad) {
                subtitle = "Votre tristesse vous a consumé";
            }
        }
        
        // Afficher l'écran de mort
        document.getElementById('death-message').textContent = deathMessage;
        document.getElementById('death-subtitle').textContent = subtitle;
        document.getElementById('death-screen').style.display = 'flex';
        
        // Dernier message du démon
        const finalWords = [
            `AU REVOIR, ${this.player.name}.`,
            `C'ÉTAIT INÉVITABLE, ${this.player.name}.`,
            `JE T'ATTENDRAI, ${this.player.name}.`,
            `TU ES À MOI, ${this.player.name}.`,
            `FIN DU JEU, ${this.player.name}.`
        ];
        
        const finalMessage = finalWords[Math.floor(Math.random() * finalWords.length)];
        this.speak(finalMessage);
        
        // Redémarrer après 5 secondes
        setTimeout(() => {
            location.reload();
        }, 5000);
    }
};

// ============================================================================
// DÉMARRAGE
// ============================================================================

// Démarrer le jeu
window.onload = () => {
    GAME.init();
};

// Gestion du clavier physique (pour ordinateur)
document.addEventListener('keydown', (e) => {
    if (!GAME.isActive || !GAME.selectedCell) return;
    
    const key = e.key;
    
    if (key >= '1' && key <= '9') {
        GAME.input(parseInt(key));
    } else if (key === 'Backspace' || key === 'Delete') {
        GAME.input('X');
    }
});
</script>
</body>
    </html>
