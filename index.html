<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SOUL TRAP: VOID</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Special+Elite&display=swap');

        :root {
            --bg: #050000;
            --primary: #ffffff;
            --accent: #ff0000;
            --dark-red: #660000;
        }

        * { box-sizing: border-box; touch-action: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: var(--bg);
            color: var(--primary);
            font-family: 'Special Elite', serif;
            margin: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* --- EFFET CRT & SCANLINES --- */
        body::before {
            content: " ";
            display: block;
            position: absolute;
            top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), 
                        linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 100;
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
        }

        /* --- INTERFACE --- */
        #game-container {
            width: 100%;
            max-width: 450px;
            padding: 20px;
            display: none;
            flex-direction: column;
            gap: 20px;
            z-index: 10;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid var(--accent);
            padding-bottom: 5px;
            font-size: 1.2rem;
            text-shadow: 0 0 5px var(--accent);
        }

        #demon-thought {
            height: 60px;
            text-align: center;
            font-style: italic;
            color: var(--primary);
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s;
        }

        /* --- GRILLE --- */
        #grid {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            gap: 1px;
            background: var(--dark-red);
            border: 2px solid var(--accent);
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.2);
        }

        .cell {
            aspect-ratio: 1;
            background: var(--bg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .cell.fixed { color: var(--accent); font-weight: bold; }
        .cell.selected { background: var(--dark-red); color: white; }
        .cell.error { animation: flashRed 0.3s; }

        @keyframes flashRed {
            0% { background: red; }
            100% { background: var(--bg); }
        }

        /* --- CLAVIER --- */
        #keypad {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
        }

        .key {
            padding: 15px 0;
            border: 1px solid var(--primary);
            text-align: center;
            cursor: pointer;
            background: transparent;
            color: var(--primary);
        }

        .key:active { background: var(--primary); color: var(--bg); }

        /* --- SCREENS --- */
        .overlay {
            position: fixed;
            inset: 0;
            background: var(--bg);
            z-index: 200;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 30px;
            text-align: center;
        }

        input {
            background: transparent;
            border: none;
            border-bottom: 2px solid var(--accent);
            color: var(--primary);
            font-family: inherit;
            font-size: 1.5rem;
            text-align: center;
            outline: none;
            margin: 20px;
        }

        .btn {
            border: 1px solid var(--accent);
            padding: 10px 30px;
            color: var(--accent);
            cursor: pointer;
            background: transparent;
            font-family: inherit;
        }

        .btn:hover { background: var(--accent); color: white; }

        #heartbeat {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: 5;
            box-shadow: inset 0 0 100px rgba(255,0,0,0);
        }
    </style>
</head>
<body>

<div id="heartbeat"></div>

<div id="setup-screen" class="overlay">
    <h1 id="setup-title" style="color:var(--accent)">IDENTIFICATION REQUISE</h1>
    <p id="setup-desc">Le démon veut savoir qui il va briser.</p>
    <div id="question-box">
        <p id="q-text">QUEL EST TON NOM ?</p>
        <input type="text" id="q-input" spellcheck="false" autocomplete="off">
        <br>
        <button class="btn" onclick="processQuestion()">RÉPONDRE</button>
    </div>
</div>

<div id="game-container">
    <div class="status-bar">
        <span>ÂME: <span id="p-name">?</span></span>
        <span style="color:var(--accent)">SANG: <span id="timer">60</span>s</span>
    </div>
    
    <div id="demon-thought">...</div>

    <div id="grid"></div>

    <div id="keypad">
        <div class="key" onclick="game.press(1)">1</div>
        <div class="key" onclick="game.press(2)">2</div>
        <div class="key" onclick="game.press(3)">3</div>
        <div class="key" onclick="game.press(4)">4</div>
        <div class="key" onclick="game.press(5)">5</div>
        <div class="key" onclick="game.press(6)">6</div>
        <div class="key" onclick="game.press(7)">7</div>
        <div class="key" onclick="game.press(8)">8</div>
        <div class="key" onclick="game.press(9)">9</div>
        <div class="key" onclick="game.press(0)" style="color:var(--accent)">X</div>
    </div>
</div>

<script>
    // --- AUDIO SYSTEM (PROCÉDURAL) ---
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    let audioCtx, drone, heartbeat;

    function initAudio() {
        if (audioCtx) return;
        audioCtx = new AudioCtx();
        
        // Drone de fond (Basse fréquence inquiétante)
        drone = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        drone.type = 'sawtooth';
        drone.frequency.setValueAtTime(40, audioCtx.currentTime);
        gain.gain.setValueAtTime(0.02, audioCtx.currentTime);
        
        const filter = audioCtx.createBiquadFilter();
        filter.type = 'lowpass';
        filter.frequency.setValueAtTime(200, audioCtx.currentTime);

        drone.connect(filter);
        filter.connect(gain);
        gain.connect(audioCtx.destination);
        drone.start();
    }

    function playSound(freq, type, duration, vol) {
        if(!audioCtx) return;
        const osc = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        g.gain.setValueAtTime(vol, audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + duration);
        osc.connect(g);
        g.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + duration);
    }

    // --- LOGIQUE DE JEU ---
    const questions = [
        {k: "name", q: "QUEL EST TON NOM ?"},
        {k: "fear", q: "AS-TU PEUR DE LA MORT ? (OUI/NON)"},
        {k: "love", q: "NOMME UNE PERSONNE QUE TU AIMES."},
        {k: "regret", q: "AS-TU DES REGRETS ? (OUI/NON)"}
    ];

    let qIdx = 0;
    let userData = {};

    function processQuestion() {
        initAudio();
        const val = document.getElementById('q-input').value.trim();
        if(!val) return;

        userData[questions[qIdx].k] = val;
        qIdx++;

        if(qIdx < questions.length) {
            document.getElementById('q-text').textContent = questions[qIdx].q;
            document.getElementById('q-input').value = "";
        } else {
            startGame();
        }
    }

    const game = {
        level: 1,
        time: 60,
        selected: null,
        grid: [],
        solution: [],
        isActive: false,

        startGame() {
            document.getElementById('setup-screen').style.display = 'none';
            document.getElementById('game-container').style.display = 'flex';
            document.getElementById('p-name').textContent = userData.name;
            this.generateLevel();
            this.isActive = true;
            this.loop();
            this.demonTalk("BIENVENUE DANS LE VIDE.");
        },

        generateLevel() {
            // Sudoku simplifié pour le flow (4x4 ou 9x9 selon difficulté)
            this.solution = [
                5,3,4,6,7,8,9,1,2, 6,7,2,1,9,5,3,4,8, 1,9,8,3,4,2,5,6,7,
                8,5,9,7,6,1,4,2,3, 4,2,6,8,5,3,7,9,1, 7,1,3,9,2,4,8,5,6,
                9,6,1,5,3,7,2,8,4, 2,8,7,4,1,9,6,3,5, 3,4,5,2,8,6,1,7,9
            ];
            this.grid = [...this.solution];
            for(let i=0; i<40; i++) this.grid[Math.floor(Math.random()*81)] = null;
            this.render();
        },

        render() {
            const container = document.getElementById('grid');
            container.innerHTML = "";
            this.grid.forEach((val, i) => {
                const cell = document.createElement('div');
                cell.className = 'cell' + (val ? ' fixed' : '');
                cell.textContent = val || "";
                cell.onclick = () => { if(!val) this.select(i, cell); };
                container.appendChild(cell);
            });
        },

        select(idx, el) {
            this.selected = idx;
            document.querySelectorAll('.cell').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
        },

        press(n) {
            if(this.selected === null) return;
            if(n === 0) { // Clear
                this.grid[this.selected] = null;
                this.render();
                return;
            }
            
            if(n === this.solution[this.selected]) {
                this.grid[this.selected] = n;
                playSound(200, 'sine', 0.2, 0.1);
                this.selected = null;
                this.render();
                if(Math.random() > 0.7) this.demonTalk("UNE PETITE VICTOIRE...");
                if(!this.grid.includes(null)) this.nextLevel();
            } else {
                this.time -= 10;
                playSound(60, 'sawtooth', 0.5, 0.2);
                document.body.style.animation = "shake 0.2s 3";
                this.demonTalk(this.getInsult());
                setTimeout(() => document.body.style.animation = "", 500);
            }
        },

        getInsult() {
            const insults = [
                `PATHÉTIQUE, ${userData.name}.`,
                `${userData.love} S'HONTE DE TOI.`,
                `TON TEMPS COULE COMME TON SANG.`,
                `SOUFFRE EN SILENCE.`,
                `TU ES PERDU.`
            ];
            return insults[Math.floor(Math.random()*insults.length)];
        },

        demonTalk(txt) {
            const el = document.getElementById('demon-thought');
            el.style.opacity = 0;
            setTimeout(() => {
                el.textContent = txt;
                el.style.opacity = 1;
                this.speak(txt);
            }, 500);
        },

        speak(txt) {
            const ut = new SpeechSynthesisUtterance(txt);
            ut.lang = 'fr-FR';
            ut.pitch = 0.1;
            ut.rate = 0.8;
            window.speechSynthesis.speak(ut);
        },

        loop() {
            if(!this.isActive) return;
            this.time -= 0.1;
            document.getElementById('timer').textContent = Math.ceil(this.time);
            
            // Effet cardiaque
            const hb = document.getElementById('heartbeat');
            if(this.time < 20) {
                const intensity = (20 - this.time) / 20;
                hb.style.boxShadow = `inset 0 0 100px rgba(255,0,0,${intensity})`;
            }

            if(this.time <= 0) this.gameOver();
            else setTimeout(() => this.loop(), 100);
        },

        gameOver() {
            this.isActive = false;
            document.body.innerHTML = `<div class="overlay" style="background:red; color:black">
                <h1>TEMPS ÉPUISÉ</h1>
                <p>${userData.name.toUpperCase()} APPARTIENT AU VIDE.</p>
                <p>SALUTATIONS À ${userData.love}.</p>
            </div>`;
            this.speak(`ADIEU ${userData.name}. NOUS NOUS VERRONS BIENTÔT.`);
            setTimeout(() => location.reload(), 6000);
        }
    };

    function startGame() { game.startGame(); }

</script>

<style>
    @keyframes shake {
        0% { transform: translate(1px, 1px) rotate(0deg); }
        20% { transform: translate(-3px, 0px) rotate(1deg); }
        40% { transform: translate(3px, 2px) rotate(-1deg); }
        100% { transform: translate(1px, -2px) rotate(0deg); }
    }
</style>

</body>
</html>
