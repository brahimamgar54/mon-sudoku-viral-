<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BRUXELLES CENDRES - Survival RPG</title>
    <style>
        :root {
            --bg-color: #0d0d0d;
            --text-main: #c0c0c0;
            --text-highlight: #a89f91;
            --accent-danger: #ff4444;
            --accent-blood: #8a0e0e;
            --accent-success: #2e8b57;
            --clan-elus: #ffd700;
            --clan-ressuscites: #ff00ff;
            --clan-commune: #4caf50;
            --clan-marchands: #6495ed;
            --clan-pillards: #ff6347;
            --font-main: 'Courier New', Courier, monospace;
            --border-style: 2px solid #333;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: var(--font-main);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            min-height: 100vh;
            box-sizing: border-box;
            overflow-y: auto;
        }

        /* Container principal */
        #game-container {
            width: 1000px;
            height: 90vh;
            display: grid;
            grid-template-columns: 250px 1fr 250px;
            grid-template-rows: 60px 1fr 200px;
            gap: 10px;
            border: var(--border-style);
            background-color: #111;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
        }

        /* Header */
        header {
            grid-column: 1 / -1;
            border-bottom: var(--border-style);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            background: #1a1a1a;
        }
        h1 { font-size: 1.5rem; color: #fff; text-transform: uppercase; letter-spacing: 2px; }
        .day-counter { color: var(--accent-danger); font-weight: bold; }

        /* Panneaux latéraux */
        .panel {
            padding: 15px;
            background: #141414;
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow-y: auto;
        }
        .left-panel { border-right: var(--border-style); }
        .right-panel { border-left: var(--border-style); }

        .stat-box { margin-bottom: 15px; }
        .stat-label { font-size: 0.8rem; color: #666; display: block; margin-bottom: 5px; }
        .progress-bar {
            height: 10px;
            background: #333;
            width: 100%;
            position: relative;
        }
        .progress-fill { height: 100%; transition: width 0.3s; }
        .health-fill { background-color: var(--accent-blood); }
        .hunger-fill { background-color: #d2691e; }
        .sanity-fill { background-color: #4682b4; }
        .stamina-fill { background-color: #32cd32; }

        /* Zone Centrale */
        .main-display {
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }
        
        #scene-visual {
            height: 150px;
            background: #000;
            border-bottom: var(--border-style);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
            font-size: 0.8rem;
            position: relative;
            overflow: hidden;
        }

        #log-container {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            font-size: 0.95rem;
            line-height: 1.5;
            scrollbar-width: thin;
            scrollbar-color: #444 #111;
        }
        .log-entry { margin-bottom: 12px; border-left: 2px solid transparent; padding-left: 10px; }
        .log-entry.new { animation: fadeIn 0.5s; border-left-color: var(--text-highlight); }
        
        /* Couleurs contextuelles */
        .log-danger { color: var(--accent-danger); }
        .log-loot { color: var(--accent-success); }
        .log-info { color: #888; }
        .log-pnj { color: #add8e6; }
        .tag-elu { color: var(--clan-elus); font-weight: bold; }
        .tag-ressuscite { color: var(--clan-ressuscites); font-weight: bold; }
        .tag-commune { color: var(--clan-commune); font-weight: bold; }
        .tag-marchand { color: var(--clan-marchands); font-weight: bold; }
        .tag-pillard { color: var(--clan-pillards); font-weight: bold; }
        .tag-solitaire { color: #fff; }

        /* Zone d'actions */
        #actions-container {
            grid-column: 1 / -1;
            border-top: var(--border-style);
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            background: #1a1a1a;
        }

        button {
            background: #000;
            border: 1px solid #444;
            color: var(--text-highlight);
            font-family: var(--font-main);
            padding: 10px;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            font-size: 0.85rem;
        }
        button:hover:not(:disabled) {
            background: #222;
            border-color: #fff;
            color: #fff;
        }
        button:disabled { opacity: 0.3; cursor: not-allowed; }
        
        /* Modale pour les dialogues et événements */
        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #0a0a0a;
            border: 2px solid #444;
            padding: 30px;
            z-index: 100;
            width: 600px;
            max-height: 70vh;
            overflow-y: auto;
        }
        .modal.active { display: block; }
        .modal-header { margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .dialogue-option {
            display: block;
            width: 100%;
            text-align: left;
            margin: 10px 0;
            padding: 15px;
            border: 1px solid #333;
            background: #111;
            cursor: pointer;
        }
        .dialogue-option:hover { background: #222; border-color: #666; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .scanlines {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1));
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 10;
        }
        
        .overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:99; }
        .overlay.active { display: block; }
        
        /* Style pour les PNJ listés */
        .pnj-entry { padding: 8px; border-bottom: 1px solid #222; cursor: pointer; }
        .pnj-entry:hover { background: #1a1a1a; }
    </style>
</head>
<body>

    <div class="scanlines"></div>
    <div class="overlay" id="overlay"></div>

    <!-- Modale de dialogue -->
    <div class="modal" id="dialogue-modal">
        <div class="modal-header">
            <h3 id="dialogue-title">Rencontre</h3>
        </div>
        <div id="dialogue-text"></div>
        <div id="dialogue-options"></div>
    </div>

    <!-- Modale de création de personnage -->
    <div class="modal active" id="character-modal">
        <div class="modal-header">
            <h3>CRÉATION DU SURVIVANT</h3>
        </div>
        <p>Qui êtes-vous avant l'effondrement ?</p>
        <div>
            <label>Nom : <input type="text" id="char-name" placeholder="Anonyme"></label><br><br>
            <label>Genre : 
                <select id="char-gender">
                    <option value="M">Masculin</option>
                    <option value="F">Féminin</option>
                    <option value="N">Non-binaire</option>
                </select>
            </label><br><br>
            <label>Historique :
                <select id="char-background">
                    <option value="medecin">Médecin</option>
                    <option value="soldat">Militaire</option>
                    <option value="politique">Politique</option>
                    <option value="criminel">Criminel</option>
                    <option value="ouvrier">Ouvrier</option>
                    <option value="etudiant">Étudiant</option>
                </select>
            </label>
            <p><small>Votre historique affecte vos compétences initiales et comment les PNJ vous perçoivent.</small></p>
            <button onclick="createCharacter()">COMMENCER LA SURVIE</button>
        </div>
    </div>

    <div id="game-container" style="display: none;">
        <header>
            <h1>Bruxelles Cendres</h1>
            <div class="day-counter">JOUR <span id="day-display">1</span> | <span id="time-display">09:00</span></div>
        </header>

        <div class="panel left-panel">
            <h3>ÉTAT VITAL</h3>
            <div class="stat-box">
                <span class="stat-label">SANTÉ PHYSIQUE</span>
                <div class="progress-bar"><div id="hp-bar" class="progress-fill health-fill" style="width: 100%;"></div></div>
            </div>
            <div class="stat-box">
                <span class="stat-label">FAIM / SOIF</span>
                <div class="progress-bar"><div id="hunger-bar" class="progress-fill hunger-fill" style="width: 25%;"></div></div>
            </div>
            <div class="stat-box">
                <span class="stat-label">SANTÉ MENTALE</span>
                <div class="progress-bar"><div id="sanity-bar" class="progress-fill sanity-fill" style="width: 100%;"></div></div>
            </div>
            <div class="stat-box">
                <span class="stat-label">ENDURANCE</span>
                <div class="progress-bar"><div id="stamina-bar" class="progress-fill stamina-fill" style="width: 100%;"></div></div>
            </div>
            
            <div>
                <span class="stat-label">COMPÉTENCES</span>
                <div style="font-size:0.8rem;">
                    Combat: <span id="skill-combat">5</span><br>
                    Discrétion: <span id="skill-stealth">5</span><br>
                    Négociation: <span id="skill-negotiation">5</span><br>
                    Survie: <span id="skill-survival">5</span>
                </div>
            </div>
            
            <div style="margin-top:auto">
                <span class="stat-label">ZONE ACTUELLE</span>
                <strong id="location-display" style="color:#fff; font-size:1.0rem;">Inconnu</strong>
                <div style="font-size:0.8rem; color:#666;" id="location-desc"></div>
            </div>
        </div>

        <div class="main-display">
            <div id="scene-visual">
                <div id="ascii-art" style="font-size: 10px; line-height: 10px; opacity: 0.5; text-align:center; font-family: monospace;"></div>
            </div>
            <div id="log-container">
                <div class="log-entry">Chargement de votre survivant...</div>
            </div>
        </div>

        <div class="panel right-panel">
            <h3>SAC À DOS <small>(<span id="weight">0</span>/<span id="max-weight">25</span> kg)</small></h3>
            <ul id="inventory-list" style="list-style: none; padding: 0; font-size: 0.85rem;">
                <li>(Vide)</li>
            </ul>
            
            <div style="margin-top: 15px;">
                <h3>PNJ PRÉSENTS</h3>
                <div id="pnj-list">
                    <div class="pnj-entry" onclick="interactWithPNJ('none')">Aucun pour l'instant</div>
                </div>
            </div>
            
            <div style="margin-top:auto; border-top: 1px solid #333; padding-top:10px;">
                <h3>RÉPUTATION</h3>
                <small class="tag-ressuscite">Ressuscités: <span id="rep-ressuscites">0</span></small><br>
                <small class="tag-elu">Élus: <span id="rep-elus">0</span></small><br>
                <small class="tag-commune">Commune: <span id="rep-commune">0</span></small><br>
                <small class="tag-marchand">Marchands: <span id="rep-marchands">0</span></small><br>
                <small class="tag-pillard">Pillards: <span id="rep-pillards">0</span></small>
            </div>
        </div>

        <div id="actions-container">
            <button onclick="game.action('explore')">Fouiller la zone</button>
            <button onclick="game.action('travel')">Changer de Commune</button>
            <button onclick="game.action('rest')">Manger & Dormir</button>
            <button onclick="game.action('social')">Observer / Parler</button>
        </div>
    </div>

<script>
/**
 * SYSTÈME ÉTENDU - BRUXELLES CENDRES
 * Version complexe avec PNJ, clans, et système de survie réaliste
 */

// DONNÉES DU JOUEUR
const PLAYER = {
    name: "Anonyme",
    gender: "M",
    background: "ouvrier",
    skills: { combat: 5, stealth: 5, negotiation: 5, survival: 5, medicine: 5 },
    reputation: { ressuscites: 0, elus: 0, commune: 0, marchands: 0, pillards: 0 }
};

const GAME_STATE = {
    day: 1,
    time: 9, // 24h format
    hp: 100,
    hunger: 25,
    thirst: 25,
    sanity: 100,
    stamina: 100,
    infection: 0,
    location: "bruxelles",
    inventory: [],
    weight: 0,
    maxWeight: 25,
    gameOver: false,
    knownLocations: ["bruxelles"],
    currentPNJs: []
};

// ITEMS avec poids et utilité
const ITEMS = {
    // Armes
    "Couteau rouillé": { type: "weapon", weight: 0.5, damage: 15, durability: 30 },
    "Pistolet 9mm": { type: "weapon", weight: 1, damage: 40, ammo: 8, maxAmmo: 8, durability: 60 },
    "Crosse de bois": { type: "weapon", weight: 2, damage: 20, durability: 50 },
    
    // Nourriture/Boisson
    "Conserve de raviolis": { type: "food", weight: 0.4, hunger: -30, thirst: 5 },
    "Eau (bouteille)": { type: "drink", weight: 0.5, thirst: -40 },
    "Chocolat": { type: "food", weight: 0.1, hunger: -10, sanity: 5 },
    "Alcool pur": { type: "drink", weight: 0.3, thirst: -10, sanity: -10, hp: -5 },
    
    // Médical
    "Bandages": { type: "medical", weight: 0.2, heal: 15 },
    "Antibiotiques": { type: "medical", weight: 0.1, cure: true },
    "Antidouleurs": { type: "medical", weight: 0.1, sanity: 10 },
    
    // Utilitaires
    "Lampe torche": { type: "tool", weight: 0.3, battery: 100 },
    "Batterie AA": { type: "resource", weight: 0.05 },
    "Clés de voiture": { type: "key", weight: 0.1 },
    "Carte de la STIB": { type: "map", weight: 0.1 },
    
    // Ressources
    "Morceau de métal": { type: "resource", weight: 0.5 },
    "Boîte de conserve vide": { type: "resource", weight: 0.1 },
    "Chiffon": { type: "resource", weight: 0.05 }
};

// PNJ avec histoires et caractéristiques
const PNJ_DATABASE = [
    // Solitaires
    { id: "leo", name: "Léo", clan: "solitaire", location: "ixelles", 
      story: "Étudiant en médecine à l'ULB avant le Fléau. A perdu sa famille.",
      attitude: "neutre", trust: 0, skills: { medicine: 8, survival: 4 } },
    
    { id: "sabine", name: "Sabine", clan: "solitaire", location: "uccle",
      story: "Ancienne politicienne. Cachée dans sa villa avec des réserves.",
      attitude: "méfiante", trust: -10, skills: { negotiation: 9, combat: 2 } },
    
    // La Commune
    { id: "thomas", name: "Thomas", clan: "commune", location: "ixelles",
      story: "Ingénieur qui maintient les systèmes de la Commune.",
      attitude: "amical", trust: 20, skills: { survival: 7, medicine: 5 } },
    
    // Les Élus
    { id: "frere_mathias", name: "Frère Mathias", clan: "elu", location: "bruxelles",
      story: "Ex-prêtre devenu fanatique. Croit être choisi par Dieu.",
      attitude: "hostile", trust: -30, skills: { combat: 6, negotiation: 4 } },
    
    // Les Ressuscités
    { id: "scar", name: "Scar", clan: "ressuscite", location: "anderlecht",
      story: "Ancien détenu. Aime l'anarchie et la violence.",
      attitude: "hostile", trust: -50, skills: { combat: 8, stealth: 6 } }
];

// Les 19 communes avec plus de détails
const LOCATIONS = {
    "anderlecht": { 
        name: "Anderlecht", danger: 9, loot: 5, 
        desc: "Territoire des Pillards des Abattoirs. L'odeur de sang séché est omniprésente.",
        clans: ["pillards"], special: "Usine d'abattage"
    },
    "auderghem": { 
        name: "Auderghem", danger: 3, loot: 3, 
        desc: "Maisons abandonnées et forêt envahissante. Relativement calme.",
        clans: [], special: "Forêt de Soignes"
    },
    "bruxelles": { 
        name: "Bruxelles-Ville", danger: 10, loot: 9, 
        desc: "Zone de guerre totale entre les Élus et les Ressuscités.",
        clans: ["elu", "ressuscite"], special: "Grand-Place, Palais de Justice"
    },
    "evere": { 
        name: "Evere", danger: 4, loot: 4, 
        desc: "Le cimetière est silencieux. L'OTAN n'est plus qu'un cratère.",
        clans: [], special: "Cimetière de Bruxelles"
    },
    "forest": { 
        name: "Forest", danger: 6, loot: 5, 
        desc: "L'usine Audi est un labyrinthe de métal rouillé.",
        clans: [], special: "Forest National"
    },
    "ixelles": { 
        name: "Ixelles", danger: 4, loot: 7, 
        desc: "Base de la Commune. Barricades et culture urbaine.",
        clans: ["commune"], special: "Campus ULB/VUB"
    },
    "molenbeek": { 
        name: "Molenbeek-St-Jean", danger: 7, loot: 6, 
        desc: "Canal pollué et ateliers clandestins.",
        clans: [], special: "Canal de Bruxelles"
    },
    "schaerbeek": { 
        name: "Schaerbeek", danger: 6, loot: 6, 
        desc: "Le parc Josaphat est une jungle dangereuse mais fertile.",
        clans: [], special: "Parc Josaphat"
    },
    "uccle": { 
        name: "Uccle", danger: 2, loot: 8, 
        desc: "Villas de riches pillées mais avec restes de luxe.",
        clans: [], special: "Villas bourgeoises"
    },
    "watermael": { 
        name: "Watermael-Boitsfort", danger: 2, loot: 2, 
        desc: "La forêt a repris ses droits. Bon pour chasser.",
        clans: [], special: "Réserve naturelle"
    }
};

// Événements détaillés
const EVENTS = {
    zombie: [
        { text: "Un Rôdeur vous attrape par la jambe !", dmg: 15, sanity: -5, infection: 10 },
        { text: "Groupe de 3 Rôdeurs devant une épicerie.", dmg: 25, sanity: -10 },
        { text: "La Grande Horde est dans le secteur ! Fuite immédiate.", dmg: 0, sanity: -30 }
    ],
    loot: [
        { text: "Vous trouvez un sac à dos abandonné avec des fournitures.", items: ["Conserve de raviolis", "Eau (bouteille)", "Bandages"] },
        { text: "Une voiture accidentée contient des ressources.", items: ["Morceau de métal", "Boîte de conserve vide", "Chiffon"] },
        { text: "Pharmacie partiellement intacte.", items: ["Antibiotiques", "Antidouleurs", "Bandages"] }
    ],
    clan: [
        { text: "Patrouille des <span class='tag-elu'>Élus</span>. Ils cherchent des 'impurs'.", clan: "elu", reaction: "hostile", dmg: 20 },
        { text: "<span class='tag-commune'>La Commune</span> propose un échange pacifique.", clan: "commune", reaction: "friendly", items: ["Eau (bouteille)"] },
        { text: "Embuscade des <span class='tag-pillard'>Pillards</span> !", clan: "pillards", reaction: "hostile", dmg: 30 }
    ],
    special: [
        { text: "Vous trouvez une voiture avec les clés sur le contact !", effect: "vehicle" },
        { text: "Un chien errant vous suit. Il semble amical.", effect: "companion" },
        { text: "Vous découvrez un bunker secret.", effect: "safehouse" }
    ]
};

// Système de dialogue
const DIALOGUES = {
    leo: {
        initial: "Je cherche encore des médicaments à l'hôpital Brugmann. Vous voulez m'aider ?",
        options: [
            { text: "Je peux vous aider. (Négociation)", check: "negotiation", min: 4, 
              result: "Merci ! Voici des antibiotiques pour vous.", items: ["Antibiotiques"], trust: +10 },
            { text: "Désolé, je dois y aller.", result: "Compréhensible. Bonne chance.", trust: 0 },
            { text: "Donne-moi tes affaires ! (Menace)", check: "combat", min: 6,
              result: "Ne vous approchez pas ! Je me défendrai !", trust: -30, combat: true }
        ]
    },
    frere_mathias: {
        initial: "L'impur s'approche du sanctuaire ! Le feu vous purifiera !",
        options: [
            { text: "Je ne suis pas infecté !", check: "negotiation", min: 7,
              result: "Seul Dieu en jugera. Prouvez-le en tuant un Ressuscité.", trust: +5 },
            { text: "Votre religion est une folie.", result: "Blasphème ! Attaquez !", trust: -50, combat: true },
            { text: "Je cherche refuge.", result: "Les impurs n'ont pas leur place ici. Partez.", trust: -10 }
        ]
    }
};

// Initialisation du jeu
function initGame() {
    updateUI();
    game.log(`<b>${PLAYER.name}</b> commence sa survie dans Bruxelles Cendres.`, "new");
    game.log(LOCATIONS[GAME_STATE.location].desc);
    updatePNJList();
    
    // Cacher la modale de création
    document.getElementById('character-modal').classList.remove('active');
    document.getElementById('overlay').classList.remove('active');
    document.getElementById('game-container').style.display = 'grid';
}

// Création du personnage
function createCharacter() {
    const name = document.getElementById('char-name').value || "Anonyme";
    const gender = document.getElementById('char-gender').value;
    const background = document.getElementById('char-background').value;
    
    PLAYER.name = name;
    PLAYER.gender = gender;
    PLAYER.background = background;
    
    // Ajuster les compétences selon l'historique
    switch(background) {
        case 'medecin':
            PLAYER.skills.medicine = 8;
            PLAYER.skills.combat = 3;
            PLAYER.inventory.push("Bandages", "Antidouleurs");
            break;
        case 'soldat':
            PLAYER.skills.combat = 8;
            PLAYER.skills.survival = 7;
            PLAYER.inventory.push("Couteau rouillé");
            break;
        case 'politique':
            PLAYER.skills.negotiation = 9;
            PLAYER.skills.stealth = 6;
            PLAYER.reputation.elus = 10;
            break;
        case 'criminel':
            PLAYER.skills.stealth = 8;
            PLAYER.skills.combat = 6;
            PLAYER.inventory.push("Couteau rouillé", "Morceau de métal");
            break;
    }
    
    GAME_STATE.inventory = [...PLAYER.inventory];
    updateInventory();
    
    initGame();
}

// Système principal
const game = {
    log: function(text, cssClass = "") {
        const container = document.getElementById('log-container');
        const entry = document.createElement('div');
        entry.className = `log-entry ${cssClass} new`;
        entry.innerHTML = `> ${text}`;
        container.appendChild(entry);
        container.scrollTop = container.scrollHeight;
    },

    action: function(type) {
        if (GAME_STATE.gameOver) return;
        
        // Coût d'endurance
        GAME_STATE.stamina -= 15;
        if (GAME_STATE.stamina <= 0) {
            this.log("Trop fatigué pour agir.", "log-danger");
            GAME_STATE.stamina = 0;
            return;
        }
        
        // Faim et soif augmentent
        GAME_STATE.hunger += 3;
        GAME_STATE.thirst += 4;
        
        // Vérifier les besoins
        if (GAME_STATE.hunger >= 80) {
            this.log("La faim vous tiraille douloureusement.", "log-danger");
            GAME_STATE.hp -= 5;
        }
        if (GAME_STATE.thirst >= 80) {
            this.log("La soif vous déshydrate.", "log-danger");
            GAME_STATE.hp -= 8;
        }
        
        // Exécuter l'action
        switch(type) {
            case 'explore': this.explore(); break;
            case 'travel': this.travel(); break;
            case 'rest': this.rest(); break;
            case 'social': this.social(); break;
        }
        
        // Passer le temps
        GAME_STATE.time += 2;
        if (GAME_STATE.time >= 24) {
            GAME_STATE.time = 8;
            GAME_STATE.day++;
            this.newDay();
        }
        
        this.checkStatus();
        updateUI();
        updatePNJList();
    },

    explore: function() {
        const loc = LOCATIONS[GAME_STATE.location];
        this.log(`Fouille de ${loc.name}...`);
        
        // Chance basée sur compétence survie
        const survivalBonus = PLAYER.skills.survival * 2;
        const roll = Math.random() * 100 + survivalBonus;
        
        // Danger d'abord
        if (roll < loc.danger * 5) {
            const evt = EVENTS.zombie[Math.floor(Math.random() * EVENTS.zombie.length)];
            this.log(evt.text, "log-danger");
            
            // Réduction des dégâts si bon en combat
            const dmgReduction = PLAYER.skills.combat * 2;
            const actualDmg = Math.max(5, evt.dmg - dmgReduction);
            
            this.takeDamage(actualDmg);
            if (evt.infection) GAME_STATE.infection += evt.infection;
            GAME_STATE.sanity += evt.sanity || 0;
            
            // Mort instantanée si Grande Horde
            if (evt.text.includes("Grande Horde")) {
                if (PLAYER.skills.stealth < 7) {
                    this.triggerGameOver("La Grande Horde vous a submergé.");
                } else {
                    this.log("Vous vous cachez juste à temps.", "log-info");
                }
            }
        }
        // Loot
        else if (roll > 100 - (loc.loot * 5)) {
            const evt = EVENTS.loot[Math.floor(Math.random() * EVENTS.loot.length)];
            this.log(evt.text, "log-loot");
            
            evt.items.forEach(itemName => {
                if (GAME_STATE.weight < GAME_STATE.maxWeight) {
                    GAME_STATE.inventory.push(itemName);
                    this.log(`+ ${itemName}`, "log-loot");
                } else {
                    this.log("Sac trop lourd !", "log-danger");
                }
            });
            updateInventory();
        }
        // Rencontre de clan
        else if (roll > 70 && loc.clans.length > 0) {
            const clanName = loc.clans[Math.floor(Math.random() * loc.clans.length)];
            const clanEvents = EVENTS.clan.filter(e => e.clan === clanName);
            
            if (clanEvents.length > 0) {
                const evt = clanEvents[0];
                this.log(evt.text, clanName === "elu" ? "tag-elu" : 
                                      clanName === "commune" ? "tag-commune" : "tag-pillard");
                
                if (evt.reaction === "hostile") {
                    this.takeDamage(evt.dmg);
                    PLAYER.reputation[clanName] -= 10;
                } else if (evt.reaction === "friendly") {
                    evt.items.forEach(item => {
                        GAME_STATE.inventory.push(item);
                        this.log(`+ ${item}`, "log-loot");
                    });
                    PLAYER.reputation[clanName] += 5;
                }
                updateReputation();
            }
        }
        // Événement spécial
        else if (roll > 90) {
            const evt = EVENTS.special[Math.floor(Math.random() * EVENTS.special.length)];
            this.log(evt.text, "log-loot");
            
            if (evt.effect === "vehicle") {
                this.log("Vous avez maintenant un véhicule ! Voyage plus rapide.", "log-loot");
            }
        }
        // Rien
        else {
            this.log("Rien de notable... juste le silence des morts.", "log-info");
        }
    },

    travel: function() {
        // Afficher les localisations connues
        let options = "<h4>Choisir une destination:</h4>";
        GAME_STATE.knownLocations.forEach(locId => {
            const loc = LOCATIONS[locId];
            options += `<button class='dialogue-option' onclick='game.travelTo("${locId}")'>
                ${loc.name} (Danger: ${loc.danger}/10)
            </button>`;
        });
        
        // Option de découverte aléatoire
        options += `<button class='dialogue-option' onclick='game.discoverLocation()'>
            Explorer l'inconnu (Risqué)
        </button>`;
        
        this.showDialogue("Voyage", options);
    },
    
    travelTo: function(locId) {
        const loc = LOCATIONS[locId];
        GAME_STATE.hunger += 10;
        GAME_STATE.thirst += 15;
        GAME_STATE.location = locId;
        
        this.log(`Voyage vers ${loc.name}...`, "new");
        this.log(loc.desc);
        
        // Générer des PNJ pour cette zone
        this.generatePNJs();
        
        // Fermer le dialogue
        this.hideDialogue();
    },
    
    discoverLocation: function() {
        const allLocs = Object.keys(LOCATIONS);
        const unknownLocs = allLocs.filter(loc => !GAME_STATE.knownLocations.includes(loc));
        
        if (unknownLocs.length > 0) {
            const newLoc = unknownLocs[Math.floor(Math.random() * unknownLocs.length)];
            GAME_STATE.knownLocations.push(newLoc);
            this.travelTo(newLoc);
            
            // 30% de chance d'événement dangereux pendant l'exploration
            if (Math.random() < 0.3) {
                this.log("Vous vous êtes perdu ! Des Rôdeurs vous attaquent.", "log-danger");
                this.takeDamage(20);
            }
        }
        this.hideDialogue();
    },

    rest: function() {
        // Chercher de la nourriture dans l'inventaire
        const foodIndex = GAME_STATE.inventory.findIndex(item => 
            ITEMS[item] && (ITEMS[item].type === "food" || ITEMS[item].type === "drink"));
        
        if (foodIndex > -1) {
            const item = GAME_STATE.inventory[foodIndex];
            const itemData = ITEMS[item];
            
            // Appliquer les effets
            if (itemData.hunger) GAME_STATE.hunger = Math.max(0, GAME_STATE.hunger + itemData.hunger);
            if (itemData.thirst) GAME_STATE.thirst = Math.max(0, GAME_STATE.thirst + itemData.thirst);
            if (itemData.sanity) GAME_STATE.sanity = Math.min(100, GAME_STATE.sanity + itemData.sanity);
            if (itemData.hp) GAME_STATE.hp += itemData.hp;
            
            // Retirer de l'inventaire
            GAME_STATE.inventory.splice(foodIndex, 1);
            
            this.log(`Vous consommez ${item} et vous reposez.`, "log-loot");
            GAME_STATE.hp = Math.min(100, GAME_STATE.hp + 20);
            GAME_STATE.stamina = 100;
            GAME_STATE.sanity = Math.min(100, GAME_STATE.sanity + 10);
            
            // Passer 6 heures
            GAME_STATE.time += 6;
            if (GAME_STATE.time >= 24) {
                GAME_STATE.time -= 24;
                GAME_STATE.day++;
                this.newDay();
            }
        } else {
            this.log("Rien à manger... le repos est agité.", "log-danger");
            GAME_STATE.hp = Math.min(100, GAME_STATE.hp + 5);
            GAME_STATE.hunger += 15;
            GAME_STATE.sanity -= 10;
        }
        updateInventory();
    },

    social: function() {
        if (GAME_STATE.currentPNJs.length > 0) {
            let options = "<h4>Parler à:</h4>";
            GAME_STATE.currentPNJs.forEach(pnjId => {
                const pnj = PNJ_DATABASE.find(p => p.id === pnjId);
                const clanClass = `tag-${pnj.clan}`;
                options += `<button class='dialogue-option' onclick='interactWithPNJ("${pnjId}")'>
                    <span class="${clanClass}">${pnj.name}</span> - ${pnj.story.substring(0, 50)}...
                </button>`;
            });
            options += `<button class='dialogue-option' onclick='game.observe()'>
                Observer sans se montrer
            </button>`;
            
            this.showDialogue("Interaction sociale", options);
        } else {
            this.observe();
        }
    },
    
    observe: function() {
        const loc = LOCATIONS[GAME_STATE.location];
        const stealthBonus = PLAYER.skills.stealth * 3;
        
        if (Math.random() * 100 + stealthBonus > 70) {
            this.log("Vous observez discrètement la zone...", "log-info");
            
            // Découvrir des informations
            if (loc.clans.length > 0) {
                this.log(`Activité des ${loc.clans[0]} détectée.`, "log-info");
            }
            
            // Chance de trouver un PNJ caché
            if (Math.random() > 0.7) {
                const hiddenPNJs = PNJ_DATABASE.filter(p => 
                    p.location === GAME_STATE.location && 
                    !GAME_STATE.currentPNJs.includes(p.id)
                );
                if (hiddenPNJs.length > 0) {
                    const pnj = hiddenPNJs[0];
                    GAME_STATE.currentPNJs.push(pnj.id);
                    this.log(`Vous repérez ${pnj.name} en train de se cacher.`, "log-pnj");
                }
            }
            
            GAME_STATE.sanity += 5; // Observer est rassurant
        } else {
            this.log("Vous êtes repéré !", "log-danger");
            this.takeDamage(10);
        }
        this.hideDialogue();
    },
    
    generatePNJs: function() {
        GAME_STATE.currentPNJs = [];
        const locPNJs = PNJ_DATABASE.filter(p => p.location === GAME_STATE.location);
        
        // Sélectionner 1-3 PNJ aléatoires
        const count = Math.min(Math.floor(Math.random() * 3) + 1, locPNJs.length);
        for (let i = 0; i < count; i++) {
            const pnj = locPNJs[Math.floor(Math.random() * locPNJs.length)];
            if (!GAME_STATE.currentPNJs.includes(pnj.id)) {
                GAME_STATE.currentPNJs.push(pnj.id);
            }
        }
    },
    
    showDialogue: function(title, content) {
        document.getElementById('dialogue-title').textContent = title;
        document.getElementById('dialogue-text').innerHTML = "";
        document.getElementById('dialogue-options').innerHTML = content;
        
        document.getElementById('dialogue-modal').classList.add('active');
        document.getElementById('overlay').classList.add('active');
    },
    
    hideDialogue: function() {
        document.getElementById('dialogue-modal').classList.remove('active');
        document.getElementById('overlay').classList.remove('active');
    },
    
    newDay: function() {
        this.log(`=== JOUR ${GAME_STATE.day} ===`, "new");
        
        // Infection progresse
        if (GAME_STATE.infection > 0) {
            GAME_STATE.infection += 5;
            this.log("L'infection progresse...", "log-danger");
            if (GAME_STATE.infection >= 100) {
                this.triggerGameOver("Le Fléau Gris vous a transformé en Rôdeur.");
            }
        }
        
        // Événement quotidien
        const dailyEvents = [
            "La pluie acide nettoie les rues.",
            "Des cris lointains résonnent dans la nuit.",
            "Vous entendez des coups de feu au loin.",
            "Un silence inquiétant règne sur la ville."
        ];
        this.log(dailyEvents[Math.floor(Math.random() * dailyEvents.length)]);
        
        // Régénération naturelle
        GAME_STATE.stamina = 100;
        GAME_STATE.sanity = Math.min(100, GAME_STATE.sanity + 5);
    },

    takeDamage: function(amount) {
        GAME_STATE.hp -= amount;
        this.log(`-${amount} PV`, "log-danger");
    },

    checkStatus: function() {
        if (GAME_STATE.hp <= 0) {
            this.triggerGameOver("Vos blessures sont trop graves.");
        }
        if (GAME_STATE.sanity <= 0) {
            this.triggerGameOver("La folie a pris le dessus. Vous vous suicidez.");
        }
        if (GAME_STATE.hunger >= 100 || GAME_STATE.thirst >= 100) {
            this.triggerGameOver("La faim et la soif ont eu raison de vous.");
        }
    },

    triggerGameOver: function(reason) {
        GAME_STATE.gameOver = true;
        
        // Afficher l'écran de fin
        document.getElementById('log-container').innerHTML = `
            <div class="log-entry new log-danger" style="text-align:center; font-size:1.5rem; margin:20px 0;">
                FIN DE PARTIE
            </div>
            <div class="log-entry new">
                Cause: ${reason}
            </div>
            <div class="log-entry new">
                Jours survécus: ${GAME_STATE.day}
            </div>
            <div class="log-entry new">
                Localisations découvertes: ${GAME_STATE.knownLocations.length}/19
            </div>
            <div class="log-entry new">
                <button onclick="location.reload()" style="padding:10px 20px; margin-top:20px;">
                    NOUVELLE PARTIE
                </button>
            </div>
        `;
        
        // Désactiver les boutons
        document.querySelectorAll('#actions-container button').forEach(btn => {
            btn.disabled = true;
        });
    }
};

// Interaction avec PNJ
function interactWithPNJ(pnjId) {
    if (pnjId === 'none') return;
    
    const pnj = PNJ_DATABASE.find(p => p.id === pnjId);
    if (!pnj) return;
    
    const dialogue = DIALOGUES[pnjId];
    if (!dialogue) {
        game.log(`Pas de dialogue disponible avec ${pnj.name}.`, "log-info");
        game.hideDialogue();
        return;
    }
    
    let optionsHTML = `<p><b>${pnj.name}:</b> "${dialogue.initial}"</p><hr>`;
    
    dialogue.options.forEach((option, i) => {
        let disabled = "";
        let skillText = "";
        
        if (option.check) {
            const skillValue = PLAYER.skills[option.check];
            if (skillValue < option.min) {
                disabled = "disabled";
                skillText = ` (Nécessite ${option.check} ≥ ${option.min})`;
            }
        }
        
        optionsHTML += `
            <button class="dialogue-option" ${disabled} 
                    onclick="selectDialogueOption('${pnjId}', ${i})">
                ${option.text}${skillText}
            </button>
        `;
    });
    
    game.showDialogue(`Rencontre avec ${pnj.name}`, optionsHTML);
}

function selectDialogueOption(pnjId, optionIndex) {
    const pnj = PNJ_DATABASE.find(p => p.id === pnjId);
    const dialogue = DIALOGUES[pnjId];
    const option = dialogue.options[optionIndex];
    
    game.log(`<b>${PLAYER.name}:</b> "${option.text}"`, "log-info");
    
    // Effets de l'option
    if (option.result) {
        game.log(`<b>${pnj.name}:</b> "${option.result}"`, "log-pnj");
    }
    
    if (option.trust) {
        // Mettre à jour la confiance
        const pnjIndex = PNJ_DATABASE.findIndex(p => p.id === pnjId);
        PNJ_DATABASE[pnjIndex].trust += option.trust;
        
        if (option.trust > 0) {
            game.log(`Confiance avec ${pnj.name} augmentée.`, "log-info");
        } else {
            game.log(`Confiance avec ${pnj.name} diminuée.`, "log-danger");
        }
    }
    
    if (option.items) {
        option.items.forEach(item => {
            GAME_STATE.inventory.push(item);
            game.log(`+ ${item}`, "log-loot");
        });
        updateInventory();
    }
    
    if (option.combat) {
        game.log("Le combat commence !", "log-danger");
        const dmg = 25 - PLAYER.skills.combat;
        game.takeDamage(Math.max(5, dmg));
    }
    
    // Mettre à jour la réputation du clan
    if (pnj.clan !== "solitaire") {
        const repChange = option.trust ? option.trust / 2 : 0;
        PLAYER.reputation[pnj.clan] += repChange;
        updateReputation();
    }
    
    game.hideDialogue();
    game.checkStatus();
}

// Fonctions d'UI
function updateUI() {
    // Barres de statut
    document.getElementById('hp-bar').style.width = GAME_STATE.hp + "%";
    document.getElementById('hunger-bar').style.width = GAME_STATE.hunger + "%";
    document.getElementById('sanity-bar').style.width = GAME_STATE.sanity + "%";
    document.getElementById('stamina-bar').style.width = GAME_STATE.stamina + "%";
    
    // Texte
    document.getElementById('day-display').textContent = GAME_STATE.day;
    const timeStr = GAME_STATE.time.toFixed(0).padStart(2, '0') + ":00";
    document.getElementById('time-display').textContent = timeStr;
    
    // Localisation
    const loc = LOCATIONS[GAME_STATE.location];
    document.getElementById('location-display').textContent = loc.name;
    document.getElementById('location-desc').textContent = loc.desc;
    
    // Compétences
    document.getElementById('skill-combat').textContent = PLAYER.skills.combat;
    document.getElementById('skill-stealth').textContent = PLAYER.skills.stealth;
    document.getElementById('skill-negotiation').textContent = PLAYER.skills.negotiation;
    document.getElementById('skill-survival').textContent = PLAYER.skills.survival;
    
    // ASCII Art contextuel
    updateASCIIArt();
}

function updateASCIIArt() {
    const ascii = document.getElementById('ascii-art');
    const loc = LOCATIONS[GAME_STATE.location];
    
    // ASCII différent selon la localisation
    const arts = {
        bruxelles: `
          ^   ^   ^
         / \\ / \\ / \\
        |   X   X   |
        | WAR ZONE  |
        |___________|`,
        
        ixelles: `
           _____
          /     \\
         |  ULB  |
         |_______|
          |     |
          |_____|`,
        
        uccle: `
            /\\
           /  \\
          /____\\
         |      |
         | VILLA|
         |______|`
    };
    
    ascii.textContent = arts[GAME_STATE.location] || `
        _   _   _   _   _
       | |_| |_| |_| |_| |
       |_|_|_|_|_|_|_|_|_|
         BRUXELLES 2035
       |_________________|`;
}

function updateInventory() {
    const list = document.getElementById('inventory-list');
    const weightDisplay = document.getElementById('weight');
    const maxWeightDisplay = document.getElementById('max-weight');
    
    // Calculer le poids
    let totalWeight = 0;
    GAME_STATE.inventory.forEach(itemName => {
        const item = ITEMS[itemName];
        if (item) totalWeight += item.weight || 0.1;
    });
    GAME_STATE.weight = totalWeight;
    
    // Mettre à jour l'affichage
    weightDisplay.textContent = totalWeight.toFixed(1);
    maxWeightDisplay.textContent = GAME_STATE.maxWeight;
    
    // Afficher les items
    list.innerHTML = "";
    if (GAME_STATE.inventory.length === 0) {
        list.innerHTML = "<li>(Vide)</li>";
    } else {
        GAME_STATE.inventory.forEach(item => {
            const li = document.createElement('li');
            li.textContent = `- ${item}`;
            if (ITEMS[item]) {
                li.style.color = ITEMS[item].type === "weapon" ? "#ff6666" :
                                 ITEMS[item].type === "food" ? "#66ff66" :
                                 ITEMS[item].type === "medical" ? "#ff66ff" : "#cccccc";
            }
            list.appendChild(li);
        });
    }
    
    // Avertissement de poids
    if (totalWeight > GAME_STATE.maxWeight * 0.8) {
        list.style.color = "#ff4444";
    } else {
        list.style.color = "";
    }
}

function updatePNJList() {
    const list = document.getElementById('pnj-list');
    list.innerHTML = "";
    
    if (GAME_STATE.currentPNJs.length === 0) {
        list.innerHTML = '<div class="pnj-entry">Aucun PNJ détecté</div>';
    } else {
        GAME_STATE.currentPNJs.forEach(pnjId => {
            const pnj = PNJ_DATABASE.find(p => p.id === pnjId);
            if (pnj) {
                const div = document.createElement('div');
                div.className = 'pnj-entry';
                div.onclick = () => interactWithPNJ(pnjId);
                
                let clanClass = '';
                switch(pnj.clan) {
                    case 'elu': clanClass = 'tag-elu'; break;
                    case 'ressuscite': clanClass = 'tag-ressuscite'; break;
                    case 'commune': clanClass = 'tag-commune'; break;
                    case 'solitaire': clanClass = 'tag-solitaire'; break;
                }
                
                div.innerHTML = `<span class="${clanClass}">${pnj.name}</span><br>
                                <small>${pnj.story.substring(0, 40)}...</small>`;
                list.appendChild(div);
            }
        });
    }
}

function updateReputation() {
    document.getElementById('rep-ressuscites').textContent = PLAYER.reputation.ressuscites;
    document.getElementById('rep-elus').textContent = PLAYER.reputation.elus;
    document.getElementById('rep-commune').textContent = PLAYER.reputation.commune;
    document.getElementById('rep-marchands').textContent = PLAYER.reputation.marchands;
    document.getElementById('rep-pillards').textContent = PLAYER.reputation.pillards;
}

// Initialiser l'ASCII art au chargement
window.onload = function() {
    updateASCIIArt();
    // La modale de création est déjà visible
};
</script>
</body>
            </html>
