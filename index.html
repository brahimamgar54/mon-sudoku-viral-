<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PLURIBUS : REBORN</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <meta name="theme-color" content="#8a2be2">
    <style>
        :root {
            --bg-color: #0a0a0a;
            --text-color: #f0f0f0;
            --accent-color: #8a2be2;
            --danger-color: #ff4d4d;
            --safe-color: #4dff88;
            --panel-color: #1a1a1a;
            --border-color: #333;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            touch-action: pan-y;
        }

        /* Header avec stats */
        #header {
            background: linear-gradient(to right, var(--panel-color), #222);
            border-bottom: 2px solid var(--accent-color);
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            z-index: 100;
            flex-shrink: 0;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 70px;
        }

        .stat-label {
            font-size: 11px;
            opacity: 0.8;
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 18px;
            font-weight: bold;
        }

        #sync-value {
            color: var(--accent-color);
            text-shadow: 0 0 8px var(--accent-color);
        }

        #health-value {
            color: var(--safe-color);
        }

        #xp-value {
            color: #ffcc00;
        }

        /* Barres de progression */
        .progress-container {
            width: 100%;
            height: 6px;
            background-color: #333;
            border-radius: 3px;
            margin-top: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        #sync-fill {
            background: linear-gradient(to right, #4a00e0, #8a2be2);
            box-shadow: 0 0 6px var(--accent-color);
        }

        #health-fill {
            background: linear-gradient(to right, #00b09b, #96c93d);
        }

        /* Zone de jeu principale */
        #game-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        #scene-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            position: relative;
            min-height: 200px;
        }

        /* Effets de post-traitement */
        #vignette {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            background: radial-gradient(ellipse at center, transparent 40%, rgba(10,10,10,0.8) 70%);
            z-index: 2;
        }

        #scanlines {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                to bottom,
                rgba(255,255,255,0) 0%,
                rgba(255,255,255,0.03) 50%,
                rgba(255,255,255,0) 100%
            );
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 3;
            animation: scan 10s linear infinite;
        }

        @keyframes scan {
            0% { background-position: 0 0; }
            100% { background-position: 0 100%; }
        }

        /* Emoji scene */
        #scene-emoji {
            font-size: 70px;
            margin-bottom: 20px;
            filter: drop-shadow(0 0 10px rgba(138, 43, 226, 0.5));
            z-index: 1;
            transition: transform 0.3s, filter 0.3s;
        }

        .high-sync #scene-emoji {
            filter: drop-shadow(0 0 15px rgba(138, 43, 226, 0.8)) hue-rotate(30deg);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Texte de l'histoire */
        #story-text {
            background-color: rgba(26, 26, 26, 0.85);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            margin: 0 15px 15px;
            line-height: 1.6;
            font-size: 16px;
            max-height: 200px;
            overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            z-index: 1;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }

        /* Choix */
        #choices-container {
            padding: 15px;
            background-color: var(--panel-color);
            border-top: 2px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 40vh;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .choice-btn {
            background: linear-gradient(to right, #222, #2a2a2a);
            border: 1px solid var(--border-color);
            border-left: 4px solid var(--accent-color);
            color: var(--text-color);
            padding: 16px 15px;
            text-align: left;
            font-family: inherit;
            font-size: 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }

        .choice-btn:active {
            background: linear-gradient(to right, #2a2a2a, #333);
            transform: translateY(2px);
            border-left-color: #a855f7;
        }

        .choice-btn::after {
            content: "";
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.7s;
        }

        .choice-btn:active::after {
            left: 100%;
        }

        .choice-sync {
            font-size: 12px;
            float: right;
            padding: 2px 8px;
            border-radius: 10px;
            background-color: rgba(138, 43, 226, 0.2);
        }

        .choice-sync.positive {
            color: #4dff88;
        }

        .choice-sync.negative {
            color: #ff4d4d;
        }

        /* Overlay pour effets */
        #effects-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s;
        }

        /* Menu lat√©ral */
        #side-menu-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background-color: var(--accent-color);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 22px;
            color: white;
            z-index: 101;
            box-shadow: 0 4px 12px rgba(138, 43, 226, 0.4);
            border: none;
            cursor: pointer;
        }

        #side-menu {
            position: fixed;
            top: 0;
            right: -300px;
            width: 280px;
            height: 100%;
            background-color: var(--panel-color);
            z-index: 200;
            transition: right 0.3s;
            padding: 20px;
            overflow-y: auto;
            border-left: 2px solid var(--accent-color);
        }

        .menu-section {
            margin-bottom: 25px;
        }

        .menu-section h3 {
            color: var(--accent-color);
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 18px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
        }

        .skill-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px dashed var(--border-color);
        }

        .skill-name {
            font-size: 14px;
        }

        .skill-level {
            color: #ffcc00;
            font-weight: bold;
        }

        .inventory-item {
            background-color: rgba(255,255,255,0.05);
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
        }

        .inventory-item i {
            margin-right: 10px;
            color: var(--accent-color);
        }

        /* Glitch effect */
        @keyframes glitch {
            0% { transform: translate(0); filter: hue-rotate(0); }
            10% { transform: translate(-3px, -1px); filter: hue-rotate(30deg); }
            20% { transform: translate(3px, 1px); }
            30% { transform: translate(-3px, 0); filter: hue-rotate(60deg); }
            40% { transform: translate(0, 2px); }
            50% { transform: translate(0); filter: hue-rotate(90deg); }
            100% { transform: translate(0); filter: hue-rotate(0); }
        }

        .glitch-active {
            animation: glitch 0.5s infinite;
        }

        /* Responsive */
        @media (max-height: 700px) {
            #scene-emoji { font-size: 50px; }
            #story-text { font-size: 14px; max-height: 150px; }
            .choice-btn { padding: 12px 15px; }
        }

        @media (max-width: 400px) {
            .stat-item { min-width: 60px; }
            .stat-value { font-size: 16px; }
            #scene-emoji { font-size: 60px; }
        }
    </style>
</head>
<body>
    <div id="header">
        <div class="stat-item">
            <div class="stat-label">NOM</div>
            <div id="player-name" class="stat-value">INCONNU</div>
        </div>
        
        <div class="stat-item">
            <div class="stat-label">SYNCHRO</div>
            <div id="sync-value" class="stat-value">0%</div>
            <div class="progress-container">
                <div id="sync-fill" class="progress-fill" style="width: 0%"></div>
            </div>
        </div>
        
        <div class="stat-item">
            <div class="stat-label">SANT√â</div>
            <div id="health-value" class="stat-value">100%</div>
            <div class="progress-container">
                <div id="health-fill" class="progress-fill" style="width: 100%"></div>
            </div>
        </div>
        
        <div class="stat-item">
            <div class="stat-label">XP</div>
            <div id="xp-value" class="stat-value">0</div>
        </div>
    </div>

    <div id="game-container">
        <div id="vignette"></div>
        <div id="scanlines"></div>
        
        <div id="scene-container">
            <div id="scene-emoji">üèôÔ∏è</div>
            <div id="story-text">Chargement de la conscience...</div>
        </div>
    </div>

    <div id="choices-container">
        <!-- Les choix seront ins√©r√©s ici dynamiquement -->
    </div>

    <button id="side-menu-btn">
        <i class="fas fa-bars"></i>
    </button>

    <div id="side-menu">
        <div class="menu-section">
            <h3><i class="fas fa-user"></i> PERSONNAGE</h3>
            <div><strong>Nom:</strong> <span id="menu-name">INCONNU</span></div>
            <div><strong>Chapitre:</strong> <span id="menu-chapter">Prologue</span></div>
            <div><strong>Alignement:</strong> <span id="menu-alignment">Neutre</span></div>
        </div>
        
        <div class="menu-section">
            <h3><i class="fas fa-star"></i> COMP√âTENCES</h3>
            <div class="skill-item">
                <span class="skill-name">Piratage de Ruche</span>
                <span class="skill-level" id="skill-hack">Niv. 0</span>
            </div>
            <div class="skill-item">
                <span class="skill-name">R√©silience Psychique</span>
                <span class="skill-level" id="skill-resist">Niv. 0</span>
            </div>
            <div class="skill-item">
                <span class="skill-name">Expertise Tactile</span>
                <span class="skill-level" id="skill-tech">Niv. 0</span>
            </div>
            <div class="skill-item">
                <span class="skill-name">Points disponibles:</span>
                <span class="skill-level" id="skill-points">0</span>
            </div>
        </div>
        
        <div class="menu-section">
            <h3><i class="fas fa-briefcase"></i> INVENTAIRE</h3>
            <div id="inventory-list">
                <div class="inventory-item"><i class="fas fa-id-card"></i> Pass Navigo</div>
                <!-- Les objets seront ajout√©s dynamiquement -->
            </div>
        </div>
        
        <div class="menu-section">
            <h3><i class="fas fa-cog"></i> OPTIONS</h3>
            <button class="choice-btn" style="margin-bottom: 10px;" onclick="saveGame()">
                <i class="fas fa-save"></i> Sauvegarder
            </button>
            <button class="choice-btn" style="margin-bottom: 10px;" onclick="loadGame()">
                <i class="fas fa-folder-open"></i> Charger
            </button>
            <button class="choice-btn" style="background-color: rgba(255, 77, 77, 0.2);" onclick="resetGame()">
                <i class="fas fa-redo"></i> Recommencer
            </button>
        </div>
    </div>

    <div id="effects-overlay"></div>

    <script>
        // ==================== CONFIGURATION DU JEU ====================
        const gameConfig = {
            initialHealth: 100,
            initialSync: 0,
            initialXP: 0,
            syncWarningThreshold: 50,
            syncDangerThreshold: 80,
            xpPerChapter: 100,
            baseSkillCost: 10
        };

        // ==================== √âTAT DU JEU ====================
        let gameState = {
            playerName: "INCONNU",
            currentChapter: "start",
            sync: 0,
            health: 100,
            xp: 0,
            alignment: "neutral",
            alignmentScore: 0, // n√©gatif = pro-Carol, positif = pro-Laxmi
            skills: {
                hack: 0,
                resist: 0,
                tech: 0
            },
            skillPoints: 0,
            inventory: ["Pass Navigo"],
            visitedChapters: new Set(["start"]),
            choicesHistory: []
        };

        // ==================== DONN√âES DE L'HISTOIRE ====================
        const storyData = {
            start: {
                text: "BRUXELLES. RUE NEUVE. Un silence de mort. Tu te r√©veilles au sol, le cr√¢ne explosant de douleur. Le 'Lien' vient d'√™tre bris√© par une onde de choc mondiale. Tu vomis un liquide noir et visqueux... ton corps rejette la Ruche.",
                scene: "üèôÔ∏è",
                choices: [
                    { text: "Se lever avec peine et chercher son nom", next: "naming", xp: 5 }
                ]
            },
            
            naming: {
                text: "La douleur s'estompe lentement. Tu aper√ßois un vieux pass Navigo au sol, √† moiti√© calcin√©. Quel √©tait ton nom, avant le Lien ?",
                scene: "üí≥",
                type: "input",
                next: "awakening"
            },
            
            awakening: {
                text: "Une silhouette appara√Æt dans l'encadrement de la porte. Marc, ton voisin. Ses yeux sont vides, trop calmes. Il te tend une tasse fumante de prot√©ines HDP. 'Tu as faim, nous le sentons tous. Reviens dans le Lien. La solitude est une maladie.'",
                scene: "üë§",
                choices: [
                    { 
                        text: "Accepter la tasse (Rester connect√©)", 
                        next: "stay_connected", 
                        sync: 15, 
                        alignment: 5,
                        xp: 10
                    },
                    { 
                        text: "Renverser la tasse (Refuser)", 
                        next: "rebel", 
                        sync: -5, 
                        alignment: -5,
                        xp: 15
                    },
                    { 
                        text: "Frapper Marc et fuir par l'escalier", 
                        next: "violence", 
                        health: -10,
                        alignment: -10,
                        xp: 20
                    }
                ]
            },
            
            stay_connected: {
                text: "Le liquide est ti√®de, sucr√©-amer. Aussit√¥t, les murmures de la Ruche reviennent en fond sonore. Tu sais instinctivement que Diabat√© surveille la ville. Tu te sens en s√©curit√©, prot√©g√©... mais ton 'Moi' s'efface comme du sable dans la mar√©e.",
                scene: "üß¨",
                choices: [
                    { 
                        text: "Prendre la radio de Marc et sortir discr√®tement", 
                        next: "escape_brussels",
                        xp: 10
                    }
                ]
            },
            
            rebel: {
                text: "La tasse se brise en mille morceaux. Marc penche la t√™te, une tristesse infinie dans le regard. 'La solitude te d√©truira, [NOM].' Mais tu sens une force incroyable monter en toi : tu es LIBRE. Pour la premi√®re fois depuis des mois, tu penses par toi-m√™me.",
                scene: "üíî",
                inventoryAdd: "Radio portable",
                choices: [
                    { 
                        text: "Prendre l'√©chelle de secours au fond du couloir", 
                        next: "escape_brussels",
                        xp: 10
                    }
                ]
            },
            
            violence: {
                text: "Tu le pousses violemment. Il tombe sans un bruit, sans col√®re. Les Pluribus ne connaissent pas la haine, seulement la tristesse. Tu d√©vales les escaliers quatre √† quatre, le c≈ìur battant la chamade. Tu viens de franchir un point de non-retour.",
                scene: "üèÉ‚Äç‚ôÇÔ∏è",
                health: -5,
                inventoryAdd: "Couteau de poche",
                choices: [
                    { 
                        text: "Sortir dans la rue d√©serte", 
                        next: "escape_brussels",
                        xp: 15
                    }
                ]
            },
            
            escape_brussels: {
                text: "Dehors, l'apocalypse. Le ciel a vir√© au violet √©lectrique. Des centaines de Pluribus sont fig√©s dans la rue, certains saignent du nez. Un drone de Diabat√© survole la zone. Son haut-parleur crache : 'ALERTE : DISSIDENT D√âTECT√â. NEUTRALISATION AUTORIS√âE.' Le voyage vers Carol commence.",
                scene: "üöÅ",
                choices: [
                    { 
                        text: "Chercher un v√©hicule pour fuir vers le sud", 
                        next: "car_theft",
                        xp: 10
                    }
                ]
            },
            
            car_theft: {
                text: "Une voiture √©lectrique des Autres est gar√©e porte ouverte. Tu n'as pas besoin de cl√©s. En posant ta main sur le tableau de bord, tes r√©sidus de connexion 'parlent' au syst√®me. L'√©cran s'allime : 'BIENVENUE, [NOM]. DESTINATION ?'. Le moteur d√©marre en silence.",
                scene: "üöó",
                sync: 5,
                inventoryAdd: "Voiture √©lectrique",
                choices: [
                    { 
                        text: "Rouler vers le sud, direction la fronti√®re", 
                        next: "pursuit_laxmi",
                        xp: 5
                    }
                ]
            },
            
            pursuit_laxmi: {
                text: "L'√©cran de bord s'allume soudain. C'est le visage de Laxmi, empreint d'une tristesse rageuse. 'Arr√™te-toi, [NOM]. Le monde se d√©chire √† cause de votre folie. Si tu franchis la porte d'Anderlecht, nous te consid√©rerons comme une menace pour l'√©quilibre.' Deux voitures Sentinelles surgissent derri√®re toi.",
                scene: "üöìüöì",
                choices: [
                    { 
                        text: "Percuter une Sentinelle (Force brute)", 
                        next: "collide_sentinel", 
                        sync: -10,
                        alignment: -10,
                        health: -15,
                        xp: 25,
                        requiresSkill: "tech",
                        skillLevel: 0
                    },
                    { 
                        text: "Surcharger leurs syst√®mes (Piratage)", 
                        next: "overload_sentinels", 
                        sync: 15,
                        alignment: -5,
                        xp: 30,
                        requiresSkill: "hack",
                        skillLevel: 1
                    },
                    { 
                        text: "Tenter de n√©gocier avec Laxmi", 
                        next: "negotiate_laxmi", 
                        alignment: 10,
                        xp: 20
                    }
                ]
            }
        };

        // ==================== FONCTIONS DU JEU ====================
        
        // Initialisation
        function initGame() {
            loadGame(); // Essaie de charger une sauvegarde
            updateGame(gameState.currentChapter);
            updateMenu();
            
            // Gestion du menu lat√©ral
            document.getElementById('side-menu-btn').addEventListener('click', toggleMenu);
            document.getElementById('game-container').addEventListener('click', closeMenu);
            
            // V√©rifie si c'est une premi√®re visite
            if(!localStorage.getItem('pluribusFirstVisit')) {
                showMessage("Bienvenue dans PLURIBUS : REBORN. Votre synchro mesure votre lien r√©siduel avec la Ruche. Gardez-la basse pour pr√©server votre humanit√©.", 5000);
                localStorage.setItem('pluribusFirstVisit', 'true');
            }
        }
        
        // Mise √† jour de l'interface jeu
        function updateGame(chapterKey) {
            const chapter = storyData[chapterKey];
            if (!chapter) {
                console.error("Chapitre non trouv√©:", chapterKey);
                return;
            }
            
            // Mettre √† jour l'√©tat
            gameState.currentChapter = chapterKey;
            gameState.visitedChapters.add(chapterKey);
            
            // Mettre √† jour les √©l√©ments visuels
            document.getElementById('scene-emoji').textContent = chapter.scene;
            document.getElementById('story-text').textContent = 
                chapter.text.replace(/\[NOM\]/g, gameState.playerName);
            
            // Effet machine √† √©crire
            typewriterEffect(chapter.text.replace(/\[NOM\]/g, gameState.playerName));
            
            // Nettoyer les anciens choix
            const choicesContainer = document.getElementById('choices-container');
            choicesContainer.innerHTML = '';
            
            // Gestion des types sp√©ciaux
            if (chapter.type === 'input') {
                handleInputChapter(chapter);
                return;
            }
            
            // Ajouter les nouveaux choix
            if (chapter.choices && chapter.choices.length > 0) {
                chapter.choices.forEach(choice => {
                    // V√©rifier les pr√©requis de comp√©tence
                    if (choice.requiresSkill && gameState.skills[choice.requiresSkill] < (choice.skillLevel || 0)) {
                        return; // Ne pas afficher ce choix si le joueur n'a pas le niveau requis
                    }
                    
                    const button = document.createElement('button');
                    button.className = 'choice-btn';
                    
                    // Texte du choix avec indicateur XP
                    let buttonText = choice.text;
                    if (choice.xp) {
                        buttonText += ` <span class="choice-sync positive">+${choice.xp}XP</span>`;
                    }
                    if (choice.sync) {
                        const syncClass = choice.sync > 0 ? 'negative' : 'positive';
                        const syncSymbol = choice.sync > 0 ? '‚ñ≤' : '‚ñº';
                        buttonText += ` <span class="choice-sync ${syncClass}">${syncSymbol}${Math.abs(choice.sync)}%</span>`;
                    }
                    if (choice.health) {
                        const healthClass = choice.health > 0 ? 'positive' : 'negative';
                        const healthSymbol = choice.health > 0 ? '‚ù§Ô∏è' : 'üíî';
                        buttonText += ` <span class="choice-sync ${healthClass}">${healthSymbol}${Math.abs(choice.health)}</span>`;
                    }
                    
                    button.innerHTML = buttonText;
                    
                    // Gestion du clic
                    button.addEventListener('click', () => {
                        makeChoice(choice, chapterKey);
                    });
                    
                    // Effet de survol tactile
                    button.addEventListener('touchstart', () => {
                        button.style.transform = 'translateY(2px)';
                    });
                    
                    button.addEventListener('touchend', () => {
                        button.style.transform = 'translateY(0)';
                    });
                    
                    choicesContainer.appendChild(button);
                });
            }
            
            // Ajouter un choix de secours si aucun choix n'est disponible
            if (choicesContainer.children.length === 0) {
                const fallbackButton = document.createElement('button');
                fallbackButton.className = 'choice-btn';
                fallbackButton.textContent = "Continuer...";
                fallbackButton.addEventListener('click', () => {
                    gameState.currentChapter = "start";
                    updateGame("start");
                });
                choicesContainer.appendChild(fallbackButton);
            }
            
            // Effets visuels en fonction de la synchro
            updateVisualEffects();
            updateMenu();
        }
        
        // Gestion des chapitres de type input
        function handleInputChapter(chapter) {
            const name = prompt("Entre ton pr√©nom (avant le Lien) :", gameState.playerName);
            if (name && name.trim() !== '') {
                gameState.playerName = name.trim().toUpperCase();
                document.getElementById('player-name').textContent = gameState.playerName;
                document.getElementById('menu-name').textContent = gameState.playerName;
                
                // Ajouter XP pour la d√©couverte de l'identit√©
                gameState.xp += 20;
                updateStats();
                
                // Passer au chapitre suivant
                setTimeout(() => updateGame(chapter.next), 500);
            } else {
                // Nom invalide, r√©essayer
                setTimeout(() => updateGame('naming'), 100);
            }
        }
        
        // Lorsqu'un choix est fait
        function makeChoice(choice, fromChapter) {
            // Enregistrer dans l'historique
            gameState.choicesHistory.push({
                chapter: fromChapter,
                choice: choice.text,
                timestamp: new Date().toISOString()
            });
            
            // Appliquer les effets du choix
            if (choice.sync) {
                gameState.sync = Math.max(0, Math.min(100, gameState.sync + choice.sync));
            }
            
            if (choice.health) {
                gameState.health = Math.max(0, Math.min(100, gameState.health + choice.health));
            }
            
            if (choice.xp) {
                gameState.xp += choice.xp;
                
                // V√©rifier les points de comp√©tence
                const newSkillPoints = Math.floor(gameState.xp / 100);
                if (newSkillPoints > Math.floor((gameState.xp - choice.xp) / 100)) {
                    gameState.skillPoints += 1;
                    showMessage(`Nouveau point de comp√©tence disponible !`, 3000);
                }
            }
            
            if (choice.alignment) {
                gameState.alignmentScore += choice.alignment;
                if (gameState.alignmentScore < -20) gameState.alignment = "pro-Carol";
                else if (gameState.alignmentScore > 20) gameState.alignment = "pro-Laxmi";
                else gameState.alignment = "neutre";
            }
            
            if (choice.inventoryAdd && !gameState.inventory.includes(choice.inventoryAdd)) {
                gameState.inventory.push(choice.inventoryAdd);
                showMessage(`Objet ajout√© : ${choice.inventoryAdd}`, 2000);
            }
            
            // Mettre √† jour les stats
            updateStats();
            
            // Effets sp√©ciaux pour certains choix
            if (choice.sync && Math.abs(choice.sync) >= 10) {
                triggerGlitchEffect(800);
            }
            
            if (choice.health && choice.health < 0) {
                triggerDamageEffect();
            }
            
            // Passer au chapitre suivant
            setTimeout(() => {
                if (choice.next && storyData[choice.next]) {
                    updateGame(choice.next);
                } else {
                    // Chapitre suivant non trouv√©, revenir au d√©but
                    console.warn("Chapitre suivant non trouv√©:", choice.next);
                    updateGame("start");
                }
            }, 500);
        }
        
        // Mettre √† jour les statistiques affich√©es
        function updateStats() {
            // Mettre √† jour les valeurs
            document.getElementById('sync-value').textContent = `${gameState.sync}%`;
            document.getElementById('health-value').textContent = `${gameState.health}%`;
            document.getElementById('xp-value').textContent = gameState.xp;
            
            // Mettre √† jour les barres de progression
            document.getElementById('sync-fill').style.width = `${gameState.sync}%`;
            document.getElementById('health-fill').style.width = `${gameState.health}%`;
            
            // Mettre √† jour les comp√©tences dans le menu
            document.getElementById('skill-hack').textContent = `Niv. ${gameState.skills.hack}`;
            document.getElementById('skill-resist').textContent = `Niv. ${gameState.skills.resist}`;
            document.getElementById('skill-tech').textContent = `Niv. ${gameState.skills.tech}`;
            document.getElementById('skill-points').textContent = gameState.skillPoints;
            
            // Effets visuels selon la synchro
            updateVisualEffects();
            
            // Sauvegarder automatiquement
            saveGame();
        }
        
        // Effets visuels en fonction de la synchro
        function updateVisualEffects() {
            const body = document.body;
            const syncValue = gameState.sync;
            
            // Retirer toutes les classes d'effet
            body.classList.remove('low-sync', 'medium-sync', 'high-sync', 'critical-sync');
            
            // Ajouter la classe appropri√©e
            if (syncValue >= 80) {
                body.classList.add('critical-sync');
                document.getElementById('scanlines').style.opacity = '0.3';
                document.getElementById('vignette').style.opacity = '0.8';
                
                // Effet de pulsation critique
                if (!window.criticalPulseInterval) {
                    window.criticalPulseInterval = setInterval(() => {
                        document.getElementById('scene-emoji').style.filter = 
                            `drop-shadow(0 0 20px rgba(138, 43, 226, ${0.5 + Math.random() * 0.5}))`;
                    }, 300);
                }
                
            } else if (syncValue >= 50) {
                body.classList.add('high-sync');
                document.getElementById('scanlines').style.opacity = '0.2';
                document.getElementById('vignette').style.opacity = '0.6';
                
                // Arr√™ter la pulsation critique si elle √©tait active
                if (window.criticalPulseInterval) {
                    clearInterval(window.criticalPulseInterval);
                    window.criticalPulseInterval = null;
                }
                
            } else if (syncValue >= 30) {
                body.classList.add('medium-sync');
                document.getElementById('scanlines').style.opacity = '0.1';
                document.getElementById('vignette').style.opacity = '0.4';
            } else {
                body.classList.add('low-sync');
                document.getElementById('scanlines').style.opacity = '0.05';
                document.getElementById('vignette').style.opacity = '0.2';
            }
        }
        
        // Effet machine √† √©crire
        function typewriterEffect(text) {
            const element = document.getElementById('story-text');
            element.textContent = '';
            let i = 0;
            
            function typeChar() {
                if (i < text.length) {
                    element.textContent += text.charAt(i);
                    i++;
                    
                    // Vitesse variable selon la synchro
                    const speed = gameState.sync > 70 ? 10 : gameState.sync > 40 ? 20 : 30;
                    setTimeout(typeChar, speed);
                }
            }
            
            typeChar();
        }
        
        // Effet de glitch
        function triggerGlitchEffect(duration) {
            const overlay = document.getElementById('effects-overlay');
            const scene = document.getElementById('scene-emoji');
            
            // Animation de glitch
            overlay.style.background = 'radial-gradient(circle, rgba(138,43,226,0.3) 0%, transparent 70%)';
            overlay.style.opacity = '0.7';
            scene.classList.add('glitch-active');
            
            // Vibration si support√©e
            if (navigator.vibrate) {
                navigator.vibrate([100, 50, 100]);
            }
            
            // R√©initialiser apr√®s la dur√©e
            setTimeout(() => {
                overlay.style.opacity = '0';
                scene.classList.remove('glitch-active');
            }, duration);
        }
        
        // Effet de d√©g√¢ts
        function triggerDamageEffect() {
            const overlay = document.getElementById('effects-overlay');
            overlay.style.background = 'radial-gradient(circle, rgba(255,77,77,0.4) 0%, transparent 70%)';
            overlay.style.opacity = '0.6';
            
            setTimeout(() => {
                overlay.style.opacity = '0';
            }, 300);
        }
        
        // Afficher un message temporaire
        function showMessage(message, duration) {
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background-color: rgba(26, 26, 26, 0.9);
                color: var(--accent-color);
                padding: 20px 30px;
                border-radius: 10px;
                border: 2px solid var(--accent-color);
                z-index: 1001;
                text-align: center;
                max-width: 80%;
                box-shadow: 0 0 30px rgba(138, 43, 226, 0.5);
                font-weight: bold;
            `;
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.style.transition = 'opacity 0.5s';
                messageDiv.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(messageDiv);
                }, 500);
            }, duration);
        }
        
        // Gestion du menu lat√©ral
        function toggleMenu() {
            const menu = document.getElementById('side-menu');
            const isOpen = menu.style.right === '0px';
            menu.style.right = isOpen ? '-300px' : '0px';
            
            // Animation du bouton
            const btn = document.getElementById('side-menu-btn');
            btn.innerHTML = isOpen ? '<i class="fas fa-bars"></i>' : '<i class="fas fa-times"></i>';
        }
        
        function closeMenu() {
            document.getElementById('side-menu').style.right = '-300px';
            document.getElementById('side-menu-btn').innerHTML = '<i class="fas fa-bars"></i>';
        }
        
        // Mettre √† jour le menu
        function updateMenu() {
            // Mettre √† jour les informations du personnage
            document.getElementById('menu-name').textContent = gameState.playerName;
            document.getElementById('menu-chapter').textContent = getChapterName(gameState.currentChapter);
            document.getElementById('menu-alignment').textContent = gameState.alignment;
            
            // Mettre √† jour l'inventaire
            const inventoryList = document.getElementById('inventory-list');
            inventoryList.innerHTML = '';
            
            gameState.inventory.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'inventory-item';
                itemDiv.innerHTML = `<i class="fas fa-box"></i> ${item}`;
                inventoryList.appendChild(itemDiv);
            });
            
            // Mettre √† jour les comp√©tences
            document.getElementById('skill-hack').textContent = `Niv. ${gameState.skills.hack}`;
            document.getElementById('skill-resist').textContent = `Niv. ${gameState.skills.resist}`;
            document.getElementById('skill-tech').textContent = `Niv. ${gameState.skills.tech}`;
            document.getElementById('skill-points').textContent = gameState.skillPoints;
            
            // Ajouter des boutons pour am√©liorer les comp√©tences
            addSkillUpgradeButtons();
        }
        
        function addSkillUpgradeButtons() {
            const skillSection = document.querySelector('.menu-section:nth-child(2)');
            
            // Nettoyer les anciens boutons d'am√©lioration
            document.querySelectorAll('.upgrade-btn').forEach(btn => btn.remove());
            
            // Ajouter des boutons d'am√©lioration pour chaque comp√©tence
            const skills = [
                { id: 'hack', name: 'Piratage de Ruche', cost: gameConfig.baseSkillCost * (gameState.skills.hack + 1) },
                { id: 'resist', name: 'R√©silience Psychique', cost: gameConfig.baseSkillCost * (gameState.skills.resist + 1) },
                { id: 'tech', name: 'Expertise Tactile', cost: gameConfig.baseSkillCost * (gameState.skills.tech + 1) }
            ];
            
            skills.forEach(skill => {
                if (gameState.skillPoints > 0) {
                    const upgradeBtn = document.createElement('button');
                    upgradeBtn.className = 'choice-btn upgrade-btn';
                    upgradeBtn.style.marginTop = '5px';
                    upgradeBtn.style.padding = '8px';
                    upgradeBtn.style.fontSize = '12px';
                    upgradeBtn.innerHTML = `<i class="fas fa-arrow-up"></i> Am√©liorer ${skill.name} (${skill.cost} XP)`;
                    
                    upgradeBtn.addEventListener('click', () => {
                        upgradeSkill(skill.id, skill.cost);
                    });
                    
                    skillSection.appendChild(upgradeBtn);
                }
            });
        }
        
        function upgradeSkill(skillId, cost) {
            if (gameState.xp >= cost) {
                gameState.xp -= cost;
                gameState.skills[skillId] += 1;
                gameState.skillPoints -= 1;
                updateStats();
                updateMenu();
                showMessage(`${skillId === 'hack' ? 'Piratage' : skillId === 'resist' ? 'R√©silience' : 'Expertise'} am√©lior√©(e) !`, 2000);
            } else {
                showMessage(`Pas assez d'XP ! Il vous faut ${cost} XP.`, 2000);
            }
        }
        
        function getChapterName(chapterKey) {
            const chapterNames = {
                'start': 'Prologue: Bruxelles',
                'naming': 'Identit√©',
                'awakening': 'Le R√©veil',
                'stay_connected': 'La Connexion',
                'rebel': 'La R√©bellion',
                'violence': 'La Violence',
                'escape_brussels': 'La Fuite',
                'car_theft': 'Le V√©hicule',
                'pursuit_laxmi': 'La Poursuite'
            };
            return chapterNames[chapterKey] || chapterKey;
        }
        
        // Sauvegarde
        function saveGame() {
            const saveData = {
                version: 1.0,
                timestamp: new Date().toISOString(),
                gameState: gameState
            };
            
            try {
                localStorage.setItem('pluribusSave', JSON.stringify(saveData));
                console.log('Jeu sauvegard√©');
            } catch (e) {
                console.error('Erreur de sauvegarde:', e);
            }
        }
        
        function loadGame() {
            try {
                const saveData = JSON.parse(localStorage.getItem('pluribusSave'));
                
                if (saveData && saveData.gameState) {
                    // Charger l'√©tat du jeu
                    gameState = { ...saveData.gameState };
                    
                    // Convertir Set depuis JSON
                    if (gameState.visitedChapters && Array.isArray(gameState.visitedChapters)) {
                        gameState.visitedChapters = new Set(gameState.visitedChapters);
                    }
                    
                    // Mettre √† jour l'interface
                    document.getElementById('player-name').textContent = gameState.playerName;
                    updateStats();
                    
                    showMessage('Partie charg√©e', 2000);
                    return true;
                }
            } catch (e) {
                console.error('Erreur de chargement:', e);
            }
            
            return false;
        }
        
        function resetGame() {
            if (confirm('Recommencer une nouvelle partie ? Votre progression actuelle sera perdue.')) {
                // R√©initialiser l'√©tat du jeu
                gameState = {
                    playerName: "INCONNU",
                    currentChapter: "start",
                    sync: 0,
                    health: 100,
                    xp: 0,
                    alignment: "neutral",
                    alignmentScore: 0,
                    skills: { hack: 0, resist: 0, tech: 0 },
                    skillPoints: 0,
                    inventory: ["Pass Navigo"],
                    visitedChapters: new Set(["start"]),
                    choicesHistory: []
                };
                
                // Mettre √† jour l'interface
                document.getElementById('player-name').textContent = "INCONNU";
                updateStats();
                updateGame("start");
                
                showMessage('Nouvelle partie commenc√©e', 2000);
            }
        }
        
        // ==================== D√âMARRAGE DU JEU ====================
        // Attendre que le DOM soit charg√©
        document.addEventListener('DOMContentLoaded', initGame);
        
        // Pr√©venir la fermeture accidentelle
        window.addEventListener('beforeunload', (e) => {
            saveGame();
            // Sur mobile, on ne montre pas de confirmation pour une meilleure UX
        });
        
        // Gestion du retour en arri√®re sur mobile
        window.addEventListener('popstate', (e) => {
            // Emp√™cher le retour en arri√®re du navigateur
            history.pushState(null, null, window.location.pathname);
        });
        
        // Initialiser l'historique
        history.pushState(null, null, window.location.pathname);
    </script>
</body>
</html>
