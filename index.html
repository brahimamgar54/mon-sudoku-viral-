<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SUDOKU: THE WATCHER</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');
        :root { --bg: #000; --blood: #ff0000; --terminal: #a0a0a0; }
        body {
            background: var(--bg); color: var(--terminal); font-family: 'VT323', monospace;
            margin: 0; height: 100vh; overflow: hidden; display: flex; align-items: center; justify-content: center;
        }
        /* SCANLINES CRT */
        body::before {
            content: " "; display: block; position: absolute; inset: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.3) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.05), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.05));
            z-index: 998; background-size: 100% 3px, 3px 100%; pointer-events: none;
        }

        #ui-layer { display: none; width: 95%; max-width: 450px; flex-direction: column; align-items: center; z-index: 10; }

        /* LE DEMON VISUEL */
        #demon-container {
            width: 150px; height: 150px; position: relative; margin-bottom: 10px;
            border: 2px solid #222; background: #050000; overflow: hidden;
        }
        #demon-sprite {
            width: 100%; height: 100%; object-fit: cover;
            filter: grayscale(0.5) sepia(0.5) hue-rotate(-50deg);
        }
        .talking { animation: jaw-move 0.1s infinite; }
        @keyframes jaw-move { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05) translateY(-2px); } }
        .angry { filter: grayscale(0) brightness(1.5) drop-shadow(0 0 10px red) !important; animation: shake 0.1s infinite !important; }

        #demon-msg {
            min-height: 50px; color: var(--blood); text-align: center; font-size: 1.2rem;
            margin-bottom: 10px; text-shadow: 0 0 5px #4a0000;
        }

        #stress-bar-container { width: 100%; height: 8px; background: #111; border: 1px solid #333; margin-bottom: 15px; }
        #stress-bar { width: 0%; height: 100%; background: var(--blood); box-shadow: 0 0 10px red; }

        #grid { display: grid; grid-template-columns: repeat(9, 1fr); gap: 1px; background: #333; width: 100%; aspect-ratio: 1; border: 2px solid #222; }
        .cell { background: #000; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; cursor: pointer; color: #666; }
        .cell.fixed { color: #333; pointer-events: none; background: #050505; }
        .cell.selected { background: #300; color: #fff; box-shadow: inset 0 0 10px red; }
        
        #keypad { display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; width: 100%; margin-top: 15px; }
        .key { background: #111; border: 1px solid #333; color: #fff; padding: 10px; text-align: center; cursor: pointer; }
        
        #cinematic-overlay {
            display: none; position: fixed; inset: 0; background: #000; z-index: 5000;
            flex-direction: column; align-items: center; justify-content: center; padding: 20px; color: var(--blood);
        }
        .btn-blood { background: #000; border: 1px solid red; color: red; padding: 15px 30px; font-family: 'VT323'; font-size: 1.5rem; cursor: pointer; margin-top: 20px; }
        
        @keyframes shake { 0% {transform: translate(1px, 1px)} 50% {transform: translate(-1px, -1px)} 100% {transform: translate(1px, -1px)} }
    </style>
</head>
<body>

<div id="start-overlay" style="text-align:center; z-index:6000;">
    <h1 style="color:red; font-size:3rem;">SUDOKU: SOUL TRAP</h1>
    <button class="btn-blood" onclick="initGame()">COMMENCER LE SUPPLICE</button>
</div>

<div id="cinematic-overlay">
    <div id="cinematic-text" style="font-size: 1.5rem; white-space: pre-wrap; max-width: 600px;"></div>
    <button id="retry-btn" class="btn-blood" style="display:none" onclick="location.reload()">RENAÎTRE</button>
</div>

<div id="ui-layer">
    <div id="demon-container">
        <img id="demon-sprite" src="https://api.deepai.org/job-view-file/6064f27e-89a3-4876-8051-583348600d89/outputs/output.jpg" alt="DEMON">
    </div>
    <div id="demon-msg">... JE T'OBSERVE ...</div>
    
    <div style="width:100%; display:flex; justify-content:space-between; font-size:0.8rem; color:#444;">
        <span>NIVEAU <span id="lvl-val">1</span>/100</span>
        <span id="p-name">COBAYE</span>
    </div>
    <div id="stress-bar-container"><div id="stress-bar"></div></div>

    <div id="grid"></div>
    <div id="keypad">
        <div class="key" onclick="press(1)">1</div><div class="key" onclick="press(2)">2</div>
        <div class="key" onclick="press(3)">3</div><div class="key" onclick="press(4)">4</div>
        <div class="key" onclick="press(5)">5</div><div class="key" onclick="press(6)">6</div>
        <div class="key" onclick="press(7)">7</div><div class="key" onclick="press(8)">8</div>
        <div class="key" onclick="press(9)">9</div><div class="key" onclick="press('X')" style="color:red">X</div>
    </div>
</div>

<script>
const GAME = {
    lvl: 1, stress: 0, active: false, sel: null, 
    grid: [], sol: [], name: "JOUEUR"
};

const AUDIO = {
    ctx: null,
    init() { this.ctx = new (window.AudioContext || window.webkitAudioContext)(); },
    speak(txt) {
        window.speechSynthesis.cancel();
        const ut = new SpeechSynthesisUtterance(txt);
        ut.lang = 'fr-FR'; ut.pitch = 0.1; ut.rate = 0.7;
        
        // Animation bouche
        const sprite = document.getElementById('demon-sprite');
        sprite.classList.add('talking');
        ut.onend = () => sprite.classList.remove('talking');

        // Basse fréquence
        const osc = this.ctx.createOscillator();
        const g = this.ctx.createGain();
        osc.type = 'sawtooth'; osc.frequency.setValueAtTime(40, this.ctx.currentTime);
        g.gain.setValueAtTime(0.3, this.ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 2);
        osc.connect(g); g.connect(this.ctx.destination);
        osc.start(); osc.stop(this.ctx.currentTime + 2);

        window.speechSynthesis.speak(ut);
        document.getElementById('demon-msg').innerText = txt;
    }
};

const DEATHS = [
    "SCÉNARIO #666 : Tes côtes éclatent vers l'intérieur. Ton cœur est broyé par tes propres os.",
    "SCÉNARIO #13 : Tes yeux bouillent dans leurs orbites. La dernière chose que tu sens est l'odeur de ta propre chair roussie.",
    "SCÉNARIO #09 : Des mains invisibles t'arrachent la langue par la gorge. Tu étouffes dans ton silence."
];

function initGame() {
    document.getElementById('start-overlay').style.display = 'none';
    document.getElementById('ui-layer').style.display = 'flex';
    AUDIO.init();
    startLevel();
    loop();
}

function startLevel() {
    if(GAME.lvl > 100) { winGame(); return; }
    
    GAME.stress = 0;
    // Difficulté progressive
    let holes = 10; 
    if(GAME.lvl > 10) holes = 25;
    if(GAME.lvl > 50) holes = 45;
    if(GAME.lvl > 80) holes = 60;

    document.getElementById('lvl-val').innerText = GAME.lvl;
    generateSudoku(holes);
    render();
    
    if(GAME.lvl % 10 === 0) AUDIO.speak("Tu crois vraiment pouvoir atteindre le niveau 100 ?");
}

function generateSudoku(holes) {
    GAME.sol = Array(81).fill(0);
    fill(GAME.sol);
    GAME.grid = [...GAME.sol];
    for(let i=0; i<holes; i++) {
        let idx = Math.floor(Math.random()*81);
        GAME.grid[idx] = 0;
    }
}

function render() {
    const container = document.getElementById('grid');
    container.innerHTML = '';
    GAME.grid.forEach((v, i) => {
        const c = document.createElement('div');
        c.className = v !== 0 ? 'cell fixed' : 'cell';
        c.innerText = v !== 0 ? v : '';
        c.onclick = () => {
            document.querySelectorAll('.cell').forEach(el=>el.classList.remove('selected'));
            c.classList.add('selected');
            GAME.sel = i;
        };
        container.appendChild(c);
    });
}

function press(n) {
    if(GAME.sel === null) return;
    if(n === 'X') { 
        if(!document.getElementById('grid').children[GAME.sel].classList.contains('fixed'))
            document.getElementById('grid').children[GAME.sel].innerText = ''; 
        return; 
    }

    if(n == GAME.sol[GAME.sel]) {
        GAME.grid[GAME.sel] = n;
        const c = document.getElementById('grid').children[GAME.sel];
        c.innerText = n; c.className = 'cell fixed';
        if(!GAME.grid.includes(0)) { GAME.lvl++; startLevel(); }
    } else {
        GAME.stress += 20;
        const s = document.getElementById('demon-sprite');
        s.classList.add('angry');
        AUDIO.speak("PATHÉTIQUE !");
        setTimeout(() => s.classList.remove('angry'), 1000);
    }
}

function loop() {
    // Vitesse du stress augmente avec le niveau
    let speed = 0.03 + (GAME.lvl * 0.005);
    GAME.stress += speed;
    document.getElementById('stress-bar').style.width = GAME.stress + "%";

    if(GAME.stress >= 100) {
        gameOver();
    } else {
        requestAnimationFrame(loop);
    }
}

function gameOver() {
    GAME.active = false;
    const ov = document.getElementById('cinematic-overlay');
    const txt = document.getElementById('cinematic-text');
    ov.style.display = 'flex';
    
    let msg = DEATHS[Math.floor(Math.random()*DEATHS.length)];
    let i = 0;
    ov.onclick = null;
    
    const typer = setInterval(() => {
        txt.innerHTML = msg.substring(0, i);
        i++;
        if(i > msg.length) {
            clearInterval(typer);
            document.getElementById('retry-btn').style.display = 'block';
        }
    }, 50);
}

function winGame() {
    const ov = document.getElementById('cinematic-overlay');
    const txt = document.getElementById('cinematic-text');
    ov.style.display = 'flex';
    AUDIO.speak("Tu as de la chance pour cette fois... On se reverra.");
    
    setTimeout(() => {
        txt.innerHTML = "Tu te réveilles en sursaut dans ton lit.\nTon front est trempé de sueur.\nC'était... juste un rêve ?\n\nSur ton table de chevet, un papier est posé.\nIl n'y a qu'un chiffre écrit dessus : 101.";
    }, 3000);
}

// Helper Sudoku
function fill(b){
    const isValid=(b,p,n)=>{
        let r=Math.floor(p/9),c=p%9;
        for(let i=0;i<9;i++) if(b[r*9+i]==n||b[i*9+c]==n) return false;
        let rr=Math.floor(r/3)*3,cc=Math.floor(c/3)*3;
        for(let i=0;i<3;i++)for(let j=0;j<3;j++) if(b[(rr+i)*9+(cc+j)]==n) return false;
        return true;
    };
    const solve=(b)=>{
        for(let i=0;i<81;i++){
            if(b[i]==0){
                let nums=[1,2,3,4,5,6,7,8,9].sort(()=>Math.random()-0.5);
                for(let n of nums){
                    if(isValid(b,i,n)){
                        b[i]=n;
                        if(solve(b)) return true;
                        b[i]=0;
                    }
                }
                return false;
            }
        }
        return true;
    };
    solve(b);
}
</script>
</body>
</html>
