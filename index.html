<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLURIBUS: ÉCHO RÉSIDUEL</title>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --text-color: #f0f0f0;
            --accent-color: #888;
            --font-main: 'Courier New', Courier, monospace;
        }

        /* THÈME: SEUL / CALME (Jaune/Blanc) */
        body.theme-solo {
            --bg-color: #fdf6e3; /* Blanc cassé/Jaune pâle */
            --text-color: #2c3e50; /* Noir/Gris foncé */
            --accent-color: #b58900;
        }

        /* THÈME: RUCHE / OPPRESSANT (Bleu/Noir) */
        body.theme-hive {
            --bg-color: #000510; /* Noir bleuté */
            --text-color: #64b5f6; /* Bleu électrique */
            --accent-color: #1e88e5;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-main);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            transition: background-color 1s ease, color 1s ease;
            overflow: hidden;
        }

        #game-container {
            width: 100%;
            max-width: 800px;
            border: 2px solid var(--text-color);
            padding: 20px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
        }

        h1, h2 {
            text-transform: uppercase;
            letter-spacing: 2px;
            text-align: center;
        }

        #hud {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--accent-color);
            padding-bottom: 10px;
            font-size: 0.9em;
        }

        #story-text {
            font-size: 1.1em;
            line-height: 1.6;
            margin-bottom: 30px;
            min-height: 150px;
        }

        .choices {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        button {
            background: transparent;
            border: 1px solid var(--text-color);
            color: var(--text-color);
            padding: 15px;
            font-family: var(--font-main);
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
        }

        button:hover {
            background-color: var(--text-color);
            color: var(--bg-color);
            font-weight: bold;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #input-area {
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
        }

        input {
            padding: 10px;
            font-size: 1.2em;
            background: transparent;
            border: 1px solid var(--text-color);
            color: var(--text-color);
            text-align: center;
        }

        .glitch {
            animation: glitch 1s infinite;
        }

        @keyframes glitch {
            0% { transform: translate(0) }
            20% { transform: translate(-2px, 2px) }
            40% { transform: translate(-2px, -2px) }
            60% { transform: translate(2px, 2px) }
            80% { transform: translate(2px, -2px) }
            100% { transform: translate(0) }
        }

        #status-bar {
            margin-top: 10px;
            font-size: 0.8em;
            color: var(--accent-color);
        }
    </style>
</head>
<body class="theme-solo">

    <div id="game-container">
        <div id="hud" style="display:none;">
            <span id="chap-display">CHAPITRE 1</span>
            <span id="stats-display">Soupçon: 0%</span>
        </div>

        <div id="main-menu">
            <h1>PLURIBUS<br><small>Saison 2 : La Ruche Brisée</small></h1>
            <p style="text-align:center;">Veuillez vous identifier pour la synchronisation.</p>
            <div id="input-area">
                <input type="text" id="player-name" placeholder="Votre Nom" autocomplete="off">
                <button onclick="startGame()">INITIALISER LE RÉVEIL</button>
            </div>
            <p style="font-size:0.8em; text-align:center; margin-top:20px;">⚠️ Activez le son. Ce jeu utilise la synthèse vocale.</p>
        </div>

        <div id="game-area" style="display:none;">
            <div id="story-text"></div>
            <div class="choices" id="choices-container"></div>
            <div id="status-bar"></div>
        </div>
    </div>

    <script>
        // --- ETAT DU JEU ---
        const state = {
            name: "Inconnu",
            chapter: 1,
            sequence: 1,
            suspicion: 0,     // 0-100 (Si 100 = Game Over)
            humanity: 50,     // Détermine les fins
            inventory: [],
            flags: {}         // Pour se souvenir des choix passés
        };

        // --- MOTEUR AUDIO (TTS) ---
        const synth = window.speechSynthesis;
        let voices = [];

        function loadVoices() {
            voices = synth.getVoices();
        }

        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = loadVoices;
        }

        function speak(text, type = "narrator") {
            // Annuler la parole précédente
            synth.cancel();

            // Remplacer le placeholder {name} par le vrai nom
            const textToSpeak = text.replace(/{name}/g, state.name);
            
            const utterThis = new SpeechSynthesisUtterance(textToSpeak);
            utterThis.lang = 'fr-FR';

            // Sélection de la voix et réglages selon le type
            // Note: Les navigateurs ont des voix différentes. On essaie de trouver une voix adaptée.
            const frVoices = voices.filter(v => v.lang.includes('fr'));
            const selectedVoice = frVoices.length > 0 ? frVoices[0] : null; // Par défaut

            if (selectedVoice) utterThis.voice = selectedVoice;

            if (type === "hive") {
                utterThis.pitch = 0.5; // Voix grave
                utterThis.rate = 0.8;  // Lent
            } else if (type === "system") {
                utterThis.pitch = 1.2; // Robotique
                utterThis.rate = 1.1;
            } else {
                utterThis.pitch = 1.0; // Normal
                utterThis.rate = 1.0;
            }

            synth.speak(utterThis);
        }

        // --- MOTEUR GRAPHIQUE ---
        function setTheme(mode) {
            const body = document.body;
            if (mode === 'hive') {
                body.className = 'theme-hive';
            } else {
                body.className = 'theme-solo';
            }
        }

        // --- DONNÉES DU SCÉNARIO ---
        // Structure: ID_SCENE: { text, theme, choices: [{text, next, effect}] }
        const scenes = {
            // CHAPITRE 1 : LE RÉVEIL (Bruxelles)
            'start': {
                text: "Système redémarré. Douleur pariétale détectée. {name}, ouvrez les yeux. Vous êtes dans votre appartement à Bruxelles. Tout est détruit. Le silence est anormal.",
                theme: 'solo',
                choices: [
                    { text: "Se lever et vérifier la fenêtre", next: 'c1_window' },
                    { text: "Rester au sol et écouter", next: 'c1_listen' }
                ]
            },
            'c1_window': {
                text: "Dehors, ils sont là. Les Autres. Immobiles dans la rue, le regard tourné vers le ciel violet. Vous n'êtes plus connecté à eux, mais ils ne le savent pas encore. Vous sentez votre cœur battre... une sensation individuelle terrifiante.",
                theme: 'solo',
                choices: [
                    { text: "Sortir prudemment", next: 'c1_street' },
                    { text: "Chercher une arme d'abord", next: 'c1_search', effect: () => { state.inventory.push('tuyau'); } }
                ]
            },
            'c1_listen': {
                text: "Vous entendez des pas dans le couloir. Rythmiques. Synchronisés. Ce n'est pas un humain normal. C'est une unité de la Ruche.",
                theme: 'hive',
                choices: [
                    { text: "Se cacher sous le bureau", next: 'c1_hide' },
                    { text: "Faire semblant d'être connecté (Regard vide)", next: 'c1_mimic' }
                ]
            },
            'c1_search': {
                text: "Vous trouvez un tuyau en métal lourd. Votre mémoire musculaire s'active : vous savez comment l'utiliser. C'est un reste des connaissances de la Ruche.",
                theme: 'solo',
                choices: [
                    { text: "Sortir maintenant", next: 'c1_street' }
                ]
            },
            'c1_mimic': {
                text: "La porte s'ouvre. Un voisin, transformé, entre. Il vous scanne du regard. Vous fixez le vide. Il prononce d'une voix sans timbre : 'Unité {name}, rapport de statut.'",
                theme: 'hive',
                choices: [
                    { text: "Répondre : 'Statut nominal. En attente.'", next: 'c1_street_hive', effect: () => { state.suspicion += 10; } },
                    { text: "Ne rien dire (Risqué)", next: 'c1_fail_mimic' }
                ]
            },
            'c1_hide': {
                text: "L'unité entre. Elle renifle l'air. Elle sait qu'il y a une individualité ici. La peur fait monter votre rythme cardiaque. Elle approche de votre cachette.",
                theme: 'hive',
                choices: [
                    { text: "Attaquer par surprise", next: 'c1_attack' },
                    { text: "Fuir par l'escalier de secours", next: 'c1_street' }
                ]
            },
            'c1_attack': {
                text: "Violence brute. Vous le neutralisez, mais le bruit a alerté la rue. Vous devez fuir immédiatement.",
                theme: 'solo',
                choices: [
                    { text: "Courir vers la Gare", next: 'c1_station' }
                ]
            },
            'c1_street': {
                text: "Vous êtes dans la rue. C'est oppressant. Des centaines de corps immobiles. Si vous courez, vous êtes repéré. Si vous marchez trop vite, vous êtes suspect.",
                theme: 'hive',
                choices: [
                    { text: "Marcher au rythme des Autres (Imitation)", next: 'c1_station', effect: () => { state.suspicion += 5; } },
                    { text: "Passer par les égouts (Sale mais sûr)", next: 'c1_sewers' }
                ]
            },
            'c1_street_hive': {
                text: "L'unité hoche la tête et sort. Vous la suivez dehors. Vous êtes infiltré au milieu d'eux. Le bourdonnement mental est insupportable.",
                theme: 'hive',
                choices: [
                    { text: "Profiter de la couverture pour aller à la Gare", next: 'c1_station' }
                ]
            },
            'c1_sewers': {
                text: "Les égouts sont calmes. Vous êtes seul avec vos pensées. Vous réalisez que vous avez gardé les souvenirs d'un ingénieur civil de la Ruche. Vous connaissez le chemin.",
                theme: 'solo',
                choices: [
                    { text: "Aller vers la Gare du Midi", next: 'c1_station_arrival' }
                ]
            },
            'c1_station': {
                text: "Gare du Midi. Des drones de Laxmi surveillent les entrées. Un train est à quai, moteur tournant. C'est le train pour le Sud.",
                theme: 'hive',
                choices: [
                    { text: "Forcer le barrage (Combat)", next: 'c1_end_combat' },
                    { text: "Utiliser un code d'accès volé (Mémoire Ruche)", next: 'c1_end_stealth' }
                ]
            },
            'c1_station_arrival': {
                 text: "Vous émergez directement sur le quai 4 via une trappe de maintenance. Le train est là.",
                 theme: 'solo',
                 choices: [
                     { text: "Monter dans le train", next: 'c2_start' }
                 ]
            },
            'c1_end_combat': {
                text: "Vous vous battez comme un lion. Vous êtes blessé, mais vous sautez dans le train qui démarre. Les drones tirent mais ratent.",
                theme: 'solo',
                choices: [
                    { text: "Terminer le Chapitre 1", next: 'c2_start' }
                ]
            },
            'c1_end_stealth': {
                text: "Vous tapez le code : 8841. Les portes s'ouvrent. 'Bienvenue, Unité Maintenance'. Vous montez calmement.",
                theme: 'solo',
                choices: [
                    { text: "Terminer le Chapitre 1", next: 'c2_start' }
                ]
            },
            'c1_fail_mimic': {
                text: "Votre silence vous trahit. L'unité hurle. D'autres arrivent. C'est la fin de votre brève liberté.",
                theme: 'hive',
                choices: [
                    { text: "RECOMMENCER", next: 'start', effect: () => resetGame() }
                ]
            },

            // --- DÉBUT CHAPITRE 2 (Squelette pour démo) ---
            'c2_start': {
                text: "CHAPITRE 2 : LA TRAVERSÉE. Le train file vers la France. Vous n'êtes pas seul à bord. Une voix résonne dans les haut-parleurs : '{name}, je sais que tu n'es plus connecté.' C'est Laxmi.",
                theme: 'hive',
                choices: [
                    { text: "Chercher le micro pour répondre", next: 'c2_seq1' },
                    { text: "Se barricader dans le wagon de queue", next: 'c2_seq1_b' }
                ]
            },
            'c2_seq1': {
                text: "[FIN DE LA DÉMO] Dans le jeu complet, vous affronteriez les dilemmes de Laxmi ici. Chapitre 3 en Espagne, Chapitre 4 au Bunker Final.",
                theme: 'solo',
                choices: [
                    { text: "Rejouer le Chapitre 1", next: 'start', effect: () => resetGame() }
                ]
            },
            'c2_seq1_b': {
                text: "[FIN DE LA DÉMO] Route alternative. Dans le jeu complet, cela mènerait à une fin furtive.",
                theme: 'solo',
                choices: [
                     { text: "Rejouer le Chapitre 1", next: 'start', effect: () => resetGame() }
                ]
            }
        };

        // --- LOGIQUE DU JEU ---

        function startGame() {
            const nameInput = document.getElementById('player-name').value;
            if (nameInput.trim() === "") {
                alert("Entrez un nom pour continuer.");
                return;
            }
            state.name = nameInput;
            
            document.getElementById('main-menu').style.display = 'none';
            document.getElementById('hud').style.display = 'flex';
            document.getElementById('game-area').style.display = 'block';

            loadSequence('start');
        }

        function resetGame() {
            state.suspicion = 0;
            state.inventory = [];
            state.chapter = 1;
            updateHUD();
        }

        function updateHUD() {
            document.getElementById('stats-display').innerText = `Soupçon: ${state.suspicion}% | Humanité: ${state.humanity}`;
            document.getElementById('chap-display').innerText = `CHAPITRE ${state.chapter}`;
            
            // Changement couleur HUD si soupçon élevé
            if(state.suspicion > 50) {
                document.getElementById('stats-display').style.color = "red";
            } else {
                document.getElementById('stats-display').style.color = "inherit";
            }
        }

        function loadSequence(sceneId) {
            const scene = scenes[sceneId];
            if (!scene) {
                console.error("Scène introuvable: " + sceneId);
                return;
            }

            // Mise à jour de l'affichage
            const textBox = document.getElementById('story-text');
            const choicesBox = document.getElementById('choices-container');
            const statusBar = document.getElementById('status-bar');

            // 1. Appliquer le thème
            setTheme(scene.theme);

            // 2. Afficher le texte (avec effet machine à écrire léger ou direct)
            const processedText = scene.text.replace(/{name}/g, state.name);
            textBox.innerHTML = processedText;

            // 3. Lire le texte
            speak(scene.text, scene.theme === 'hive' ? 'hive' : 'narrator');

            // 4. Générer les choix
            choicesBox.innerHTML = '';
            scene.choices.forEach(choice => {
                const btn = document.createElement('button');
                btn.innerText = `> ${choice.text}`;
                btn.onclick = () => {
                    // Appliquer les effets du choix
                    if (choice.effect) choice.effect();
                    
                    // Vérifier Game Over par soupçon
                    if (state.suspicion >= 100) {
                        loadSequence('c1_fail_mimic');
                        return;
                    }

                    // Mise à jour chapitre si transition
                    if (choice.next.startsWith('c2')) state.chapter = 2;
                    
                    updateHUD();
                    loadSequence(choice.next);
                };
                choicesBox.appendChild(btn);
            });

            // Status contextuel
            if (scene.theme === 'hive') {
                statusBar.innerText = "⚠️ PROXIMITÉ RUCHE DÉTECTÉE - RISQUE ÉLEVÉ";
            } else {
                statusBar.innerText = "● Signal Sécurisé - Vous êtes seul";
            }
        }

        // Initialisation voix au chargement
        loadVoices();

    </script>
</body>
</html>
